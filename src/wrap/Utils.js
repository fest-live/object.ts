import { hasValue, isPrimitive } from "fest/core";
import { $extractKey$, $originalKey$, $registryKey$ } from "./Symbol";
//
export const $originalObjects$ = new WeakMap();
//
export const safe = (target) => {
    const unwrap = (typeof target == "object" || typeof target == "function") ? (target?.[$extractKey$] ?? target) : target, mapped = (e) => safe(e);
    if (Array.isArray(unwrap)) {
        return unwrap?.map?.(mapped) || Array.from(unwrap || [])?.map?.(mapped) || [];
    }
    else // @ts-ignore
     if (unwrap instanceof Map || unwrap instanceof WeakMap) {
        return new Map(Array.from(unwrap?.entries?.() || [])?.map?.(([K, V]) => [K, safe(V)]));
    }
    else // @ts-ignore
     if (unwrap instanceof Set || unwrap instanceof WeakSet) {
        return new Set(Array.from(unwrap?.values?.() || [])?.map?.(mapped));
    }
    else // @ts-ignore
     if (unwrap != null && typeof unwrap == "function" || typeof unwrap == "object") {
        return Object.fromEntries(Array.from(Object.entries(unwrap || {}) || [])?.filter?.(([K]) => (K != $extractKey$ && K != $originalKey$ && K != $registryKey$))?.map?.(([K, V]) => [K, safe(V)]));
    }
    return unwrap;
};
//
export const unwrap = (arr) => { return arr?.[$extractKey$] ?? arr?.["@target"] ?? arr; };
export const deref = (target, discountValue = false) => {
    const original = target;
    if (isPrimitive(target) || typeof target == "symbol")
        return target;
    if (target != null && (target instanceof WeakRef || ("deref" in target && typeof target?.deref == "function"))) {
        target = target?.deref?.();
    }
    ;
    if (target != null && (typeof target == "object" || typeof target == "function")) {
        target = unwrap(target);
        const $val = discountValue && hasValue(target) && target?.value;
        if ($val != null && (typeof $val == "object" || typeof $val == "function")) {
            target = $val;
        }
        if (original != target) {
            return deref(target, discountValue);
        }
    }
    return target;
};
//
export const isThenable = (val) => val != null && typeof val.then === "function";
export const withPromise = (target, cb) => {
    if (isPrimitive(target) || typeof target == "function") {
        return cb?.(target);
    }
    ;
    if (isThenable(target))
        return target.then(cb);
    if (target?.promise && isThenable(target.promise))
        return target.promise.then(cb);
    return cb?.(target);
};
//
const disposeMap = new WeakMap();
const disposeRegistry = new FinalizationRegistry((callstack) => { callstack?.forEach?.((cb) => cb?.()); });
//
export function addToCallChain(obj, methodKey, callback) {
    if (!callback || typeof callback != "function" || (typeof obj != "object" && typeof obj != "function"))
        return;
    if (methodKey == Symbol.dispose) {
        // @ts-ignore
        disposeMap?.getOrInsertComputed?.(obj, () => {
            const CallChain = new Set();
            if (typeof obj == "object" || typeof obj == "function") {
                disposeRegistry.register(obj, CallChain);
                disposeMap.set(obj, CallChain);
                obj[Symbol.dispose] ??= () => CallChain.forEach((cb) => { cb?.(); });
            }
            return CallChain;
        })?.add?.(callback);
    }
    else {
        obj[methodKey] = function (...args) { const original = obj?.[methodKey]; if (typeof original == 'function') {
            original.apply(this, args);
        } ; callback.apply(this, args); };
    }
}
const isArrayIndex = (prop) => {
    if (typeof prop !== 'string')
        return false;
    if (prop === '')
        return false;
    const num = Number(prop);
    return Number.isInteger(num) && num >= 0 && String(num) === prop;
};
export function wrapSetAsArray(source = [], options = {}) {
    let backingSet = new Set();
    const notifyDuplicate = (value, via, index) => {
        options.onDuplicate?.({ value, via, index });
    };
    if (source instanceof Set) {
        backingSet = source;
    }
    else {
        for (const item of source) {
            if (backingSet.has(item)) {
                notifyDuplicate(item, 'push');
                continue;
            }
            backingSet.add(item);
        }
    }
    const snapshot = () => Array.from(backingSet);
    const rebuildFrom = (arr) => {
        backingSet.clear();
        for (const item of arr) {
            backingSet.add(item);
        }
    };
    const methods = {
        push: (...items) => {
            let size = backingSet.size;
            for (const item of items) {
                if (backingSet.has(item)) {
                    notifyDuplicate(item, 'push');
                    continue;
                }
                backingSet.add(item);
                size++;
            }
            return size;
        },
        pop: () => {
            const arr = snapshot();
            if (!arr.length)
                return undefined;
            const value = arr[arr.length - 1];
            backingSet.delete(value);
            return value;
        },
        shift: () => {
            const iterator = backingSet.values().next();
            if (iterator.done)
                return undefined;
            const value = iterator.value;
            backingSet.delete(value);
            return value;
        },
        unshift: (...items) => {
            if (!items.length)
                return backingSet.size;
            const current = snapshot();
            const toPrepend = [];
            for (const item of items) {
                if (current.includes(item) || toPrepend.includes(item)) {
                    notifyDuplicate(item, 'unshift', 0);
                    continue;
                }
                toPrepend.push(item);
            }
            if (!toPrepend.length)
                return current.length;
            const next = [...toPrepend, ...current];
            rebuildFrom(next);
            return next.length;
        },
        splice: (start, deleteCount, ...items) => {
            const arr = snapshot();
            const normalizedStart = Math.min(Math.max(start, 0), arr.length);
            const actualDeleteCount = deleteCount === undefined
                ? arr.length - normalizedStart
                : Math.max(0, Math.min(deleteCount, arr.length - normalizedStart));
            const removed = arr.splice(normalizedStart, actualDeleteCount);
            let insertPosition = normalizedStart;
            for (const item of items) {
                if (arr.includes(item)) {
                    notifyDuplicate(item, 'splice', insertPosition);
                    continue;
                }
                arr.splice(insertPosition++, 0, item);
            }
            rebuildFrom(arr);
            return removed;
        },
        includes: (value) => backingSet.has(value),
        indexOf: (value) => snapshot().indexOf(value),
        clear: () => {
            backingSet.clear();
        },
        delete: (value) => backingSet.delete(value),
        toArray: () => snapshot(),
        toSet: () => new Set(backingSet),
        [Symbol.iterator]: () => backingSet[Symbol.iterator](),
    };
    const handler = {
        get: (_, prop) => {
            if (prop === 'length') {
                return backingSet.size;
            }
            if (isArrayIndex(prop)) {
                const arr = snapshot();
                return arr[Number(prop)];
            }
            const value = methods[prop];
            if (typeof value === 'function') {
                return value;
            }
            return value;
        },
        set: (_, prop, value) => {
            if (prop === 'length') {
                if (typeof value !== 'number' || !Number.isFinite(value) || value < 0) {
                    throw new RangeError('length must be a finite non-negative number');
                }
                const nextLength = Math.floor(value);
                if (nextLength >= backingSet.size) {
                    // расширение с "дырами" не поддерживаем — просто игнорируем
                    return true;
                }
                const arr = snapshot().slice(0, nextLength);
                rebuildFrom(arr);
                return true;
            }
            if (isArrayIndex(prop)) {
                const arr = snapshot();
                const index = Number(prop);
                if (index > arr.length) {
                    return true; // не поддерживаем "редкие" индексы
                }
                const nextValue = value;
                if (index < arr.length) {
                    const currentValue = arr[index];
                    if (Object.is(currentValue, nextValue)) {
                        return true;
                    }
                    const duplicateElsewhere = arr.some((item, idx) => idx !== index && Object.is(item, nextValue));
                    if (duplicateElsewhere) {
                        notifyDuplicate(nextValue, 'set', index);
                        return true;
                    }
                    arr[index] = nextValue;
                }
                else {
                    if (arr.includes(nextValue)) {
                        notifyDuplicate(nextValue, 'set', index);
                        return true;
                    }
                    arr.push(nextValue);
                }
                rebuildFrom(arr);
                return true;
            }
            return Reflect.set(methods, prop, value);
        },
        deleteProperty: (_, prop) => {
            if (prop === 'length') {
                return false; // как у обычного массива
            }
            if (isArrayIndex(prop)) {
                const arr = snapshot();
                const index = Number(prop);
                if (index >= arr.length) {
                    return true;
                }
                arr.splice(index, 1);
                rebuildFrom(arr);
                return true;
            }
            return Reflect.deleteProperty(methods, prop);
        },
        ownKeys: () => {
            const keys = [];
            let i = 0;
            for (const _ of backingSet) {
                keys.push(String(i++));
            }
            keys.push('length');
            return keys;
        },
        getOwnPropertyDescriptor: (_, prop) => {
            if (prop === 'length') {
                return {
                    configurable: false,
                    enumerable: false,
                    writable: true,
                    value: backingSet.size,
                };
            }
            if (isArrayIndex(prop)) {
                const arr = snapshot();
                const index = Number(prop);
                if (index >= arr.length)
                    return undefined;
                return {
                    configurable: true,
                    enumerable: true,
                    writable: true,
                    value: arr[index],
                };
            }
            return Reflect.getOwnPropertyDescriptor(methods, prop);
        },
        has: (_, prop) => {
            if (prop === 'length')
                return true;
            if (isArrayIndex(prop)) {
                const index = Number(prop);
                return index >= 0 && index < backingSet.size;
            }
            return prop in methods;
        },
    };
    return new Proxy(methods, handler);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJVdGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNsRCxPQUFPLEVBQUUsWUFBWSxFQUFFLGFBQWEsRUFBRSxhQUFhLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFxRnRFLEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0FBRS9DLEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxJQUFJLEdBQUcsQ0FBQyxNQUFNLEVBQUMsRUFBRTtJQUMxQixNQUFNLE1BQU0sR0FBUSxDQUFDLE9BQU8sTUFBTSxJQUFJLFFBQVEsSUFBSSxPQUFPLE1BQU0sSUFBSSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLE1BQU0sR0FBRyxDQUFDLENBQUMsRUFBQyxFQUFFLENBQUEsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BKLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1FBQUMsT0FBTyxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQUMsQ0FBQztTQUFNLGFBQWE7S0FDaEksSUFBSSxNQUFNLFlBQVksR0FBRyxJQUFJLE1BQU0sWUFBWSxPQUFPLEVBQUUsQ0FBQztRQUFDLE9BQU8sSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQSxDQUFDLENBQUMsRUFBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFBQyxDQUFDO1NBQU8sYUFBYTtLQUNuSyxJQUFJLE1BQU0sWUFBWSxHQUFHLElBQUksTUFBTSxZQUFZLE9BQU8sRUFBRSxDQUFDO1FBQUMsT0FBTyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFBQyxDQUFDO1NBQU8sYUFBYTtLQUNwSixJQUFJLE1BQU0sSUFBSSxJQUFJLElBQUksT0FBTyxNQUFNLElBQUksVUFBVSxJQUFJLE9BQU8sTUFBTSxJQUFJLFFBQVEsRUFBRSxDQUFDO1FBQUMsT0FBTyxNQUFNLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQSxDQUFDLENBQUMsSUFBSSxZQUFZLElBQUksQ0FBQyxJQUFJLGFBQWEsSUFBSSxDQUFDLElBQUksYUFBYSxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQSxDQUFDLENBQUMsRUFBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFBQyxDQUFDO0lBQzdRLE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUMsQ0FBQTtBQUVELEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxNQUFNLEdBQUcsQ0FBQyxHQUFHLEVBQUMsRUFBRSxHQUFFLE9BQU8sR0FBRyxFQUFF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STtvQkFDaEIsUUFBUSxFQUFFLElBQUk7b0JBQ2QsS0FBSyxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUM7aUJBQ3BCLENBQUM7WUFDTixDQUFDO1lBRUQsT0FBTyxPQUFPLENBQUMsd0JBQXdCLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzNELENBQUM7UUFDRCxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUU7WUFDYixJQUFJLElBQUksS0FBSyxRQUFRO2dCQUFFLE9BQU8sSUFBSSxDQUFDO1lBQ25DLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7Z0JBQ3JCLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDM0IsT0FBTyxLQUFLLElBQUksQ0FBQyxJQUFJLEtBQUssR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDO1lBQ2pELENBQUM7WUFDRCxPQUFPLElBQUksSUFBSSxPQUFPLENBQUM7UUFDM0IsQ0FBQztLQUNKLENBQUM7SUFFRixPQUFPLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQWdCLENBQUM7QUFDdEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGhhc1ZhbHVlLCBpc1ByaW1pdGl2ZSB9IGZyb20gXCJmZXN0L2NvcmVcIjtcbmltcG9ydCB7ICRleHRyYWN0S2V5JCwgJG9yaWdpbmFsS2V5JCwgJHJlZ2lzdHJ5S2V5JCB9IGZyb20gXCIuL1N5bWJvbFwiO1xuXG4vKlxuLy9cbnR5cGUgQW55Rm4gPSAoLi4uYXJnczogYW55W10pID0+IGFueTtcbnR5cGUgTWV0aG9kS2V5czxUPiA9IHtcbiAgICBbSyBpbiBrZXlvZiBUXS0/OiBUW0tdIGV4dGVuZHMgQW55Rm4gPyBLIDogbmV2ZXJcbn1ba2V5b2YgVF07XG5cbi8vXG50eXBlIE1ldGhvZHNPZjxUPiA9IFBpY2s8VCwgTWV0aG9kS2V5czxUPj47XG50eXBlIFdpdGhNZXRob2RzPFVuZGVyLCBUPiA9IE1ldGhvZHNPZjxVbmRlcj4gJiBNZXRob2RzT2Y8VD47XG5cbi8vXG5leHBvcnQgdHlwZSBXZWFrS2V5ID0gb2JqZWN0O1xuZXhwb3J0IHR5cGUga2V5VHlwZSA9IHN0cmluZyB8IG51bWJlciB8IHN5bWJvbDtcblxuLy9cbmV4cG9ydCB0eXBlIHJlZlZhbGlkPFVuZGVyID0gYW55LCBUID0gYW55LCBLID0gYW55PiA9XG4gICAgfCAoVCAmIFdpdGhNZXRob2RzPFVuZGVyLCBUPilcbiAgICB8IChVbmRlcltdICYgV2l0aE1ldGhvZHM8VW5kZXIsIFQ+KVxuICAgIHwgKE1hcDxLLCBVbmRlcj4gJiBXaXRoTWV0aG9kczxVbmRlciwgVD4pXG4gICAgfCAoU2V0PGFueT4gJiBXaXRoTWV0aG9kczxVbmRlciwgVD4pXG4gICAgfCAoV2Vha01hcDwoSyBleHRlbmRzIFdlYWtLZXkgPyBLIDogbmV2ZXIpLCBVbmRlcj4gJiBXaXRoTWV0aG9kczxVbmRlciwgVD4pXG4gICAgfCAoV2Vha1NldDwoVW5kZXIgZXh0ZW5kcyBXZWFrS2V5ID8gVW5kZXIgOiBuZXZlcik+ICYgV2l0aE1ldGhvZHM8VW5kZXIsIFQ+KVxuICAgIHwgKEZ1bmN0aW9uICYgV2l0aE1ldGhvZHM8VW5kZXIsIFQ+KTtcblxuLy9cbmV4cG9ydCB0eXBlIHN1YlZhbGlkPFVuZGVyID0gYW55LCBUID0gYW55LCBLID0gYW55PiA9XG4gICAgfCByZWZWYWxpZDxVbmRlciwgVCwgSz5cbiAgICB8IChbcmVmVmFsaWQ8VW5kZXIsIFQsIEs+LCBrZXlUeXBlIHwgRnVuY3Rpb25dICYgV2l0aE1ldGhvZHM8VW5kZXIsIFQ+KVxuICAgIHwgKFtyZWZWYWxpZDxVbmRlciwgVCwgSz4sIGtleVR5cGUgfCBGdW5jdGlvbiwgLi4uYW55W11dICYgV2l0aE1ldGhvZHM8VW5kZXIsIFQ+KTtcbiovXG5cbi8vXG5leHBvcnQgdHlwZSBBbnlGbiA9ICguLi5hcmdzOiBhbnlbXSkgPT4gYW55O1xuZXhwb3J0IHR5cGUgTWV0aG9kS2V5czxUPiA9IHtcbiAgICBbSyBpbiBrZXlvZiBUXS0/OiBUW0tdIGV4dGVuZHMgQW55Rm4gPyBLIDogbmV2ZXJcbn1ba2V5b2YgVF07XG5leHBvcnQgdHlwZSBNZXRob2RzT2Y8VD4gPSBQaWNrPFQsIE1ldGhvZEtleXM8VD4+O1xuXG4vL1xuZXhwb3J0IHR5cGUgV2Vha0tleSA9IG9iamVjdCB8IEZ1bmN0aW9uO1xuZXhwb3J0IHR5cGUga2V5VHlwZSA9IHN0cmluZyB8IG51bWJlciB8IHN5bWJvbDtcblxuLy9cbmV4cG9ydCB0eXBlIENvbnRhaW5lck1ldGhvZHM8WD4gPVxuICAgIFggZXh0ZW5kcyAoYW55W10gfCBBcnJheTxhbnk+KSA/IE1ldGhvZHNPZjxBcnJheTxhbnk+PiA6XG4gICAgWCBleHRlbmRzIE1hcDxrZXlUeXBlLCBhbnk+ID8gTWV0aG9kc09mPE1hcDxrZXlUeXBlLCBhbnk+PiA6XG4gICAgWCBleHRlbmRzIFNldDxhbnk+ID8gTWV0aG9kc09mPFNldDxhbnk+PiA6XG4gICAgWCBleHRlbmRzIFdlYWtNYXA8V2Vha0tleSwgYW55PiA/IE1ldGhvZHNPZjxXZWFrTWFwPFdlYWtLZXksIGFueT4+IDpcbiAgICBYIGV4dGVuZHMgV2Vha1NldDxXZWFrS2V5PiA/IE1ldGhvZHNPZjxXZWFrU2V0PFdlYWtLZXk+PiA6XG4gICAgWCBleHRlbmRzIEZ1bmN0aW9uID8gTWV0aG9kc09mPEZ1bmN0aW9uPiA6XG4gICAge307XG5cbi8vIGV4dGVuZHMgYnkgW2tleTogc3ltYm9sXSBpbnRlcm5hbHMsIHN1Y2ggYXMgU3ltYm9sLm9ic2VydmFibGUsIFN5bWJvbC5kaXNwb3NlLCAkdHJpZ2dlciQsIGV0Yy4uLlxuZXhwb3J0IHR5cGUgb2JzZXJ2ZVNwZWNpZmljS2V5czxUIGV4dGVuZHMgUmVjb3JkPGtleVR5cGUsIGFueT4gPSBhbnk+ID0gVCAmIHtcbiAgICBbSyBpbiBrZXlvZiBUXTogVFtLXSBleHRlbmRzIEFueVN1aXRhYmxlPGtleVR5cGUsIGFueT4gPyBVaTxUW0tdLCBrZXlUeXBlLCBhbnk+IDogVFtLXTtcbn1ba2V5b2YgVCAmIGtleVR5cGVdO1xuXG4vL1xuZXhwb3J0IHR5cGUgTWFwTGlrZTxLID0gYW55LCBWID0gYW55PiA9IE1hcDxLLCBWPiB8IFdlYWtNYXA8SyBleHRlbmRzIFdlYWtLZXkgPyBLIDogbmV2ZXIsIFY+IHwgUmVjb3JkPEsgZXh0ZW5kcyBrZXlUeXBlID8gSyA6IG5ldmVyLCBWPjtcbmV4cG9ydCB0eXBlIFNldExpa2U8ViA9IGFueSwgXyA9IHVua25vd24+ID0gU2V0PFY+IHwgV2Vha1NldDxWIGV4dGVuZHMgV2Vha0tleSA/IFYgOiBuZXZlcj4gfCBWW107XG5leHBvcnQgdHlwZSBBbnlTdWl0YWJsZTxLID0gYW55LCBWID0gYW55fHVua25vd24+ID0gRnVuY3Rpb24gfCBSZWNvcmQ8SyBleHRlbmRzIGtleVR5cGUgPyBLIDogbmV2ZXIsIFY+IHwgTWFwTGlrZTxLLCBWPiB8IFNldExpa2U8SywgViBleHRlbmRzIHVua25vd24gPyBWIDogdW5rbm93bj47XG5leHBvcnQgdHlwZSBVaTxXIGV4dGVuZHMgQW55U3VpdGFibGU8YW55LCBhbnk+LCBLID0gYW55LCBWID0gYW55PiA9IFcgfCBXW10gfCBBbnlTdWl0YWJsZTxLLCBWPiB8IEFueVN1aXRhYmxlPEssIFY+W107XG5leHBvcnQgdHlwZSBvYnNlcnZlVmFsaWQ8VCA9IGFueT4gPSBUICYge1xuICAgIHZhbHVlPzogYW55O1xuICAgIFtrZXk6IHN5bWJvbF06IGFueTtcbiAgICBba2V5OiBzdHJpbmddOiBhbnk7XG59O1xuXG4vL1xuZXhwb3J0IHR5cGUgVHVwbGVXaXRoSW5oZXJpdGVkTWV0aG9kczxSVj4gPVxuICAgIFJWIGV4dGVuZHMgdW5rbm93biA/IChbUlYsIGtleVR5cGUgfCBGdW5jdGlvbl0gJiBDb250YWluZXJNZXRob2RzPFJWPikgOiBuZXZlcjtcblxuLy9cbmV4cG9ydCB0eXBlIFR1cGxlVmFyaWFkaWNXaXRoSW5oZXJpdGVkTWV0aG9kczxSVj4gPVxuICAgIFJWIGV4dGVuZHMgdW5rbm93biA/IChbUlYsIGtleVR5cGUgfCBGdW5jdGlvbiwgLi4uYW55W11dICYgQ29udGFpbmVyTWV0aG9kczxSVj4pIDogbmV2ZXI7XG5cbi8vXG5leHBvcnQgdHlwZSBzdWJWYWxpZDxUID0gYW55PiA9XG4gICAgfCBvYnNlcnZlVmFsaWQ8VD5cbiAgICB8IFR1cGxlV2l0aEluaGVyaXRlZE1ldGhvZHM8b2JzZXJ2ZVZhbGlkPFQ+PlxuICAgIHwgVHVwbGVWYXJpYWRpY1dpdGhJbmhlcml0ZWRNZXRob2RzPG9ic2VydmVWYWxpZDxUPj47XG5cbi8vXG5leHBvcnQgY29uc3QgJG9yaWdpbmFsT2JqZWN0cyQgPSBuZXcgV2Vha01hcCgpO1xuXG4vL1xuZXhwb3J0IGNvbnN0IHNhZmUgPSAodGFyZ2V0KT0+e1xuICAgIGNvbnN0IHVud3JhcDogYW55ID0gKHR5cGVvZiB0YXJnZXQgPT0gXCJvYmplY3RcIiB8fCB0eXBlb2YgdGFyZ2V0ID09IFwiZnVuY3Rpb25cIikgPyAodGFyZ2V0Py5bJGV4dHJhY3RLZXkkXSA/PyB0YXJnZXQpIDogdGFyZ2V0LCBtYXBwZWQgPSAoZSk9PnNhZmUoZSk7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkodW53cmFwKSkgeyByZXR1cm4gdW53cmFwPy5tYXA/LihtYXBwZWQpIHx8IEFycmF5LmZyb20odW53cmFwIHx8IFtdKT8ubWFwPy4obWFwcGVkKSB8fCBbXTsgfSBlbHNlIC8vIEB0cy1pZ25vcmVcbiAgICBpZiAodW53cmFwIGluc3RhbmNlb2YgTWFwIHx8IHVud3JhcCBpbnN0YW5jZW9mIFdlYWtNYXApIHsgcmV0dXJuIG5ldyBNYXAoQXJyYXkuZnJvbSh1bndyYXA/LmVudHJpZXM/LigpIHx8IFtdKT8ubWFwPy4oKFtLLFZdKT0+W0ssc2FmZShWKV0pKTsgfSBlbHNlICAvLyBAdHMtaWdub3JlXG4gICAgaWYgKHVud3JhcCBpbnN0YW5jZW9mIFNldCB8fCB1bndyYXAgaW5zdGFuY2VvZiBXZWFrU2V0KSB7IHJldHVybiBuZXcgU2V0KEFycmF5LmZyb20odW53cmFwPy52YWx1ZXM/LigpIHx8IFtdKT8ubWFwPy4obWFwcGVkKSk7IH0gZWxzZSAgLy8gQHRzLWlnbm9yZVxuICAgIGlmICh1bndyYXAgIT0gbnVsbCAmJiB0eXBlb2YgdW53cmFwID09IFwiZnVuY3Rpb25cIiB8fCB0eXBlb2YgdW53cmFwID09IFwib2JqZWN0XCIpIHsgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyhBcnJheS5mcm9tKE9iamVjdC5lbnRyaWVzKHVud3JhcCB8fCB7fSkgfHwgW10pPy5maWx0ZXI/LigoW0tdKT0+KEsgIT0gJGV4dHJhY3RLZXkkICYmIEsgIT0gJG9yaWdpbmFsS2V5JCAmJiBLICE9ICRyZWdpc3RyeUtleSQpKT8ubWFwPy4oKFtLLFZdKT0+W0ssc2FmZShWKV0pKTsgfVxuICAgIHJldHVybiB1bndyYXA7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgdW53cmFwID0gKGFycik9PnsgcmV0dXJuIGFycj8uWyRleHRyYWN0S2V5JF0gPz8gYXJyPy5bXCJAdGFyZ2V0XCJdID8/IGFycjsgfVxuZXhwb3J0IGNvbnN0IGRlcmVmICA9ICh0YXJnZXQ/OiBhbnksIGRpc2NvdW50VmFsdWU6IGJvb2xlYW58bnVsbCA9IGZhbHNlKT0+e1xuICAgIGNvbnN0IG9yaWdpbmFsID0gdGFyZ2V0O1xuICAgIGlmIChpc1ByaW1pdGl2ZSh0YXJnZXQpIHx8IHR5cGVvZiB0YXJnZXQgPT0gXCJzeW1ib2xcIikgcmV0dXJuIHRhcmdldDtcbiAgICBpZiAodGFyZ2V0ICE9IG51bGwgJiYgKHRhcmdldCBpbnN0YW5jZW9mIFdlYWtSZWYgfHwgKFwiZGVyZWZcIiBpbiB0YXJnZXQgJiYgdHlwZW9mIHRhcmdldD8uZGVyZWYgPT0gXCJmdW5jdGlvblwiKSkpIHsgdGFyZ2V0ID0gdGFyZ2V0Py5kZXJlZj8uKCk7IH07XG4gICAgaWYgKHRhcmdldCAhPSBudWxsICYmICh0eXBlb2YgdGFyZ2V0ID09IFwib2JqZWN0XCIgfHwgdHlwZW9mIHRhcmdldCA9PSBcImZ1bmN0aW9uXCIpKSB7XG4gICAgICAgIHRhcmdldCA9IHVud3JhcCh0YXJnZXQpO1xuICAgICAgICBjb25zdCAkdmFsID0gZGlzY291bnRWYWx1ZSAmJiBoYXNWYWx1ZSh0YXJnZXQpICYmIHRhcmdldD8udmFsdWU7XG4gICAgICAgIGlmICgkdmFsICE9IG51bGwgJiYgKHR5cGVvZiAkdmFsID09IFwib2JqZWN0XCIgfHwgdHlwZW9mICR2YWwgPT0gXCJmdW5jdGlvblwiKSlcbiAgICAgICAgICAgIHsgdGFyZ2V0ID0gJHZhbDsgfVxuICAgICAgICBpZiAob3JpZ2luYWwgIT0gdGFyZ2V0KVxuICAgICAgICAgICAgeyByZXR1cm4gZGVyZWYodGFyZ2V0LCBkaXNjb3VudFZhbHVlKTsgfVxuICAgIH1cbiAgICByZXR1cm4gdGFyZ2V0O1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGlzVGhlbmFibGUgPSAodmFsOiBhbnkpOiB2YWwgaXMgUHJvbWlzZUxpa2U8YW55PiA9PiB2YWwgIT0gbnVsbCAmJiB0eXBlb2YgdmFsLnRoZW4gPT09IFwiZnVuY3Rpb25cIjtcbmV4cG9ydCBjb25zdCB3aXRoUHJvbWlzZSA9ICh0YXJnZXQsIGNiKSA9PiB7XG4gICAgaWYgKGlzUHJpbWl0aXZlKHRhcmdldCkgfHwgdHlwZW9mIHRhcmdldCA9PSBcImZ1bmN0aW9uXCIpIHsgcmV0dXJuIGNiPy4odGFyZ2V0KTsgfTtcbiAgICBpZiAoaXNUaGVuYWJsZSh0YXJnZXQpKSByZXR1cm4gdGFyZ2V0LnRoZW4oY2IpO1xuICAgIGlmICh0YXJnZXQ/LnByb21pc2UgJiYgaXNUaGVuYWJsZSh0YXJnZXQucHJvbWlzZSkpIHJldHVybiB0YXJnZXQucHJvbWlzZS50aGVuKGNiKTtcbiAgICByZXR1cm4gY2I/Lih0YXJnZXQpO1xufVxuXG4vL1xuY29uc3QgZGlzcG9zZU1hcCA9IG5ldyBXZWFrTWFwKCk7XG5jb25zdCBkaXNwb3NlUmVnaXN0cnkgPSBuZXcgRmluYWxpemF0aW9uUmVnaXN0cnkoKGNhbGxzdGFjazogYW55KT0+eyBjYWxsc3RhY2s/LmZvckVhY2g/LigoY2I6IGFueSk9PmNiPy4oKSk7IH0pO1xuXG4vL1xuZXhwb3J0IGZ1bmN0aW9uIGFkZFRvQ2FsbENoYWluKG9iaiwgbWV0aG9kS2V5LCBjYWxsYmFjaz86IGFueXxudWxsKSB7XG4gICAgaWYgKCFjYWxsYmFjayB8fCB0eXBlb2YgY2FsbGJhY2sgIT0gXCJmdW5jdGlvblwiIHx8ICh0eXBlb2Ygb2JqICE9IFwib2JqZWN0XCIgJiYgdHlwZW9mIG9iaiAhPSBcImZ1bmN0aW9uXCIpKSByZXR1cm47XG4gICAgaWYgKG1ldGhvZEtleSA9PSBTeW1ib2wuZGlzcG9zZSkge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGRpc3Bvc2VNYXA/LmdldE9ySW5zZXJ0Q29tcHV0ZWQ/LihvYmosICgpPT57XG4gICAgICAgICAgICBjb25zdCBDYWxsQ2hhaW4gPSBuZXcgU2V0KCk7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG9iaiA9PSBcIm9iamVjdFwiIHx8IHR5cGVvZiBvYmogPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgZGlzcG9zZVJlZ2lzdHJ5LnJlZ2lzdGVyKG9iaiwgQ2FsbENoYWluKTtcbiAgICAgICAgICAgICAgICBkaXNwb3NlTWFwLnNldChvYmosIENhbGxDaGFpbik7XG4gICAgICAgICAgICAgICAgb2JqW1N5bWJvbC5kaXNwb3NlXSA/Pz0gKCk9PkNhbGxDaGFpbi5mb3JFYWNoKChjYjogYW55KT0+eyBjYj8uKCk7IH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIENhbGxDaGFpbjtcbiAgICAgICAgfSk/LmFkZD8uKGNhbGxiYWNrKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBvYmpbbWV0aG9kS2V5XSA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHsgY29uc3Qgb3JpZ2luYWwgPSBvYmo/LlttZXRob2RLZXldOyBpZiAodHlwZW9mIG9yaWdpbmFsID09ICdmdW5jdGlvbicpIHsgb3JpZ2luYWwuYXBwbHkodGhpcywgYXJncyk7IH07IGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOyB9O1xuICAgIH1cbn1cblxuXG50eXBlIER1cGxpY2F0ZUNvbnRleHQgPSAnc2V0JyB8ICdwdXNoJyB8ICd1bnNoaWZ0JyB8ICdzcGxpY2UnO1xuXG5pbnRlcmZhY2UgRHVwbGljYXRlRXZlbnQ8VD4ge1xuICAgIHZhbHVlOiBUO1xuICAgIHZpYTogRHVwbGljYXRlQ29udGV4dDtcbiAgICBpbmRleD86IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIFNldEFycmF5T3B0aW9uczxUPiB7XG4gICAgb25EdXBsaWNhdGU/OiAoZXZlbnQ6IER1cGxpY2F0ZUV2ZW50PFQ+KSA9PiB2b2lkO1xufVxuXG5pbnRlcmZhY2UgU2V0QXJyYXlNZXRob2RzPFQ+IHtcbiAgICBwdXNoKC4uLml0ZW1zOiBUW10pOiBudW1iZXI7XG4gICAgcG9wKCk6IFQgfCB1bmRlZmluZWQ7XG4gICAgc2hpZnQoKTogVCB8IHVuZGVmaW5lZDtcbiAgICB1bnNoaWZ0KC4uLml0ZW1zOiBUW10pOiBudW1iZXI7XG4gICAgc3BsaWNlKHN0YXJ0OiBudW1iZXIsIGRlbGV0ZUNvdW50PzogbnVtYmVyLCAuLi5pdGVtczogVFtdKTogVFtdO1xuICAgIGluY2x1ZGVzKHZhbHVlOiBUKTogYm9vbGVhbjtcbiAgICBpbmRleE9mKHZhbHVlOiBUKTogbnVtYmVyO1xuICAgIHRvQXJyYXkoKTogVFtdO1xuICAgIHRvU2V0KCk6IFNldDxUPjtcbiAgICBjbGVhcigpOiB2b2lkO1xuICAgIGRlbGV0ZSh2YWx1ZTogVCk6IGJvb2xlYW47XG4gICAgW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmFibGVJdGVyYXRvcjxUPjtcbn1cblxuZXhwb3J0IHR5cGUgU2V0QXJyYXk8VD4gPSBTZXRBcnJheU1ldGhvZHM8VD4gJiB7XG4gICAgcmVhZG9ubHkgbGVuZ3RoOiBudW1iZXI7XG4gICAgW2luZGV4OiBudW1iZXJdOiBUO1xufTtcblxuY29uc3QgaXNBcnJheUluZGV4ID0gKHByb3A6IFByb3BlcnR5S2V5KTogcHJvcCBpcyBgJHtudW1iZXJ9YCA9PiB7XG4gICAgaWYgKHR5cGVvZiBwcm9wICE9PSAnc3RyaW5nJykgcmV0dXJuIGZhbHNlO1xuICAgIGlmIChwcm9wID09PSAnJykgcmV0dXJuIGZhbHNlO1xuICAgIGNvbnN0IG51bSA9IE51bWJlcihwcm9wKTtcbiAgICByZXR1cm4gTnVtYmVyLmlzSW50ZWdlcihudW0pICYmIG51bSA+PSAwICYmIFN0cmluZyhudW0pID09PSBwcm9wO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHdyYXBTZXRBc0FycmF5PFQ+KFxuICAgIHNvdXJjZTogSXRlcmFibGU8VD4gPSBbXSxcbiAgICBvcHRpb25zOiBTZXRBcnJheU9wdGlvbnM8VD4gPSB7fVxuKTogU2V0QXJyYXk8VD4ge1xuICAgIGxldCBiYWNraW5nU2V0OiBTZXQ8VD4gPSBuZXcgU2V0PFQ+KCk7XG5cbiAgICBjb25zdCBub3RpZnlEdXBsaWNhdGUgPSAodmFsdWU6IFQsIHZpYTogRHVwbGljYXRlQ29udGV4dCwgaW5kZXg/OiBudW1iZXIpID0+IHtcbiAgICAgICAgb3B0aW9ucy5vbkR1cGxpY2F0ZT8uKHsgdmFsdWUsIHZpYSwgaW5kZXggfSk7XG4gICAgfTtcblxuICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBTZXQpIHsgYmFja2luZ1NldCA9IHNvdXJjZTsgfSBlbHNlIHtcbiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHNvdXJjZSkge1xuICAgICAgICAgICAgaWYgKGJhY2tpbmdTZXQuaGFzKGl0ZW0pKSB7XG4gICAgICAgICAgICAgICAgbm90aWZ5RHVwbGljYXRlKGl0ZW0sICdwdXNoJyk7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBiYWNraW5nU2V0LmFkZChpdGVtKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHNuYXBzaG90ID0gKCkgPT4gQXJyYXkuZnJvbShiYWNraW5nU2V0KTtcbiAgICBjb25zdCByZWJ1aWxkRnJvbSA9IChhcnI6IFRbXSkgPT4ge1xuICAgICAgICBiYWNraW5nU2V0LmNsZWFyKCk7XG4gICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBhcnIpIHtcbiAgICAgICAgICAgIGJhY2tpbmdTZXQuYWRkKGl0ZW0pO1xuICAgICAgICB9XG4gICAgfTtcblxuXG5cbiAgICBjb25zdCBtZXRob2RzOiBTZXRBcnJheU1ldGhvZHM8VD4gPSB7XG4gICAgICAgIHB1c2g6ICguLi5pdGVtczogVFtdKSA9PiB7XG4gICAgICAgICAgICBsZXQgc2l6ZSA9IGJhY2tpbmdTZXQuc2l6ZTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcykge1xuICAgICAgICAgICAgICAgIGlmIChiYWNraW5nU2V0LmhhcyhpdGVtKSkge1xuICAgICAgICAgICAgICAgICAgICBub3RpZnlEdXBsaWNhdGUoaXRlbSwgJ3B1c2gnKTtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJhY2tpbmdTZXQuYWRkKGl0ZW0pO1xuICAgICAgICAgICAgICAgIHNpemUrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBzaXplO1xuICAgICAgICB9LFxuICAgICAgICBwb3A6ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGFyciA9IHNuYXBzaG90KCk7XG4gICAgICAgICAgICBpZiAoIWFyci5sZW5ndGgpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGFyclthcnIubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICBiYWNraW5nU2V0LmRlbGV0ZSh2YWx1ZSk7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICAgIH0sXG4gICAgICAgIHNoaWZ0OiAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpdGVyYXRvciA9IGJhY2tpbmdTZXQudmFsdWVzKCkubmV4dCgpO1xuICAgICAgICAgICAgaWYgKGl0ZXJhdG9yLmRvbmUpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGl0ZXJhdG9yLnZhbHVlO1xuICAgICAgICAgICAgYmFja2luZ1NldC5kZWxldGUodmFsdWUpO1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9LFxuICAgICAgICB1bnNoaWZ0OiAoLi4uaXRlbXM6IFRbXSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFpdGVtcy5sZW5ndGgpIHJldHVybiBiYWNraW5nU2V0LnNpemU7XG4gICAgICAgICAgICBjb25zdCBjdXJyZW50ID0gc25hcHNob3QoKTtcbiAgICAgICAgICAgIGNvbnN0IHRvUHJlcGVuZDogVFtdID0gW107XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcykge1xuICAgICAgICAgICAgICAgIGlmIChjdXJyZW50LmluY2x1ZGVzKGl0ZW0pIHx8IHRvUHJlcGVuZC5pbmNsdWRlcyhpdGVtKSkge1xuICAgICAgICAgICAgICAgICAgICBub3RpZnlEdXBsaWNhdGUoaXRlbSwgJ3Vuc2hpZnQnLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRvUHJlcGVuZC5wdXNoKGl0ZW0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIXRvUHJlcGVuZC5sZW5ndGgpIHJldHVybiBjdXJyZW50Lmxlbmd0aDtcblxuICAgICAgICAgICAgY29uc3QgbmV4dCA9IFsuLi50b1ByZXBlbmQsIC4uLmN1cnJlbnRdO1xuICAgICAgICAgICAgcmVidWlsZEZyb20obmV4dCk7XG4gICAgICAgICAgICByZXR1cm4gbmV4dC5sZW5ndGg7XG4gICAgICAgIH0sXG4gICAgICAgIHNwbGljZTogKHN0YXJ0OiBudW1iZXIsIGRlbGV0ZUNvdW50PzogbnVtYmVyLCAuLi5pdGVtczogVFtdKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBhcnIgPSBzbmFwc2hvdCgpO1xuICAgICAgICAgICAgY29uc3Qgbm9ybWFsaXplZFN0YXJ0ID0gTWF0aC5taW4oTWF0aC5tYXgoc3RhcnQsIDApLCBhcnIubGVuZ3RoKTtcbiAgICAgICAgICAgIGNvbnN0IGFjdHVhbERlbGV0ZUNvdW50ID1cbiAgICAgICAgICAgICAgICBkZWxldGVDb3VudCA9PT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgICAgID8gYXJyLmxlbmd0aCAtIG5vcm1hbGl6ZWRTdGFydFxuICAgICAgICAgICAgICAgICAgICA6IE1hdGgubWF4KDAsIE1hdGgubWluKGRlbGV0ZUNvdW50LCBhcnIubGVuZ3RoIC0gbm9ybWFsaXplZFN0YXJ0KSk7XG5cbiAgICAgICAgICAgIGNvbnN0IHJlbW92ZWQgPSBhcnIuc3BsaWNlKG5vcm1hbGl6ZWRTdGFydCwgYWN0dWFsRGVsZXRlQ291bnQpO1xuXG4gICAgICAgICAgICBsZXQgaW5zZXJ0UG9zaXRpb24gPSBub3JtYWxpemVkU3RhcnQ7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlbXMpIHtcbiAgICAgICAgICAgICAgICBpZiAoYXJyLmluY2x1ZGVzKGl0ZW0pKSB7XG4gICAgICAgICAgICAgICAgICAgIG5vdGlmeUR1cGxpY2F0ZShpdGVtLCAnc3BsaWNlJywgaW5zZXJ0UG9zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYXJyLnNwbGljZShpbnNlcnRQb3NpdGlvbisrLCAwLCBpdGVtKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmVidWlsZEZyb20oYXJyKTtcbiAgICAgICAgICAgIHJldHVybiByZW1vdmVkO1xuICAgICAgICB9LFxuICAgICAgICBpbmNsdWRlczogKHZhbHVlOiBUKSA9PiBiYWNraW5nU2V0Lmhhcyh2YWx1ZSksXG4gICAgICAgIGluZGV4T2Y6ICh2YWx1ZTogVCkgPT4gc25hcHNob3QoKS5pbmRleE9mKHZhbHVlKSxcbiAgICAgICAgY2xlYXI6ICgpID0+IHtcbiAgICAgICAgICAgIGJhY2tpbmdTZXQuY2xlYXIoKTtcbiAgICAgICAgfSxcbiAgICAgICAgZGVsZXRlOiAodmFsdWU6IFQpID0+IGJhY2tpbmdTZXQuZGVsZXRlKHZhbHVlKSxcbiAgICAgICAgdG9BcnJheTogKCkgPT4gc25hcHNob3QoKSxcbiAgICAgICAgdG9TZXQ6ICgpID0+IG5ldyBTZXQoYmFja2luZ1NldCksXG4gICAgICAgIFtTeW1ib2wuaXRlcmF0b3JdOiAoKSA9PiBiYWNraW5nU2V0W1N5bWJvbC5pdGVyYXRvcl0oKSxcbiAgICB9O1xuXG4gICAgY29uc3QgaGFuZGxlcjogUHJveHlIYW5kbGVyPFNldEFycmF5TWV0aG9kczxUPj4gPSB7XG4gICAgICAgIGdldDogKF8sIHByb3ApID0+IHtcbiAgICAgICAgICAgIGlmIChwcm9wID09PSAnbGVuZ3RoJykge1xuICAgICAgICAgICAgICAgIHJldHVybiBiYWNraW5nU2V0LnNpemU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpc0FycmF5SW5kZXgocHJvcCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhcnIgPSBzbmFwc2hvdCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBhcnJbTnVtYmVyKHByb3ApXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSAobWV0aG9kcyBhcyB1bmtub3duIGFzIFJlY29yZDxQcm9wZXJ0eUtleSwgdW5rbm93bj4pW3Byb3BdO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgfSxcbiAgICAgICAgc2V0OiAoXywgcHJvcCwgdmFsdWUpID0+IHtcbiAgICAgICAgICAgIGlmIChwcm9wID09PSAnbGVuZ3RoJykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdudW1iZXInIHx8ICFOdW1iZXIuaXNGaW5pdGUodmFsdWUpIHx8IHZhbHVlIDwgMCkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignbGVuZ3RoIG11c3QgYmUgYSBmaW5pdGUgbm9uLW5lZ2F0aXZlIG51bWJlcicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBuZXh0TGVuZ3RoID0gTWF0aC5mbG9vcih2YWx1ZSk7XG4gICAgICAgICAgICAgICAgaWYgKG5leHRMZW5ndGggPj0gYmFja2luZ1NldC5zaXplKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vINGA0LDRgdGI0LjRgNC10L3QuNC1INGBIFwi0LTRi9GA0LDQvNC4XCIg0L3QtSDQv9C+0LTQtNC10YDQttC40LLQsNC10Lwg4oCUINC/0YDQvtGB0YLQviDQuNCz0L3QvtGA0LjRgNGD0LXQvFxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgYXJyID0gc25hcHNob3QoKS5zbGljZSgwLCBuZXh0TGVuZ3RoKTtcbiAgICAgICAgICAgICAgICByZWJ1aWxkRnJvbShhcnIpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaXNBcnJheUluZGV4KHByb3ApKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYXJyID0gc25hcHNob3QoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IE51bWJlcihwcm9wKTtcblxuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IGFyci5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vINC90LUg0L/QvtC00LTQtdGA0LbQuNCy0LDQtdC8IFwi0YDQtdC00LrQuNC1XCIg0LjQvdC00LXQutGB0YtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBuZXh0VmFsdWUgPSB2YWx1ZSBhcyBUO1xuICAgICAgICAgICAgICAgIGlmIChpbmRleCA8IGFyci5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbHVlID0gYXJyW2luZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5pcyhjdXJyZW50VmFsdWUsIG5leHRWYWx1ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGR1cGxpY2F0ZUVsc2V3aGVyZSA9IGFyci5zb21lKFxuICAgICAgICAgICAgICAgICAgICAgICAgKGl0ZW0sIGlkeCkgPT4gaWR4ICE9PSBpbmRleCAmJiBPYmplY3QuaXMoaXRlbSwgbmV4dFZhbHVlKVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZHVwbGljYXRlRWxzZXdoZXJlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBub3RpZnlEdXBsaWNhdGUobmV4dFZhbHVlLCAnc2V0JywgaW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYXJyW2luZGV4XSA9IG5leHRWYWx1ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXJyLmluY2x1ZGVzKG5leHRWYWx1ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vdGlmeUR1cGxpY2F0ZShuZXh0VmFsdWUsICdzZXQnLCBpbmRleCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBhcnIucHVzaChuZXh0VmFsdWUpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJlYnVpbGRGcm9tKGFycik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBSZWZsZWN0LnNldChtZXRob2RzLCBwcm9wLCB2YWx1ZSk7XG4gICAgICAgIH0sXG4gICAgICAgIGRlbGV0ZVByb3BlcnR5OiAoXywgcHJvcCkgPT4ge1xuICAgICAgICAgICAgaWYgKHByb3AgPT09ICdsZW5ndGgnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyDQutCw0Log0YMg0L7QsdGL0YfQvdC+0LPQviDQvNCw0YHRgdC40LLQsFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoaXNBcnJheUluZGV4KHByb3ApKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYXJyID0gc25hcHNob3QoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IE51bWJlcihwcm9wKTtcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gYXJyLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYXJyLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgcmVidWlsZEZyb20oYXJyKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIFJlZmxlY3QuZGVsZXRlUHJvcGVydHkobWV0aG9kcywgcHJvcCk7XG4gICAgICAgIH0sXG4gICAgICAgIG93bktleXM6ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGtleXM6IChzdHJpbmcgfCBzeW1ib2wpW10gPSBbXTtcbiAgICAgICAgICAgIGxldCBpID0gMDtcbiAgICAgICAgICAgIGZvciAoY29uc3QgXyBvZiBiYWNraW5nU2V0KSB7XG4gICAgICAgICAgICAgICAga2V5cy5wdXNoKFN0cmluZyhpKyspKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGtleXMucHVzaCgnbGVuZ3RoJyk7XG4gICAgICAgICAgICByZXR1cm4ga2V5cztcbiAgICAgICAgfSxcbiAgICAgICAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOiAoXywgcHJvcCkgPT4ge1xuICAgICAgICAgICAgaWYgKHByb3AgPT09ICdsZW5ndGgnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogYmFja2luZ1NldC5zaXplLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpc0FycmF5SW5kZXgocHJvcCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBhcnIgPSBzbmFwc2hvdCgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gTnVtYmVyKHByb3ApO1xuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+PSBhcnIubGVuZ3RoKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBhcnJbaW5kZXhdLFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBSZWZsZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihtZXRob2RzLCBwcm9wKTtcbiAgICAgICAgfSxcbiAgICAgICAgaGFzOiAoXywgcHJvcCkgPT4ge1xuICAgICAgICAgICAgaWYgKHByb3AgPT09ICdsZW5ndGgnKSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIGlmIChpc0FycmF5SW5kZXgocHJvcCkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IE51bWJlcihwcm9wKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gaW5kZXggPj0gMCAmJiBpbmRleCA8IGJhY2tpbmdTZXQuc2l6ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcm9wIGluIG1ldGhvZHM7XG4gICAgICAgIH0sXG4gICAgfTtcblxuICAgIHJldHVybiBuZXcgUHJveHkobWV0aG9kcywgaGFuZGxlcikgYXMgU2V0QXJyYXk8VD47XG59XG4iXX0=
import { $extractKey$ } from "../wrap/Symbol";
import { deref } from "../wrap/Utils";
//
const withUnsub = new WeakMap();
const completeWithUnsub = (subscriber, weak, handler) => {
    // @ts-ignore
    return withUnsub.getOrInsert(subscriber, () => {
        const registry = weak?.deref?.();
        registry?.affected?.(handler);
        const savComplete = subscriber?.complete?.bind?.(subscriber);
        const unaffected = () => { const r = savComplete?.(); registry?.unaffected?.(handler); return r; };
        subscriber.complete = unaffected;
        return {
            unaffected,
            [Symbol.dispose]: unaffected,
            [Symbol.asyncDispose]: unaffected,
        };
    });
};
//
export const subscriptRegistry = new WeakMap();
// @ts-ignore
const wrapped = new WeakMap();
//
export const register = (what, handle) => {
    const unwrap = what?.[$extractKey$] ?? what; // @ts-ignore
    subscriptRegistry.getOrInsert(unwrap, new Subscript());
    return handle;
};
//
export const wrapWith = (what, handle) => {
    what = deref(what?.[$extractKey$] ?? what);
    if (typeof what == "symbol" || !(typeof what == "object" || typeof what == "function") || what == null)
        return what; // @ts-ignore
    return wrapped.getOrInsertComputed(what, () => new Proxy(what, register(what, handle)));
}; // !experimental `getOrInsert` feature!
//
const forAll = Symbol.for("@allProps");
//
export class Subscript {
    compatible;
    #listeners;
    #flags = new WeakSet();
    #native;
    #iterator;
    #inDispatch = new Set();
    // было: #triggerLock = new Set<keyType>();
    #pending = new Map();
    #pendingByProp = new Map();
    #flushScheduled = false;
    // last run timestamp per callback
    #lastPerfNow = new WeakMap();
    // получаем "now" максимально дёшево/безопасно
    #now() {
        // performance может отсутствовать в некоторых рантаймах
        return (globalThis.performance?.now?.() ?? Date.now());
    }
    constructor() {
        this.#listeners = new Map();
        this.#flags = new WeakSet();
        this.#iterator = {
            next: (args) => {
                if (args) {
                    Array.isArray(args) ? this.#dispatch(...args) : this.#dispatch(args);
                }
            }
        };
        const weak = new WeakRef(this);
        const controller = function (subscriber) {
            const handler = subscriber?.next?.bind?.(subscriber);
            return completeWithUnsub(subscriber, weak, handler);
        };
        // @ts-ignore
        this.#native = (typeof Observable != "undefined" ? (new Observable(controller)) : null);
        this.compatible = () => this.#native;
    }
    $safeExec(cb, ...args) {
        if (!cb || this.#flags.has(cb))
            return;
        this.#flags.add(cb);
        //
        if (this.#lastPerfNow.get(cb) === this.#now())
            return;
        this.#lastPerfNow.set(cb, this.#now());
        //
        try {
            const res = cb(...args);
            if (res && typeof res.then === "function")
                return res.catch(console.warn);
            return res;
        }
        catch (e) {
            console.warn(e);
        }
        finally {
            this.#flags.delete(cb);
        }
    }
    #dispatch(name, value = null, oldValue, ...etc) {
        const listeners = this.#listeners;
        if (!listeners?.size)
            return;
        const promises = Array.from(listeners.entries())
            .map(([cb, prop]) => {
            if (prop === name || prop === forAll || prop === null) {
                return this.$safeExec(cb, value, name, oldValue, ...etc);
            }
            return undefined;
        })
            .filter((res) => res && typeof res.then === "function");
        return promises.length ? Promise.allSettled(promises) : undefined;
    }
    wrap(nw) { if (Array.isArray(nw))
        return wrapWith(nw, this); return nw; }
    affected(cb, prop) {
        if (cb == null || typeof cb != "function")
            return;
        this.#listeners.set(cb, prop || forAll);
        return () => this.unaffected(cb, prop || forAll);
    }
    unaffected(cb, prop) {
        if (cb != null && typeof cb == "function") {
            const listeners = this.#listeners;
            if (listeners?.has(cb) && (listeners.get(cb) == prop || prop == null || prop == forAll)) {
                listeners.delete(cb);
                return () => this.affected(cb, prop || forAll);
            }
        }
        return this.#listeners.clear();
    }
    /**
     * Коалесит триггеры:
     * - один dispatch на name за микро-тик
     * - повторные trigger(name) до flush не вызывают повторно dispatch, а лишь обновляют аргументы
     * - другие name не блокируются
     */
    trigger(name, value, oldValue, operation = null, ...etc) {
        if (typeof name === "symbol")
            return;
        // operation может быть undefined из старых вызовов
        if (operation === undefined)
            operation = null;
        // ключ дедупа по operation
        // null/undefined -> "__"
        const opKey = operation ?? "__";
        // если сейчас по этому name идет dispatch (реэнтранси) — складируем
        // если не идет — тоже складируем, но flush будет один на микро-тик
        let byOp = this.#pendingByProp.get(name);
        if (!byOp) {
            byOp = new Map();
            this.#pendingByProp.set(name, byOp);
        }
        // A: схлопываем только одинаковые (name + operation) в рамках микро-тика
        byOp.set(opKey, [name, value, oldValue, operation, etc]);
        // уже запланирован flush — выходим
        if (this.#flushScheduled)
            return;
        this.#flushScheduled = true;
        queueMicrotask(() => {
            this.#flushScheduled = false;
            // забираем пачку и очищаем, чтобы триггеры во время dispatch попали в следующий тик
            const batch = this.#pendingByProp;
            this.#pendingByProp = new Map();
            // Важно: dispatch по prop, но не допускаем реэнтранси на один и тот же prop
            // (если во время dispatch придут новые trigger(prop, ...), они улетят в следующий микро-тик)
            for (const [prop, opMap] of batch) {
                if (prop != null && this.#inDispatch.has(prop))
                    continue;
                if (prop != null)
                    this.#inDispatch.add(prop);
                try {
                    for (const [, args] of opMap) {
                        const [nm, v, ov, op, rest] = args;
                        try {
                            // #dispatch ожидает (name, value, oldValue, ...etc)
                            this.#dispatch(nm, v, ov, op, ...(rest ?? []));
                        }
                        catch (e) {
                            console.warn(e);
                        }
                    }
                }
                finally {
                    if (prop != null)
                        this.#inDispatch.delete(prop);
                }
            }
        });
    }
    get iterator() { return this.#iterator; }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3Vic2NyaXB0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiU3Vic2NyaXB0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsS0FBSyxFQUFnQixNQUFNLGVBQWUsQ0FBQztBQUdwRCxFQUFFO0FBQ0YsTUFBTSxTQUFTLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztBQUNoQyxNQUFNLGlCQUFpQixHQUFHLENBQUMsVUFBVSxFQUFFLElBQTRCLEVBQUUsT0FBa0IsRUFBRSxFQUFFO0lBQ3ZGLGFBQWE7SUFDYixPQUFPLFNBQVMsQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRTtRQUMxQyxNQUFNLFFBQVEsR0FBRyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQztRQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNoRSxNQUFNLFdBQVcsR0FBRyxVQUFVLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzdELE1BQU0sVUFBVSxHQUFHLEdBQUcsRUFBRSxHQUFHLE1BQU0sQ0FBQyxHQUFHLFdBQVcsRUFBRSxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUUsVUFBVSxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuRyxVQUFVLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQztRQUNqQyxPQUFPO1lBQ0gsVUFBVTtZQUNWLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLFVBQVU7WUFDNUIsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUUsVUFBVTtTQUNwQyxDQUFBO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0saUJBQWlC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SSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzdDLElBQUksQ0FBQztvQkFDRCxLQUFLLE1BQU0sQ0FBQyxFQUFFLElBQUksQ0FBQyxJQUFJLEtBQUssRUFBRSxDQUFDO3dCQUMzQixNQUFNLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQzt3QkFDbkMsSUFBSSxDQUFDOzRCQUNELG9EQUFvRDs0QkFDcEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO3dCQUNuRCxDQUFDO3dCQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7NEJBQ1QsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDcEIsQ0FBQztvQkFDTCxDQUFDO2dCQUNMLENBQUM7d0JBQVMsQ0FBQztvQkFDUCxJQUFJLElBQUksSUFBSSxJQUFJO3dCQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNwRCxDQUFDO1lBQ0wsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELElBQUksUUFBUSxLQUFLLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Q0FDNUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyAkZXh0cmFjdEtleSQgfSBmcm9tIFwiLi4vd3JhcC9TeW1ib2xcIjtcbmltcG9ydCB7IGRlcmVmLCB0eXBlIGtleVR5cGUgfSBmcm9tIFwiLi4vd3JhcC9VdGlsc1wiO1xuaW1wb3J0IHsgV1IgfSBmcm9tIFwiZmVzdC9jb3JlXCI7XG5cbi8vXG5jb25zdCB3aXRoVW5zdWIgPSBuZXcgV2Vha01hcCgpO1xuY29uc3QgY29tcGxldGVXaXRoVW5zdWIgPSAoc3Vic2NyaWJlciwgd2VhazogV2Vha1JlZjxhbnk+IHwgV1I8YW55PiwgaGFuZGxlcjogU3Vic2NyaXB0KSA9PiB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHJldHVybiB3aXRoVW5zdWIuZ2V0T3JJbnNlcnQoc3Vic2NyaWJlciwgKCkgPT4ge1xuICAgICAgICBjb25zdCByZWdpc3RyeSA9IHdlYWs/LmRlcmVmPy4oKTsgcmVnaXN0cnk/LmFmZmVjdGVkPy4oaGFuZGxlcik7XG4gICAgICAgIGNvbnN0IHNhdkNvbXBsZXRlID0gc3Vic2NyaWJlcj8uY29tcGxldGU/LmJpbmQ/LihzdWJzY3JpYmVyKTtcbiAgICAgICAgY29uc3QgdW5hZmZlY3RlZCA9ICgpID0+IHsgY29uc3QgciA9IHNhdkNvbXBsZXRlPy4oKTsgcmVnaXN0cnk/LnVuYWZmZWN0ZWQ/LihoYW5kbGVyKTsgcmV0dXJuIHI7IH07XG4gICAgICAgIHN1YnNjcmliZXIuY29tcGxldGUgPSB1bmFmZmVjdGVkO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdW5hZmZlY3RlZCxcbiAgICAgICAgICAgIFtTeW1ib2wuZGlzcG9zZV06IHVuYWZmZWN0ZWQsXG4gICAgICAgICAgICBbU3ltYm9sLmFzeW5jRGlzcG9zZV06IHVuYWZmZWN0ZWQsXG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBzdWJzY3JpcHRSZWdpc3RyeSA9IG5ldyBXZWFrTWFwPGFueSwgU3Vic2NyaXB0PigpO1xuXG4vLyBAdHMtaWdub3JlXG5jb25zdCB3cmFwcGVkID0gbmV3IFdlYWtNYXAoKTtcblxuLy9cbmV4cG9ydCBjb25zdCByZWdpc3RlciA9ICh3aGF0OiBhbnksIGhhbmRsZTogYW55KTogYW55ID0+IHtcbiAgICBjb25zdCB1bndyYXAgPSB3aGF0Py5bJGV4dHJhY3RLZXkkXSA/PyB3aGF0OyAgLy8gQHRzLWlnbm9yZVxuICAgIHN1YnNjcmlwdFJlZ2lzdHJ5LmdldE9ySW5zZXJ0KHVud3JhcCwgbmV3IFN1YnNjcmlwdCgpKTtcbiAgICByZXR1cm4gaGFuZGxlO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IHdyYXBXaXRoID0gKHdoYXQ6IGFueSwgaGFuZGxlOiBhbnkpOiBhbnkgPT4ge1xuICAgIHdoYXQgPSBkZXJlZih3aGF0Py5bJGV4dHJhY3RLZXkkXSA/PyB3aGF0KTtcbiAgICBpZiAodHlwZW9mIHdoYXQgPT0gXCJzeW1ib2xcIiB8fCAhKHR5cGVvZiB3aGF0ID09IFwib2JqZWN0XCIgfHwgdHlwZW9mIHdoYXQgPT0gXCJmdW5jdGlvblwiKSB8fCB3aGF0ID09IG51bGwpIHJldHVybiB3aGF0OyAvLyBAdHMtaWdub3JlXG4gICAgcmV0dXJuIHdyYXBwZWQuZ2V0T3JJbnNlcnRDb21wdXRlZCh3aGF0LCAoKSA9PiBuZXcgUHJveHkod2hhdCwgcmVnaXN0ZXIod2hhdCwgaGFuZGxlKSkpO1xufTsgLy8gIWV4cGVyaW1lbnRhbCBgZ2V0T3JJbnNlcnRgIGZlYXR1cmUhXG5cbi8vXG5jb25zdCBmb3JBbGwgPSBTeW1ib2wuZm9yKFwiQGFsbFByb3BzXCIpO1xuXG4vL1xuZXhwb3J0IGNsYXNzIFN1YnNjcmlwdCB7XG4gICAgY29tcGF0aWJsZTogYW55O1xuICAgICNsaXN0ZW5lcnM6IE1hcDwodmFsdWU6IGFueSwgcHJvcDoga2V5VHlwZSwgb2xkVmFsdWU/OiBhbnksIG9wZXJhdGlvbj86IHN0cmluZyB8IG51bGwpID0+IHZvaWQsIGFueT47XG4gICAgI2ZsYWdzID0gbmV3IFdlYWtTZXQoKTtcbiAgICAjbmF0aXZlOiBhbnk7XG4gICAgI2l0ZXJhdG9yOiBhbnk7XG4gICAgI2luRGlzcGF0Y2ggPSBuZXcgU2V0PGtleVR5cGU+KCk7XG5cbiAgICAvLyDQsdGL0LvQvjogI3RyaWdnZXJMb2NrID0gbmV3IFNldDxrZXlUeXBlPigpO1xuICAgICNwZW5kaW5nID0gbmV3IE1hcDxrZXlUeXBlIHwgbnVsbCwgW2tleVR5cGUgfCBudWxsLCBhbnksIGFueSwgYW55W11dPigpO1xuICAgICNwZW5kaW5nQnlQcm9wID0gbmV3IE1hcDxrZXlUeXBlIHwgbnVsbCwgTWFwPHN0cmluZywgW2tleVR5cGUgfCBudWxsLCBhbnksIGFueSwgKHN0cmluZyB8IG51bGwpLCBhbnlbXV0+PigpO1xuICAgICNmbHVzaFNjaGVkdWxlZCA9IGZhbHNlO1xuXG4gICAgLy8gbGFzdCBydW4gdGltZXN0YW1wIHBlciBjYWxsYmFja1xuICAgICNsYXN0UGVyZk5vdyA9IG5ldyBXZWFrTWFwPEZ1bmN0aW9uLCBudW1iZXI+KCk7XG5cbiAgICAvLyDQv9C+0LvRg9GH0LDQtdC8IFwibm93XCIg0LzQsNC60YHQuNC80LDQu9GM0L3QviDQtNGR0YjQtdCy0L4v0LHQtdC30L7Qv9Cw0YHQvdC+XG4gICAgI25vdygpIHtcbiAgICAgICAgLy8gcGVyZm9ybWFuY2Ug0LzQvtC20LXRgiDQvtGC0YHRg9GC0YHRgtCy0L7QstCw0YLRjCDQsiDQvdC10LrQvtGC0L7RgNGL0YUg0YDQsNC90YLQsNC50LzQsNGFXG4gICAgICAgIHJldHVybiAoZ2xvYmFsVGhpcy5wZXJmb3JtYW5jZT8ubm93Py4oKSA/PyBEYXRlLm5vdygpKTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy4jbGlzdGVuZXJzID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLiNmbGFncyA9IG5ldyBXZWFrU2V0KCk7XG5cbiAgICAgICAgdGhpcy4jaXRlcmF0b3IgPSB7XG4gICAgICAgICAgICBuZXh0OiAoYXJnczogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGFyZ3MpIHtcbiAgICAgICAgICAgICAgICAgICAgQXJyYXkuaXNBcnJheShhcmdzKSA/IHRoaXMuI2Rpc3BhdGNoKC4uLihhcmdzIGFzIFthbnksIGFueSwgYW55LCBhbnldKSkgOiB0aGlzLiNkaXNwYXRjaChhcmdzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3Qgd2VhayA9IG5ldyBXZWFrUmVmKHRoaXMpO1xuICAgICAgICBjb25zdCBjb250cm9sbGVyID0gZnVuY3Rpb24gKHN1YnNjcmliZXIpIHtcbiAgICAgICAgICAgIGNvbnN0IGhhbmRsZXIgPSBzdWJzY3JpYmVyPy5uZXh0Py5iaW5kPy4oc3Vic2NyaWJlcik7XG4gICAgICAgICAgICByZXR1cm4gY29tcGxldGVXaXRoVW5zdWIoc3Vic2NyaWJlciwgd2VhaywgaGFuZGxlcik7XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICB0aGlzLiNuYXRpdmUgPSAodHlwZW9mIE9ic2VydmFibGUgIT0gXCJ1bmRlZmluZWRcIiA/IChuZXcgT2JzZXJ2YWJsZShjb250cm9sbGVyKSkgOiBudWxsKVxuICAgICAgICB0aGlzLmNvbXBhdGlibGUgPSAoKSA9PiB0aGlzLiNuYXRpdmU7XG4gICAgfVxuXG4gICAgJHNhZmVFeGVjKGNiLCAuLi5hcmdzKSB7XG4gICAgICAgIGlmICghY2IgfHwgdGhpcy4jZmxhZ3MuaGFzKGNiKSkgcmV0dXJuO1xuICAgICAgICB0aGlzLiNmbGFncy5hZGQoY2IpO1xuXG4gICAgICAgIC8vXG4gICAgICAgIGlmICh0aGlzLiNsYXN0UGVyZk5vdy5nZXQoY2IpID09PSB0aGlzLiNub3coKSkgcmV0dXJuO1xuICAgICAgICB0aGlzLiNsYXN0UGVyZk5vdy5zZXQoY2IsIHRoaXMuI25vdygpKTtcblxuICAgICAgICAvL1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcmVzID0gY2IoLi4uYXJncyk7XG4gICAgICAgICAgICBpZiAocmVzICYmIHR5cGVvZiAocmVzIGFzIGFueSkudGhlbiA9PT0gXCJmdW5jdGlvblwiKSByZXR1cm4gKHJlcyBhcyBQcm9taXNlPGFueT4pLmNhdGNoKGNvbnNvbGUud2Fybik7XG4gICAgICAgICAgICByZXR1cm4gcmVzO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oZSk7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICB0aGlzLiNmbGFncy5kZWxldGUoY2IpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgI2Rpc3BhdGNoKG5hbWUsIHZhbHVlID0gbnVsbCwgb2xkVmFsdWU/OiBhbnksIC4uLmV0YzogYW55W10pIHtcbiAgICAgICAgY29uc3QgbGlzdGVuZXJzID0gdGhpcy4jbGlzdGVuZXJzO1xuICAgICAgICBpZiAoIWxpc3RlbmVycz8uc2l6ZSkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IHByb21pc2VzOiBQcm9taXNlPGFueT5bXSA9IEFycmF5LmZyb20obGlzdGVuZXJzLmVudHJpZXMoKSlcbiAgICAgICAgICAgIC5tYXAoKFtjYiwgcHJvcF0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocHJvcCA9PT0gbmFtZSB8fCBwcm9wID09PSBmb3JBbGwgfHwgcHJvcCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kc2FmZUV4ZWMoY2IsIHZhbHVlLCBuYW1lLCBvbGRWYWx1ZSwgLi4uZXRjKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuZmlsdGVyKChyZXM6IGFueSkgPT4gcmVzICYmIHR5cGVvZiByZXMudGhlbiA9PT0gXCJmdW5jdGlvblwiKTtcblxuICAgICAgICByZXR1cm4gcHJvbWlzZXMubGVuZ3RoID8gUHJvbWlzZS5hbGxTZXR0bGVkKHByb21pc2VzKSA6IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICB3cmFwKG53OiBhbnlbXSB8IHVua25vd24pIHsgaWYgKEFycmF5LmlzQXJyYXkobncpKSByZXR1cm4gd3JhcFdpdGgobncsIHRoaXMpOyByZXR1cm4gbnc7IH1cblxuICAgIGFmZmVjdGVkKGNiOiAodmFsdWU6IGFueSwgcHJvcDoga2V5VHlwZSkgPT4gdm9pZCwgcHJvcD86IGtleVR5cGUgfCBudWxsKSB7XG4gICAgICAgIGlmIChjYiA9PSBudWxsIHx8IHR5cGVvZiBjYiAhPSBcImZ1bmN0aW9uXCIpIHJldHVybjtcbiAgICAgICAgdGhpcy4jbGlzdGVuZXJzLnNldChjYiwgcHJvcCB8fCBmb3JBbGwpO1xuICAgICAgICByZXR1cm4gKCkgPT4gdGhpcy51bmFmZmVjdGVkKGNiLCBwcm9wIHx8IGZvckFsbCk7XG4gICAgfVxuXG4gICAgdW5hZmZlY3RlZChjYj86ICh2YWx1ZTogYW55LCBwcm9wOiBrZXlUeXBlKSA9PiB2b2lkLCBwcm9wPzoga2V5VHlwZSB8IG51bGwpIHtcbiAgICAgICAgaWYgKGNiICE9IG51bGwgJiYgdHlwZW9mIGNiID09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgY29uc3QgbGlzdGVuZXJzID0gdGhpcy4jbGlzdGVuZXJzO1xuICAgICAgICAgICAgaWYgKGxpc3RlbmVycz8uaGFzKGNiKSAmJiAobGlzdGVuZXJzLmdldChjYikgPT0gcHJvcCB8fCBwcm9wID09IG51bGwgfHwgcHJvcCA9PSBmb3JBbGwpKSB7XG4gICAgICAgICAgICAgICAgbGlzdGVuZXJzLmRlbGV0ZShjYik7XG4gICAgICAgICAgICAgICAgcmV0dXJuICgpID0+IHRoaXMuYWZmZWN0ZWQoY2IsIHByb3AgfHwgZm9yQWxsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy4jbGlzdGVuZXJzLmNsZWFyKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog0JrQvtCw0LvQtdGB0LjRgiDRgtGA0LjQs9Cz0LXRgNGLOlxuICAgICAqIC0g0L7QtNC40L0gZGlzcGF0Y2gg0L3QsCBuYW1lINC30LAg0LzQuNC60YDQvi3RgtC40LpcbiAgICAgKiAtINC/0L7QstGC0L7RgNC90YvQtSB0cmlnZ2VyKG5hbWUpINC00L4gZmx1c2gg0L3QtSDQstGL0LfRi9Cy0LDRjtGCINC/0L7QstGC0L7RgNC90L4gZGlzcGF0Y2gsINCwINC70LjRiNGMINC+0LHQvdC+0LLQu9GP0Y7RgiDQsNGA0LPRg9C80LXQvdGC0YtcbiAgICAgKiAtINC00YDRg9Cz0LjQtSBuYW1lINC90LUg0LHQu9C+0LrQuNGA0YPRjtGC0YHRj1xuICAgICAqL1xuICAgIHRyaWdnZXIobmFtZToga2V5VHlwZSB8IG51bGwsIHZhbHVlPzogYW55IHwgbnVsbCwgb2xkVmFsdWU/OiBhbnksIG9wZXJhdGlvbjogc3RyaW5nIHwgbnVsbCA9IG51bGwsIC4uLmV0YzogYW55W10pIHtcbiAgICAgICAgaWYgKHR5cGVvZiBuYW1lID09PSBcInN5bWJvbFwiKSByZXR1cm47XG5cbiAgICAgICAgLy8gb3BlcmF0aW9uINC80L7QttC10YIg0LHRi9GC0YwgdW5kZWZpbmVkINC40Lcg0YHRgtCw0YDRi9GFINCy0YvQt9C+0LLQvtCyXG4gICAgICAgIGlmIChvcGVyYXRpb24gPT09IHVuZGVmaW5lZCkgb3BlcmF0aW9uID0gbnVsbDtcblxuICAgICAgICAvLyDQutC70Y7RhyDQtNC10LTRg9C/0LAg0L/QviBvcGVyYXRpb25cbiAgICAgICAgLy8gbnVsbC91bmRlZmluZWQgLT4gXCJfX1wiXG4gICAgICAgIGNvbnN0IG9wS2V5ID0gb3BlcmF0aW9uID8/IFwiX19cIjtcblxuICAgICAgICAvLyDQtdGB0LvQuCDRgdC10LnRh9Cw0YEg0L/QviDRjdGC0L7QvNGDIG5hbWUg0LjQtNC10YIgZGlzcGF0Y2ggKNGA0LXRjdC90YLRgNCw0L3RgdC4KSDigJQg0YHQutC70LDQtNC40YDRg9C10LxcbiAgICAgICAgLy8g0LXRgdC70Lgg0L3QtSDQuNC00LXRgiDigJQg0YLQvtC20LUg0YHQutC70LDQtNC40YDRg9C10LwsINC90L4gZmx1c2gg0LHRg9C00LXRgiDQvtC00LjQvSDQvdCwINC80LjQutGA0L4t0YLQuNC6XG4gICAgICAgIGxldCBieU9wID0gdGhpcy4jcGVuZGluZ0J5UHJvcC5nZXQobmFtZSk7XG4gICAgICAgIGlmICghYnlPcCkge1xuICAgICAgICAgICAgYnlPcCA9IG5ldyBNYXAoKTtcbiAgICAgICAgICAgIHRoaXMuI3BlbmRpbmdCeVByb3Auc2V0KG5hbWUsIGJ5T3ApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQTog0YHRhdC70L7Qv9GL0LLQsNC10Lwg0YLQvtC70YzQutC+INC+0LTQuNC90LDQutC+0LLRi9C1IChuYW1lICsgb3BlcmF0aW9uKSDQsiDRgNCw0LzQutCw0YUg0LzQuNC60YDQvi3RgtC40LrQsFxuICAgICAgICBieU9wLnNldChvcEtleSwgW25hbWUsIHZhbHVlLCBvbGRWYWx1ZSwgb3BlcmF0aW9uLCBldGNdKTtcblxuICAgICAgICAvLyDRg9C20LUg0LfQsNC/0LvQsNC90LjRgNC+0LLQsNC9IGZsdXNoIOKAlCDQstGL0YXQvtC00LjQvFxuICAgICAgICBpZiAodGhpcy4jZmx1c2hTY2hlZHVsZWQpIHJldHVybjtcbiAgICAgICAgdGhpcy4jZmx1c2hTY2hlZHVsZWQgPSB0cnVlO1xuXG4gICAgICAgIHF1ZXVlTWljcm90YXNrKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuI2ZsdXNoU2NoZWR1bGVkID0gZmFsc2U7XG5cbiAgICAgICAgICAgIC8vINC30LDQsdC40YDQsNC10Lwg0L/QsNGH0LrRgyDQuCDQvtGH0LjRidCw0LXQvCwg0YfRgtC+0LHRiyDRgtGA0LjQs9Cz0LXRgNGLINCy0L4g0LLRgNC10LzRjyBkaXNwYXRjaCDQv9C+0L/QsNC70Lgg0LIg0YHQu9C10LTRg9GO0YnQuNC5INGC0LjQulxuICAgICAgICAgICAgY29uc3QgYmF0Y2ggPSB0aGlzLiNwZW5kaW5nQnlQcm9wO1xuICAgICAgICAgICAgdGhpcy4jcGVuZGluZ0J5UHJvcCA9IG5ldyBNYXAoKTtcblxuICAgICAgICAgICAgLy8g0JLQsNC20L3QvjogZGlzcGF0Y2gg0L/QviBwcm9wLCDQvdC+INC90LUg0LTQvtC/0YPRgdC60LDQtdC8INGA0LXRjdC90YLRgNCw0L3RgdC4INC90LAg0L7QtNC40L0g0Lgg0YLQvtGCINC20LUgcHJvcFxuICAgICAgICAgICAgLy8gKNC10YHQu9C4INCy0L4g0LLRgNC10LzRjyBkaXNwYXRjaCDQv9GA0LjQtNGD0YIg0L3QvtCy0YvQtSB0cmlnZ2VyKHByb3AsIC4uLiksINC+0L3QuCDRg9C70LXRgtGP0YIg0LIg0YHQu9C10LTRg9GO0YnQuNC5INC80LjQutGA0L4t0YLQuNC6KVxuICAgICAgICAgICAgZm9yIChjb25zdCBbcHJvcCwgb3BNYXBdIG9mIGJhdGNoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHByb3AgIT0gbnVsbCAmJiB0aGlzLiNpbkRpc3BhdGNoLmhhcyhwcm9wKSkgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICBpZiAocHJvcCAhPSBudWxsKSB0aGlzLiNpbkRpc3BhdGNoLmFkZChwcm9wKTtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IFssIGFyZ3NdIG9mIG9wTWFwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBbbm0sIHYsIG92LCBvcCwgcmVzdF0gPSBhcmdzO1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAjZGlzcGF0Y2gg0L7QttC40LTQsNC10YIgKG5hbWUsIHZhbHVlLCBvbGRWYWx1ZSwgLi4uZXRjKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuI2Rpc3BhdGNoKG5tLCB2LCBvdiwgb3AsIC4uLihyZXN0ID8/IFtdKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3AgIT0gbnVsbCkgdGhpcy4jaW5EaXNwYXRjaC5kZWxldGUocHJvcCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBnZXQgaXRlcmF0b3IoKSB7IHJldHVybiB0aGlzLiNpdGVyYXRvcjsgfVxufVxuIl19
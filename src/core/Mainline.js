import { callByAllProp, callByProp, hasValue, isKeyType, isNotEqual, isPrimitive, objectAssign } from "fest/core";
import { $extractKey$, $registryKey$, $affected } from "../wrap/Symbol";
import { addToCallChain, safe, withPromise, isThenable } from "../wrap/Utils";
import { subscriptRegistry } from "./Subscript";
import { observableBySet, observableByMap } from "./Assigned";
import { isObservable } from "./Primitives";
//
export const useObservable = (unwrap) => {
    if (unwrap == null || (typeof unwrap != "object" && typeof unwrap != "function") || unwrap?.[Symbol.observable] != null) {
        return unwrap;
    } // @ts-ignore
    try {
        unwrap[Symbol.observable] = self?.compatible;
    }
    catch (e) {
        console.warn("Unable to assign <[Symbol.observable]>, object will not observable by other frameworks");
    }
    ;
    unwrap[$affected] = (cb) => {
        const observable = unwrap?.[Symbol?.observable];
        observable?.()?.affected?.(cb);
        return () => observable?.()?.unaffected?.(cb);
    }; // @ts-ignore
    return unwrap;
};
export const specializedSubscribe = new WeakMap();
//
const checkValidObj = (obj) => {
    if (typeof obj == "symbol" || obj == null || !(typeof obj == "object" || typeof obj == "function"))
        return;
    return obj;
};
//
export const subscribeDirectly = (target, prop, cb, ctx = null) => {
    if (!target)
        return;
    if (!checkValidObj(target))
        return;
    const tProp = (prop != Symbol.iterator) ? prop : null;
    //
    let registry = target?.[$registryKey$] ?? (subscriptRegistry).get(target);
    //
    target = target?.[$extractKey$] ?? target;
    //
    queueMicrotask(() => {
        if (tProp != null && tProp != Symbol.iterator) {
            callByProp(target, tProp, cb, ctx);
        }
        else {
            callByAllProp(target, cb, ctx);
        }
    });
    //
    let unSub = registry?.affected?.(cb, tProp);
    if (target?.[Symbol.dispose])
        return unSub;
    //
    addToCallChain(unSub, Symbol.dispose, unSub);
    addToCallChain(unSub, Symbol.asyncDispose, unSub);
    addToCallChain(target, Symbol.dispose, unSub);
    addToCallChain(target, Symbol.asyncDispose, unSub);
    return unSub;
};
//
export const subscribeInput = (tg, _, cb, ctx = null) => {
    // inputs now can be regally subscribed directly
    const $opt = {};
    let oldValue = tg?.value;
    const $cb = (ev) => { cb?.(ev?.target?.value, "value", oldValue); oldValue = ev?.target?.value; };
    tg?.addEventListener?.("change", $cb, $opt);
    return () => tg?.removeEventListener?.("change", $cb, $opt);
};
//
const checkIsPaired = (tg) => {
    return (Array.isArray(tg) && tg?.length == 2 && checkValidObj(tg?.[0])) && (isKeyType(tg?.[1]) || tg?.[1] == Symbol.iterator);
};
// split from prop pairs
export const subscribePaired = (tg, _, cb, ctx = null) => {
    const prop = isKeyType(tg?.[1]) ? tg?.[1] : null;
    return affected(tg?.[0], prop, cb, ctx);
};
//
export const subscribeThenable = (obj, prop, cb, ctx = null) => {
    return obj?.then?.((obj) => affected?.(obj, prop, cb, ctx))?.catch?.((e) => { console.warn(e); return null; });
};
//
export const affected = (obj, prop, cb = () => { }, ctx) => {
    if (typeof prop == "function") {
        cb = prop;
        prop = null;
    }
    //
    if (isPrimitive(obj) || typeof obj == "symbol") {
        return queueMicrotask(() => { return cb?.(obj, null, null, null); });
    }
    if (typeof obj?.[$affected] == "function") {
        return obj?.[$affected]?.(cb, prop, ctx);
    }
    else if (checkValidObj(obj)) {
        const wrapped = obj;
        obj = obj?.[$extractKey$] ?? obj;
        if (specializedSubscribe?.has?.(obj)) {
            return specializedSubscribe?.get?.(obj)?.(wrapped, prop, cb, ctx);
        }
        //
        if (isObservable(wrapped) || (checkIsPaired(obj) && isObservable(obj?.[0]))) {
            // when no exists, add a new specialized subscribe function
            if (isThenable(obj)) //@ts-ignore
             {
                return specializedSubscribe?.getOrInsert?.(obj, subscribeThenable)?.(obj, prop, cb, ctx);
            }
            else if (checkIsPaired(obj)) //@ts-ignore
             {
                return specializedSubscribe?.getOrInsert?.(obj, subscribePaired)?.(obj, prop, cb, ctx);
            }
            else if (typeof HTMLInputElement != "undefined" && obj instanceof HTMLInputElement) //@ts-ignore
             {
                return specializedSubscribe?.getOrInsert?.(obj, subscribeInput)?.(obj, prop, cb, ctx);
            }
            else //@ts-ignore
             {
                return specializedSubscribe?.getOrInsert?.(obj, subscribeDirectly)?.(wrapped, prop, cb, ctx);
            }
        }
        else {
            return queueMicrotask(() => {
                if (checkIsPaired(obj)) {
                    return callByProp?.(obj?.[0], obj?.[1], cb, ctx);
                }
                if (prop != null && prop != Symbol.iterator) {
                    return callByProp?.(obj, prop, cb, ctx);
                }
                return callByAllProp?.(obj, cb, ctx);
            });
        }
    }
};
//
export const makeArrayObservable = (tg) => {
    if (tg instanceof Set)
        return observableBySet(tg);
    if (tg instanceof Map)
        return observableByMap(tg);
    return tg;
};
//
export class DoubleWeakMap {
    #top = new WeakMap(); // key1 -> WeakMap(key2 -> value)
    #ensureInner(key1) {
        let inner = this.#top.get(key1);
        if (!inner) {
            inner = new WeakMap();
            this.#top.set(key1, inner);
        }
        return inner;
    }
    #splitPair(pair) {
        if (!Array.isArray(pair) || pair.length !== 2) {
            //throw new TypeError("Key must be a pair: [keyL1, keyL2]");
            return [null, null];
        }
        return pair;
    }
    hasL1(key1) {
        return this.#top.has(key1);
    }
    set(pair, value) {
        const [key1, key2] = this.#splitPair(pair);
        this.#ensureInner(key1).set(key2, value);
        return this;
    }
    get(pair) {
        const [key1, key2] = this.#splitPair(pair);
        return this.#top.get(key1)?.get(key2);
    }
    has(pair) {
        const [key1, key2] = this.#splitPair(pair);
        return this.#top.get(key1)?.has(key2) ?? false;
    }
    delete(pair) {
        const [key1, key2] = this.#splitPair(pair);
        const inner = this.#top.get(key1);
        return inner ? inner.delete(key2) : false;
    }
    deleteTop(key1) {
        return this.#top.delete(key1);
    }
    // Уже было: универсальный get-or-create (синонимно логике "computed")
    getOrCreate(pair, factory) {
        const [key1, key2] = this.#splitPair(pair);
        const inner = this.#ensureInner(key1);
        if (inner.has(key2))
            return inner.get(key2);
        const value = factory();
        inner.set(key2, value);
        return value;
    }
    // getOrInsert: если нет — вставить *переданное* значение (без вычисления)
    getOrInsert(pair, value) {
        const [key1, key2] = this.#splitPair(pair);
        const inner = this.#ensureInner(key1);
        if (inner.has(key2))
            return inner.get(key2);
        inner.set(key2, value);
        return value;
    }
    // getOrInsertComputed: если нет — вычислить через fn(pair) и вставить
    // (удобно, когда надо использовать ключи в вычислении)
    getOrInsertComputed(pair, compute) {
        const [key1, key2] = this.#splitPair(pair);
        const inner = this.#ensureInner(key1);
        if (inner.has(key2))
            return inner.get(key2);
        const value = compute([key1, key2]);
        inner.set(key2, value);
        return value;
    }
}
//
const registeredIterated = new DoubleWeakMap();
//
export const iterated = (tg, cb, ctx = null) => {
    if (!tg)
        return;
    //
    if (registeredIterated.has([tg, cb])) {
        return registeredIterated.get([tg, cb]);
    }
    //
    const $sub = (value, name, old) => {
        if (name == "value") {
            //TODO: needs notify, that elements of arrayold is removed
            const entries = (old?.value ?? old)?.entries?.();
            const basis = tg?.value ?? value?.value ?? value;
            //
            if (entries) {
                for (const [idx, item] of entries) {
                    const ofOld = item ?? ((old?.value ?? old)?.[idx] ?? null);
                    const ofNew = basis?.[idx];
                    if (ofOld == null && ofNew != null) {
                        cb(ofNew, idx, null, "@add");
                    }
                    else if (ofOld != null && ofNew == null) {
                        cb(null, idx, ofOld, "@delete");
                    }
                    else if (isNotEqual(ofOld, ofNew)) {
                        cb(ofNew, idx, ofOld, "@set");
                    }
                }
            }
            //
            return iterated(value ?? tg?.value, (value, prop, old, operation) => {
                cb(value, prop, old, operation);
            });
        }
        return tg[name];
    };
    // @ts-ignore
    return registeredIterated.getOrInsertComputed([tg, cb], () => {
        if (tg instanceof Set) {
            return affected([observableBySet(tg), Symbol.iterator], cb, ctx);
        }
        if (tg instanceof Map) {
            return affected(tg, cb, ctx);
        }
        if (hasValue(tg)) {
            return affected(tg, $sub, ctx);
        }
        if (Array.isArray(tg) && !(tg?.length == 2 && isKeyType(tg?.[1]) && isObservable(tg?.[0]))) {
            return affected([tg, Symbol.iterator], cb, ctx);
        }
        return affected(tg, cb, ctx);
    });
};
//
export const unaffected = (tg, cb, ctx = null) => {
    return withPromise(tg, (target) => {
        const isPair = Array.isArray(target) && target?.length == 2 && ["object", "function"].indexOf(typeof target?.[0]) >= 0 && isKeyType(target?.[1]);
        const prop = isPair ? target?.[1] : null;
        target = (isPair && prop != null) ? (target?.[0] ?? target) : target;
        const unwrap = (typeof target == "object" || typeof target == "function") ? (target?.[$extractKey$] ?? target) : target;
        let self = target?.[$registryKey$] ?? (subscriptRegistry).get(unwrap);
        self?.unaffected?.(cb, prop);
    });
};
//
export const bindBy = (target, reactive, watch) => {
    affected(reactive, null, (v, p) => { objectAssign(target, v, p, true); });
    watch?.(() => target, (N) => { for (const k in N) {
        objectAssign(reactive, N[k], k, true);
    } }, { deep: true });
    return target;
};
//
export const derivate = (from, reactFn, watch) => bindBy(reactFn(safe(from)), from, watch);
export const bindByKey = (target, reactive, key = () => "") => affected(reactive, null, (value, p) => { if (p == key()) {
    objectAssign(target, value, null, true);
} });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFpbmxpbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJNYWlubGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2xILE9BQU8sRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBWSxNQUFNLGdCQUFnQixDQUFDO0FBQ2xGLE9BQU8sRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBd0MsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3BILE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNoRCxPQUFPLEVBQUUsZUFBZSxFQUFFLGVBQWUsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUM5RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRTVDLEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxhQUFhLEdBQUcsQ0FBYyxNQUFXLEVBQXVCLEVBQUU7SUFDM0UsSUFBSSxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsT0FBTyxNQUFNLElBQUksUUFBUSxJQUFJLE9BQU8sTUFBTSxJQUFJLFVBQVUsQ0FBQyxJQUFJLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUFDLE9BQU8sTUFBTSxDQUFDO0lBQUMsQ0FBQyxDQUFDLGFBQWE7SUFDekosSUFBSSxDQUFDO1FBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxJQUFJLEVBQUUsVUFBVSxDQUFDO0lBQUMsQ0FBQztJQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7UUFBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHdGQUF3RixDQUFDLENBQUM7SUFBQyxDQUFDO0lBQUEsQ0FBQztJQUM1SyxNQUFN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Y2VzQ29udGVudCI6WyJpbXBvcnQgeyBjYWxsQnlBbGxQcm9wLCBjYWxsQnlQcm9wLCBoYXNWYWx1ZSwgaXNLZXlUeXBlLCBpc05vdEVxdWFsLCBpc1ByaW1pdGl2ZSwgb2JqZWN0QXNzaWduIH0gZnJvbSBcImZlc3QvY29yZVwiO1xuaW1wb3J0IHsgJGV4dHJhY3RLZXkkLCAkcmVnaXN0cnlLZXkkLCAkYWZmZWN0ZWQsICR0cmlnZ2VyIH0gZnJvbSBcIi4uL3dyYXAvU3ltYm9sXCI7XG5pbXBvcnQgeyBhZGRUb0NhbGxDaGFpbiwgc2FmZSwgd2l0aFByb21pc2UsIHR5cGUga2V5VHlwZSwgc3ViVmFsaWQsIG9ic2VydmVWYWxpZCwgaXNUaGVuYWJsZSB9IGZyb20gXCIuLi93cmFwL1V0aWxzXCI7XG5pbXBvcnQgeyBzdWJzY3JpcHRSZWdpc3RyeSB9IGZyb20gXCIuL1N1YnNjcmlwdFwiO1xuaW1wb3J0IHsgb2JzZXJ2YWJsZUJ5U2V0LCBvYnNlcnZhYmxlQnlNYXAgfSBmcm9tIFwiLi9Bc3NpZ25lZFwiO1xuaW1wb3J0IHsgaXNPYnNlcnZhYmxlIH0gZnJvbSBcIi4vUHJpbWl0aXZlc1wiO1xuXG4vL1xuZXhwb3J0IGNvbnN0IHVzZU9ic2VydmFibGUgPSA8VW5kZXIgPSBhbnk+KHVud3JhcDogYW55KTogb2JzZXJ2ZVZhbGlkPFVuZGVyPiA9PiB7IC8vIEB0cy1pZ25vcmVcbiAgICBpZiAodW53cmFwID09IG51bGwgfHwgKHR5cGVvZiB1bndyYXAgIT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgdW53cmFwICE9IFwiZnVuY3Rpb25cIikgfHwgdW53cmFwPy5bU3ltYm9sLm9ic2VydmFibGVdICE9IG51bGwpIHsgcmV0dXJuIHVud3JhcDsgfSAvLyBAdHMtaWdub3JlXG4gICAgdHJ5IHsgdW53cmFwW1N5bWJvbC5vYnNlcnZhYmxlXSA9IHNlbGY/LmNvbXBhdGlibGU7IH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKFwiVW5hYmxlIHRvIGFzc2lnbiA8W1N5bWJvbC5vYnNlcnZhYmxlXT4sIG9iamVjdCB3aWxsIG5vdCBvYnNlcnZhYmxlIGJ5IG90aGVyIGZyYW1ld29ya3NcIik7IH07XG4gICAgdW53cmFwWyRhZmZlY3RlZF0gPSAoY2IpPT57IC8vIEB0cy1pZ25vcmVcbiAgICAgICAgY29uc3Qgb2JzZXJ2YWJsZSA9IHVud3JhcD8uW1N5bWJvbD8ub2JzZXJ2YWJsZV07XG4gICAgICAgIG9ic2VydmFibGU/LigpPy5hZmZlY3RlZD8uKGNiKTtcbiAgICAgICAgcmV0dXJuICgpID0+IG9ic2VydmFibGU/LigpPy51bmFmZmVjdGVkPy4oY2IpO1xuICAgIH07IC8vIEB0cy1pZ25vcmVcbiAgICByZXR1cm4gdW53cmFwO1xufVxuXG4vL1xudHlwZSBjYWxsYWJsZSA9ICh2YWx1ZTogYW55LCBwcm9wOiBrZXlUeXBlLCBvbGQ/OiBhbnksIG9wZXJhdGlvbj86IHN0cmluZyB8IG51bGwpID0+IHZvaWQ7XG50eXBlIHN1YnNjcmlwdCA9ICh0YXJnZXQ6IGFueSwgcHJvcDoga2V5VHlwZSB8IG51bGwsIGNiOiBjYWxsYWJsZSwgY3R4PzogYW55KSA9PiBhbnk7XG5leHBvcnQgY29uc3Qgc3BlY2lhbGl6ZWRTdWJzY3JpYmUgPSBuZXcgV2Vha01hcDxhbnksIHN1YnNjcmlwdD4oKTtcblxuLy9cbmNvbnN0IGNoZWNrVmFsaWRPYmogPSAob2JqOiBhbnkpID0+IHtcbiAgICBpZiAodHlwZW9mIG9iaiA9PSBcInN5bWJvbFwiIHx8IG9iaiA9PSBudWxsIHx8ICEodHlwZW9mIG9iaiA9PSBcIm9iamVjdFwiIHx8IHR5cGVvZiBvYmogPT0gXCJmdW5jdGlvblwiKSkgcmV0dXJuO1xuICAgIHJldHVybiBvYmo7XG59XG5cbi8vXG5leHBvcnQgY29uc3Qgc3Vic2NyaWJlRGlyZWN0bHk6IHN1YnNjcmlwdCA9ICh0YXJnZXQ6IGFueSwgcHJvcDoga2V5VHlwZSB8IG51bGwsIGNiOiAodmFsdWU6IGFueSwgcHJvcDoga2V5VHlwZSwgb2xkPzogYW55LCBvcGVyYXRpb24/OiBzdHJpbmd8bnVsbCkgPT4gdm9pZCwgY3R4OiBhbnkgfCBudWxsID0gbnVsbCkgPT4geyBpZiAoIXRhcmdldCkgcmV0dXJuO1xuICAgIGlmICghY2hlY2tWYWxpZE9iaih0YXJnZXQpKSByZXR1cm47XG4gICAgY29uc3QgdFByb3AgPSAocHJvcCAhPSBTeW1ib2wuaXRlcmF0b3IpID8gcHJvcCA6IG51bGw7XG5cbiAgICAvL1xuICAgIGxldCByZWdpc3RyeSA9IHRhcmdldD8uWyRyZWdpc3RyeUtleSRdID8/IChzdWJzY3JpcHRSZWdpc3RyeSkuZ2V0KHRhcmdldCk7XG5cbiAgICAvL1xuICAgIHRhcmdldCA9IHRhcmdldD8uWyRleHRyYWN0S2V5JF0gPz8gdGFyZ2V0O1xuXG4gICAgLy9cbiAgICBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7XG4gICAgICAgIGlmICh0UHJvcCAhPSBudWxsICYmIHRQcm9wICE9IFN5bWJvbC5pdGVyYXRvcikgeyBjYWxsQnlQcm9wKHRhcmdldCwgdFByb3AsIGNiLCBjdHgpOyB9IGVsc2UgeyBjYWxsQnlBbGxQcm9wKHRhcmdldCwgY2IsIGN0eCk7IH1cbiAgICB9KTtcblxuICAgIC8vXG4gICAgbGV0IHVuU3ViOiBhbnkgPSByZWdpc3RyeT8uYWZmZWN0ZWQ/LihjYiwgdFByb3ApO1xuICAgIGlmICh0YXJnZXQ/LltTeW1ib2wuZGlzcG9zZV0pIHJldHVybiB1blN1YjtcblxuICAgIC8vXG4gICAgYWRkVG9DYWxsQ2hhaW4odW5TdWIsIFN5bWJvbC5kaXNwb3NlLCB1blN1Yik7XG4gICAgYWRkVG9DYWxsQ2hhaW4odW5TdWIsIFN5bWJvbC5hc3luY0Rpc3Bvc2UsIHVuU3ViKTtcbiAgICBhZGRUb0NhbGxDaGFpbih0YXJnZXQsIFN5bWJvbC5kaXNwb3NlLCB1blN1Yik7XG4gICAgYWRkVG9DYWxsQ2hhaW4odGFyZ2V0LCBTeW1ib2wuYXN5bmNEaXNwb3NlLCB1blN1Yik7XG4gICAgcmV0dXJuIHVuU3ViO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IHN1YnNjcmliZUlucHV0OiBzdWJzY3JpcHQgPSAodGc6IEhUTUxJbnB1dEVsZW1lbnQsIF86IGtleVR5cGUgfCBudWxsLCBjYjogKHZhbHVlOiBhbnksIF86IGtleVR5cGUsIG9sZD86IGFueSwgb3BlcmF0aW9uPzogc3RyaW5nfG51bGwpID0+IHZvaWQsIGN0eDogYW55IHwgbnVsbCA9IG51bGwpID0+IHtcbiAgICAvLyBpbnB1dHMgbm93IGNhbiBiZSByZWdhbGx5IHN1YnNjcmliZWQgZGlyZWN0bHlcbiAgICBjb25zdCAkb3B0OiBhbnkgPSB7IH07IGxldCBvbGRWYWx1ZSA9IHRnPy52YWx1ZTtcbiAgICBjb25zdCAkY2IgPSAoZXY6IGFueSkgPT4geyBjYj8uKGV2Py50YXJnZXQ/LnZhbHVlLCBcInZhbHVlXCIsIG9sZFZhbHVlKTsgb2xkVmFsdWUgPSBldj8udGFyZ2V0Py52YWx1ZTsgfTtcbiAgICAodGcgYXMgYW55KT8uYWRkRXZlbnRMaXN0ZW5lcj8uKFwiY2hhbmdlXCIsICRjYiwgJG9wdCk7XG4gICAgcmV0dXJuICgpID0+ICh0ZyBhcyBhbnkpPy5yZW1vdmVFdmVudExpc3RlbmVyPy4oXCJjaGFuZ2VcIiwgJGNiLCAkb3B0KTtcbn1cblxuLy9cbmNvbnN0IGNoZWNrSXNQYWlyZWQgPSAodGc6IGFueSkgPT4ge1xuICAgIHJldHVybiAoQXJyYXkuaXNBcnJheSh0ZykgJiYgdGc/Lmxlbmd0aCA9PSAyICYmIGNoZWNrVmFsaWRPYmoodGc/LlswXSkpICYmIChpc0tleVR5cGUodGc/LlsxXSkgfHwgdGc/LlsxXSA9PSBTeW1ib2wuaXRlcmF0b3IpO1xufVxuXG4vLyBzcGxpdCBmcm9tIHByb3AgcGFpcnNcbmV4cG9ydCBjb25zdCBzdWJzY3JpYmVQYWlyZWQ6IHN1YnNjcmlwdCA9IDxVbmRlciA9IGFueT4odGc6IHN1YlZhbGlkPFVuZGVyPiwgXzoga2V5VHlwZSB8IG51bGwsIGNiOiAodmFsdWU6IGFueSwgcHJvcDoga2V5VHlwZSwgb2xkPzogYW55LCBvcGVyYXRpb24/OiBzdHJpbmd8bnVsbCkgPT4gdm9pZCwgY3R4OiBhbnkgfCBudWxsID0gbnVsbCkgPT4ge1xuICAgIGNvbnN0IHByb3AgPSBpc0tleVR5cGUodGc/LlsxXSkgPyB0Zz8uWzFdIDogbnVsbDtcbiAgICByZXR1cm4gYWZmZWN0ZWQodGc/LlswXSwgcHJvcCwgY2IsIGN0eCk7XG59XG5cbi8vXG5leHBvcnQgY29uc3Qgc3Vic2NyaWJlVGhlbmFibGU6IHN1YnNjcmlwdCA9IChvYmo6IGFueSwgcHJvcDoga2V5VHlwZSB8IG51bGwsIGNiOiAodmFsdWU6IGFueSwgcHJvcDoga2V5VHlwZSwgb2xkPzogYW55LCBvcGVyYXRpb24/OiBzdHJpbmd8bnVsbCkgPT4gdm9pZCwgY3R4OiBhbnkgfCBudWxsID0gbnVsbCkgPT4ge1xuICAgIHJldHVybiBvYmo/LnRoZW4/Ligob2JqOiBhbnkpID0+IGFmZmVjdGVkPy4ob2JqLCBwcm9wLCBjYiwgY3R4KSk/LmNhdGNoPy4oKGU6IGFueSkgPT4geyBjb25zb2xlLndhcm4oZSk7IHJldHVybiBudWxsOyB9KTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBhZmZlY3RlZCA9IChvYmo6IGFueSwgcHJvcDoga2V5VHlwZSB8IGNhbGxhYmxlIHwgbnVsbCwgY2I6IGNhbGxhYmxlID0gKCk9Pnt9LCBjdHg/OiBhbnkpID0+IHtcbiAgICBpZiAodHlwZW9mIHByb3AgPT0gXCJmdW5jdGlvblwiKSB7IGNiID0gcHJvcDsgcHJvcCA9IG51bGw7IH1cblxuICAgIC8vXG4gICAgaWYgKGlzUHJpbWl0aXZlKG9iaikgfHwgdHlwZW9mIG9iaiA9PSBcInN5bWJvbFwiKSB7IHJldHVybiBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7IHJldHVybiBjYj8uKG9iaiwgbnVsbCBhcyBhbnksIG51bGwsIG51bGwpOyB9KTsgfVxuICAgIGlmICh0eXBlb2Ygb2JqPy5bJGFmZmVjdGVkXSA9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgcmV0dXJuIG9iaj8uWyRhZmZlY3RlZF0/LihjYiwgcHJvcCwgY3R4KTtcbiAgICB9IGVsc2VcbiAgICBpZiAoY2hlY2tWYWxpZE9iaihvYmopKSB7XG4gICAgICAgIGNvbnN0IHdyYXBwZWQgPSBvYmo7XG4gICAgICAgIG9iaiA9IG9iaj8uWyRleHRyYWN0S2V5JF0gPz8gb2JqO1xuICAgICAgICBpZiAoc3BlY2lhbGl6ZWRTdWJzY3JpYmU/Lmhhcz8uKG9iaikpIHtcbiAgICAgICAgICAgIHJldHVybiBzcGVjaWFsaXplZFN1YnNjcmliZT8uZ2V0Py4ob2JqKT8uKHdyYXBwZWQsIHByb3AsIGNiLCBjdHgpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9cbiAgICAgICAgaWYgKGlzT2JzZXJ2YWJsZSh3cmFwcGVkKSB8fCAoY2hlY2tJc1BhaXJlZChvYmopICYmIGlzT2JzZXJ2YWJsZShvYmo/LlswXSkpKSB7XG4gICAgICAgICAgICAvLyB3aGVuIG5vIGV4aXN0cywgYWRkIGEgbmV3IHNwZWNpYWxpemVkIHN1YnNjcmliZSBmdW5jdGlvblxuICAgICAgICAgICAgaWYgKGlzVGhlbmFibGUob2JqKSkgLy9AdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgeyByZXR1cm4gc3BlY2lhbGl6ZWRTdWJzY3JpYmU/LmdldE9ySW5zZXJ0Py4ob2JqLCBzdWJzY3JpYmVUaGVuYWJsZSk/LihvYmosIHByb3AsIGNiLCBjdHgpOyB9IGVsc2VcbiAgICAgICAgICAgIGlmIChjaGVja0lzUGFpcmVkKG9iaikpICAvL0B0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICB7IHJldHVybiBzcGVjaWFsaXplZFN1YnNjcmliZT8uZ2V0T3JJbnNlcnQ/LihvYmosIHN1YnNjcmliZVBhaXJlZCk/LihvYmosIHByb3AsIGNiLCBjdHgpOyB9IGVsc2VcbiAgICAgICAgICAgIGlmICh0eXBlb2YgSFRNTElucHV0RWxlbWVudCAhPSBcInVuZGVmaW5lZFwiICYmIG9iaiBpbnN0YW5jZW9mIEhUTUxJbnB1dEVsZW1lbnQpICAvL0B0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICB7IHJldHVybiBzcGVjaWFsaXplZFN1YnNjcmliZT8uZ2V0T3JJbnNlcnQ/LihvYmosIHN1YnNjcmliZUlucHV0KT8uKG9iaiwgcHJvcCwgY2IsIGN0eCk7IH0gZWxzZSAgLy9AdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgeyByZXR1cm4gc3BlY2lhbGl6ZWRTdWJzY3JpYmU/LmdldE9ySW5zZXJ0Py4ob2JqLCBzdWJzY3JpYmVEaXJlY3RseSk/Lih3cmFwcGVkLCBwcm9wLCBjYiwgY3R4KTsgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHF1ZXVlTWljcm90YXNrKCgpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoY2hlY2tJc1BhaXJlZChvYmopKSB7IHJldHVybiBjYWxsQnlQcm9wPy4ob2JqPy5bMF0sIG9iaj8uWzFdIGFzIGFueSwgY2IsIGN0eCk7IH1cbiAgICAgICAgICAgICAgICBpZiAocHJvcCAhPSBudWxsICYmIHByb3AgIT0gU3ltYm9sLml0ZXJhdG9yKSB7IHJldHVybiBjYWxsQnlQcm9wPy4ob2JqLCBwcm9wLCBjYiwgY3R4KTsgfVxuICAgICAgICAgICAgICAgIHJldHVybiBjYWxsQnlBbGxQcm9wPy4ob2JqLCBjYiwgY3R4KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxufTtcblxuLy9cbmV4cG9ydCBjb25zdCBtYWtlQXJyYXlPYnNlcnZhYmxlID0gKHRnKT0+e1xuICAgIGlmICh0ZyBpbnN0YW5jZW9mIFNldCkgcmV0dXJuIG9ic2VydmFibGVCeVNldCh0Zyk7XG4gICAgaWYgKHRnIGluc3RhbmNlb2YgTWFwKSByZXR1cm4gb2JzZXJ2YWJsZUJ5TWFwKHRnKTtcbiAgICByZXR1cm4gdGc7XG59XG5cbi8vXG5leHBvcnQgY2xhc3MgRG91YmxlV2Vha01hcCB7XG4gICAgI3RvcCA9IG5ldyBXZWFrTWFwKCk7IC8vIGtleTEgLT4gV2Vha01hcChrZXkyIC0+IHZhbHVlKVxuICBcbiAgICAjZW5zdXJlSW5uZXIoa2V5MSkge1xuICAgICAgICBsZXQgaW5uZXIgPSB0aGlzLiN0b3AuZ2V0KGtleTEpO1xuICAgICAgICBpZiAoIWlubmVyKSB7XG4gICAgICAgICAgICBpbm5lciA9IG5ldyBXZWFrTWFwKCk7XG4gICAgICAgICAgICB0aGlzLiN0b3Auc2V0KGtleTEsIGlubmVyKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaW5uZXI7XG4gICAgfVxuICBcbiAgICAjc3BsaXRQYWlyKHBhaXIpIHtcbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHBhaXIpIHx8IHBhaXIubGVuZ3RoICE9PSAyKSB7XG4gICAgICAgICAgICAvL3Rocm93IG5ldyBUeXBlRXJyb3IoXCJLZXkgbXVzdCBiZSBhIHBhaXI6IFtrZXlMMSwga2V5TDJdXCIpO1xuICAgICAgICAgICAgcmV0dXJuIFtudWxsLCBudWxsXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcGFpcjtcbiAgICB9XG5cbiAgICBoYXNMMShrZXkxKSB7XG4gICAgICAgIHJldHVybiB0aGlzLiN0b3AuaGFzKGtleTEpO1xuICAgIH1cbiAgXG4gICAgc2V0KHBhaXIsIHZhbHVlKSB7XG4gICAgICAgIGNvbnN0IFtrZXkxLCBrZXkyXSA9IHRoaXMuI3NwbGl0UGFpcihwYWlyKTtcbiAgICAgICAgdGhpcy4jZW5zdXJlSW5uZXIoa2V5MSkuc2V0KGtleTIsIHZhbHVlKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICBcbiAgICBnZXQocGFpcikge1xuICAgICAgICBjb25zdCBba2V5MSwga2V5Ml0gPSB0aGlzLiNzcGxpdFBhaXIocGFpcik7XG4gICAgICAgIHJldHVybiB0aGlzLiN0b3AuZ2V0KGtleTEpPy5nZXQoa2V5Mik7XG4gICAgfVxuICBcbiAgICBoYXMocGFpcikge1xuICAgICAgICBjb25zdCBba2V5MSwga2V5Ml0gPSB0aGlzLiNzcGxpdFBhaXIocGFpcik7XG4gICAgICAgIHJldHVybiB0aGlzLiN0b3AuZ2V0KGtleTEpPy5oYXMoa2V5MikgPz8gZmFsc2U7XG4gICAgfVxuICBcbiAgICBkZWxldGUocGFpcikge1xuICAgICAgICBjb25zdCBba2V5MSwga2V5Ml0gPSB0aGlzLiNzcGxpdFBhaXIocGFpcik7XG4gICAgICAgIGNvbnN0IGlubmVyID0gdGhpcy4jdG9wLmdldChrZXkxKTtcbiAgICAgICAgcmV0dXJuIGlubmVyID8gaW5uZXIuZGVsZXRlKGtleTIpIDogZmFsc2U7XG4gICAgfVxuICBcbiAgICBkZWxldGVUb3Aoa2V5MSkge1xuICAgICAgICByZXR1cm4gdGhpcy4jdG9wLmRlbGV0ZShrZXkxKTtcbiAgICB9XG4gIFxuICAgIC8vINCj0LbQtSDQsdGL0LvQvjog0YPQvdC40LLQtdGA0YHQsNC70YzQvdGL0LkgZ2V0LW9yLWNyZWF0ZSAo0YHQuNC90L7QvdC40LzQvdC+INC70L7Qs9C40LrQtSBcImNvbXB1dGVkXCIpXG4gICAgZ2V0T3JDcmVhdGUocGFpciwgZmFjdG9yeSkge1xuICAgICAgICBjb25zdCBba2V5MSwga2V5Ml0gPSB0aGlzLiNzcGxpdFBhaXIocGFpcik7XG4gICAgICAgIGNvbnN0IGlubmVyID0gdGhpcy4jZW5zdXJlSW5uZXIoa2V5MSk7XG4gICAgXG4gICAgICAgIGlmIChpbm5lci5oYXMoa2V5MikpIHJldHVybiBpbm5lci5nZXQoa2V5Mik7XG4gICAgXG4gICAgICAgIGNvbnN0IHZhbHVlID0gZmFjdG9yeSgpO1xuICAgICAgICBpbm5lci5zZXQoa2V5MiwgdmFsdWUpO1xuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICBcbiAgICAvLyBnZXRPckluc2VydDog0LXRgdC70Lgg0L3QtdGCIOKAlCDQstGB0YLQsNCy0LjRgtGMICrQv9C10YDQtdC00LDQvdC90L7QtSog0LfQvdCw0YfQtdC90LjQtSAo0LHQtdC3INCy0YvRh9C40YHQu9C10L3QuNGPKVxuICAgIGdldE9ySW5zZXJ0KHBhaXIsIHZhbHVlKSB7XG4gICAgICAgIGNvbnN0IFtrZXkxLCBrZXkyXSA9IHRoaXMuI3NwbGl0UGFpcihwYWlyKTtcbiAgICAgICAgY29uc3QgaW5uZXIgPSB0aGlzLiNlbnN1cmVJbm5lcihrZXkxKTtcbiAgICBcbiAgICAgICAgaWYgKGlubmVyLmhhcyhrZXkyKSkgcmV0dXJuIGlubmVyLmdldChrZXkyKTtcbiAgICBcbiAgICAgICAgaW5uZXIuc2V0KGtleTIsIHZhbHVlKTtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgXG4gICAgLy8gZ2V0T3JJbnNlcnRDb21wdXRlZDog0LXRgdC70Lgg0L3QtdGCIOKAlCDQstGL0YfQuNGB0LvQuNGC0Ywg0YfQtdGA0LXQtyBmbihwYWlyKSDQuCDQstGB0YLQsNCy0LjRgtGMXG4gICAgLy8gKNGD0LTQvtCx0L3Qviwg0LrQvtCz0LTQsCDQvdCw0LTQviDQuNGB0L/QvtC70YzQt9C+0LLQsNGC0Ywg0LrQu9GO0YfQuCDQsiDQstGL0YfQuNGB0LvQtdC90LjQuClcbiAgICBnZXRPckluc2VydENvbXB1dGVkKHBhaXIsIGNvbXB1dGUpIHtcbiAgICAgICAgY29uc3QgW2tleTEsIGtleTJdID0gdGhpcy4jc3BsaXRQYWlyKHBhaXIpO1xuICAgICAgICBjb25zdCBpbm5lciA9IHRoaXMuI2Vuc3VyZUlubmVyKGtleTEpO1xuICAgIFxuICAgICAgICBpZiAoaW5uZXIuaGFzKGtleTIpKSByZXR1cm4gaW5uZXIuZ2V0KGtleTIpO1xuICAgIFxuICAgICAgICBjb25zdCB2YWx1ZSA9IGNvbXB1dGUoW2tleTEsIGtleTJdKTtcbiAgICAgICAgaW5uZXIuc2V0KGtleTIsIHZhbHVlKTtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbn1cblxuLy9cbmNvbnN0IHJlZ2lzdGVyZWRJdGVyYXRlZCA9IG5ldyBEb3VibGVXZWFrTWFwKCk7XG5cbi8vXG5leHBvcnQgY29uc3QgaXRlcmF0ZWQgPSA8VCA9IGFueT4odGc6IHN1YlZhbGlkPFQ+LCBjYjogKHZhbHVlOiBhbnksIHByb3A6IGtleVR5cGUsIG9sZD86IGFueSwgb3BlcmF0aW9uPzogc3RyaW5nfG51bGwpID0+IHZvaWQsIGN0eDogYW55IHwgbnVsbCA9IG51bGwpPT57XG4gICAgaWYgKCF0ZykgcmV0dXJuO1xuXG4gICAgLy9cbiAgICBpZiAocmVnaXN0ZXJlZEl0ZXJhdGVkLmhhcyhbdGcsIGNiXSkpIHsgcmV0dXJuIHJlZ2lzdGVyZWRJdGVyYXRlZC5nZXQoW3RnLCBjYl0pOyB9XG5cbiAgICAvL1xuICAgIGNvbnN0ICRzdWIgPSAodmFsdWU6IGFueSwgbmFtZToga2V5VHlwZSwgb2xkPzogYW55KSA9PiB7XG4gICAgICAgIGlmIChuYW1lID09IFwidmFsdWVcIikge1xuICAgICAgICAgICAgLy9UT0RPOiBuZWVkcyBub3RpZnksIHRoYXQgZWxlbWVudHMgb2YgYXJyYXlvbGQgaXMgcmVtb3ZlZFxuICAgICAgICAgICAgY29uc3QgZW50cmllcyA9IChvbGQ/LnZhbHVlID8/IG9sZCk/LmVudHJpZXM/LigpO1xuICAgICAgICAgICAgY29uc3QgYmFzaXMgPSAodGcgYXMgYW55KT8udmFsdWUgPz8gdmFsdWU/LnZhbHVlID8/IHZhbHVlO1xuXG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgaWYgKGVudHJpZXMpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IFtpZHgsIGl0ZW1dIG9mIGVudHJpZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2ZPbGQgPSBpdGVtID8/ICgob2xkPy52YWx1ZSA/PyBvbGQpPy5baWR4XSA/PyBudWxsKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2ZOZXcgPSBiYXNpcz8uW2lkeF07XG4gICAgICAgICAgICAgICAgICAgIGlmIChvZk9sZCA9PSBudWxsICYmIG9mTmV3ICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNiKG9mTmV3LCBpZHgsIG51bGwsIFwiQGFkZFwiKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvZk9sZCAhPSBudWxsICYmIG9mTmV3ID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNiKG51bGwsIGlkeCwgb2ZPbGQsIFwiQGRlbGV0ZVwiKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc05vdEVxdWFsKG9mT2xkLCBvZk5ldykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNiKG9mTmV3LCBpZHgsIG9mT2xkLCBcIkBzZXRcIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICByZXR1cm4gaXRlcmF0ZWQodmFsdWUgPz8gKHRnIGFzIGFueSk/LnZhbHVlLCAodmFsdWUsIHByb3AsIG9sZCwgb3BlcmF0aW9uKSA9PiB7XG4gICAgICAgICAgICAgICAgY2IodmFsdWUsIHByb3AsIG9sZCwgb3BlcmF0aW9uKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0Z1tuYW1lXTtcbiAgICB9XG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcmV0dXJuIHJlZ2lzdGVyZWRJdGVyYXRlZC5nZXRPckluc2VydENvbXB1dGVkKFt0ZywgY2JdLCAoKSA9PiB7XG4gICAgICAgIGlmICh0ZyBpbnN0YW5jZW9mIFNldCkgeyByZXR1cm4gYWZmZWN0ZWQoW29ic2VydmFibGVCeVNldCh0ZykgYXMgVCwgU3ltYm9sLml0ZXJhdG9yXSwgY2IsIGN0eCk7IH1cbiAgICAgICAgaWYgKHRnIGluc3RhbmNlb2YgTWFwKSB7IHJldHVybiBhZmZlY3RlZCh0ZywgY2IsIGN0eCk7IH1cbiAgICAgICAgaWYgKGhhc1ZhbHVlKHRnKSkgeyByZXR1cm4gYWZmZWN0ZWQodGcsICRzdWIsIGN0eCk7IH1cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGcpICYmICEodGc/Lmxlbmd0aCA9PSAyICYmIGlzS2V5VHlwZSh0Zz8uWzFdKSAmJiBpc09ic2VydmFibGUodGc/LlswXSkpKSB7IHJldHVybiBhZmZlY3RlZChbdGcsIFN5bWJvbC5pdGVyYXRvcl0sIGNiLCBjdHgpOyB9XG4gICAgICAgIHJldHVybiBhZmZlY3RlZCh0ZywgY2IsIGN0eCk7XG4gICAgfSk7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgdW5hZmZlY3RlZCA9IDxUID0gYW55Pih0ZzogVCwgY2I/OiAodmFsdWU6IGFueSwgcHJvcDoga2V5VHlwZSwgb2xkPzogYW55KSA9PiB2b2lkLCBjdHg6IGFueSB8IG51bGwgPSBudWxsKSA9PiB7XG4gICAgcmV0dXJuIHdpdGhQcm9taXNlKHRnLCAodGFyZ2V0OiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgaXNQYWlyID0gQXJyYXkuaXNBcnJheSh0YXJnZXQpICYmIHRhcmdldD8ubGVuZ3RoID09IDIgJiYgW1wib2JqZWN0XCIsIFwiZnVuY3Rpb25cIl0uaW5kZXhPZih0eXBlb2YgdGFyZ2V0Py5bMF0pID49IDAgJiYgaXNLZXlUeXBlKHRhcmdldD8uWzFdKTtcbiAgICAgICAgY29uc3QgcHJvcCA9IGlzUGFpciA/IHRhcmdldD8uWzFdIDogbnVsbDsgdGFyZ2V0ID0gKGlzUGFpciAmJiBwcm9wICE9IG51bGwpID8gKHRhcmdldD8uWzBdID8/IHRhcmdldCkgOiB0YXJnZXQ7XG4gICAgICAgIGNvbnN0IHVud3JhcDogYW55ID0gKHR5cGVvZiB0YXJnZXQgPT0gXCJvYmplY3RcIiB8fCB0eXBlb2YgdGFyZ2V0ID09IFwiZnVuY3Rpb25cIikgPyAodGFyZ2V0Py5bJGV4dHJhY3RLZXkkXSA/PyB0YXJnZXQpIDogdGFyZ2V0O1xuICAgICAgICBsZXQgc2VsZiA9IHRhcmdldD8uWyRyZWdpc3RyeUtleSRdID8/IChzdWJzY3JpcHRSZWdpc3RyeSkuZ2V0KHVud3JhcCk7XG4gICAgICAgIHNlbGY/LnVuYWZmZWN0ZWQ/LihjYiwgcHJvcCk7XG4gICAgfSk7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgYmluZEJ5ID0gPFVuZGVyID0gYW55Pih0YXJnZXQsIHJlYWN0aXZlOiBzdWJWYWxpZDxVbmRlcj4sIHdhdGNoPykgPT4ge1xuICAgIGFmZmVjdGVkKHJlYWN0aXZlLCBudWxsLCAodiwgcCkgPT4geyBvYmplY3RBc3NpZ24odGFyZ2V0LCB2LCBwLCB0cnVlKTsgfSk7XG4gICAgd2F0Y2g/LigoKSA9PiB0YXJnZXQsIChOKSA9PiB7IGZvciAoY29uc3QgayBpbiBOKSB7IG9iamVjdEFzc2lnbihyZWFjdGl2ZSwgTltrXSwgaywgdHJ1ZSk7IH0gfSwgeyBkZWVwOiB0cnVlIH0pO1xuICAgIHJldHVybiB0YXJnZXQ7XG59O1xuXG4vL1xuZXhwb3J0IGNvbnN0IGRlcml2YXRlID0gPFVuZGVyID0gYW55LCBUID0gb2JzZXJ2ZVZhbGlkPFVuZGVyPj4oZnJvbSwgcmVhY3RGbjogKHZhbHVlOiBhbnkpID0+IGFueSwgd2F0Y2g/KSA9PiBiaW5kQnkocmVhY3RGbihzYWZlKGZyb20pKSwgZnJvbSwgd2F0Y2gpO1xuZXhwb3J0IGNvbnN0IGJpbmRCeUtleSA9IDxVbmRlciA9IGFueT4odGFyZ2V0LCByZWFjdGl2ZTogc3ViVmFsaWQ8VW5kZXI+LCBrZXkgPSAoKSA9PiBcIlwiKSA9PiBhZmZlY3RlZChyZWFjdGl2ZSwgbnVsbCwgKHZhbHVlLCBwKSA9PiB7IGlmIChwID09IGtleSgpKSB7IG9iamVjdEFzc2lnbih0YXJnZXQsIHZhbHVlLCBudWxsLCB0cnVlKTsgfSB9KTtcbiJdfQ==
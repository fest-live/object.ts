import { defaultByType, isPrimitive, $triggerLock, tryParseByHint, isArrayInvalidKey } from "fest/core";
import { $value, $behavior, $promise, $extractKey$, $affected, $trigger } from "../wrap/Symbol";
import { addToCallChain, deref } from "../wrap/Utils";
import { $isObservable, observeArray, observeMap, observeObject, observeSet } from "./Specific";
import { subscriptRegistry } from "./Subscript";
import { affected } from "./Mainline";
import { hasValue } from "fest/core";
//
export const numberRef = (initial, behavior) => {
    const isPromise = initial instanceof Promise || typeof initial?.then == "function";
    const obj = {
        [$promise]: isPromise ? initial : null,
        [$value]: isPromise ? 0 : (Number(deref(initial) || 0) || 0),
        [$behavior]: behavior,
        [Symbol?.toStringTag]() { return String(this?.[$value] ?? "") || ""; },
        [Symbol?.toPrimitive](hint) { return tryParseByHint((typeof this?.[$value] != "object" ? this?.[$value] : (this?.[$value]?.value || 0)) ?? 0, hint); },
        set value(v) { this[$value] = ((v != null && !Number.isNaN(v)) ? Number(v) : this[$value]) || 0; },
        get value() { return Number(this[$value] || 0) || 0; }
    };
    const $r = observe(obj);
    initial?.then?.((v) => $r.value = v);
    return $r;
};
//
export const stringRef = (initial, behavior) => {
    const isPromise = initial instanceof Promise || typeof initial?.then == "function";
    const obj = {
        [$promise]: isPromise ? initial : null,
        [$value]: (isPromise ? "" : String(deref(typeof initial == "number" ? String(initial) : (initial || "")))) ?? "",
        [$behavior]: behavior,
        [Symbol?.toStringTag]() { return String(this?.[$value] ?? "") ?? ""; },
        [Symbol?.toPrimitive](hint) { return tryParseByHint(this?.[$value] ?? "", hint); },
        set value(v) { this[$value] = String(typeof v == "number" ? String(v) : (v || "")) ?? ""; },
        get value() { return String(this[$value] ?? "") ?? ""; },
    };
    const $r = observe(obj);
    initial?.then?.((v) => $r.value = v);
    return $r;
};
//
export const booleanRef = (initial, behavior) => {
    const isPromise = initial instanceof Promise || typeof initial?.then == "function";
    const obj = {
        [$promise]: isPromise ? initial : null,
        [$value]: (isPromise ? false : ((deref(initial) != null ? (typeof deref(initial) == "string" ? true : !!deref(initial)) : false) || false)) || false,
        [$behavior]: behavior,
        [Symbol?.toStringTag]() { return String(this?.[$value] ?? "") || ""; },
        [Symbol?.toPrimitive](hint) { return tryParseByHint(!!this?.[$value] || false, hint); },
        set value(v) { this[$value] = (v != null ? (typeof v == "string" ? true : !!v) : this[$value]) || false; },
        get value() { return this[$value] || false; }
    };
    const $r = observe(obj);
    initial?.then?.((v) => $r.value = v);
    return $r;
};
//
export const wrapRef = (initial, behavior) => {
    const isPromise = initial instanceof Promise || typeof initial?.then == "function";
    const obj = {
        [$promise]: isPromise ? initial : null,
        [$behavior]: behavior,
        [Symbol?.toStringTag]() { return String(this.value ?? "") || ""; },
        [Symbol?.toPrimitive](hint) { return tryParseByHint(this.value, hint); },
        value: isPromise ? null : deref(initial)
    };
    const $r = observe(obj);
    initial?.then?.((v) => $r.value = v);
    affected(initial, (v) => { /*wr?.deref?.()*/ $r?.[$trigger]?.(); });
    return $r;
};
//
export const propRef = (src, srcProp = "value", initial, behavior) => {
    if (isPrimitive(src) || !src)
        return src;
    //
    if (Array.isArray(src) && !isArrayInvalidKey(src?.[1], src) && (Array.isArray(src?.[0]) || typeof src?.[0] == "object" || typeof src?.[0] == "function")) {
        src = src?.[0];
    }
    ;
    //
    if ((srcProp ??= Array.isArray(src) ? null : "value") == null || isArrayInvalidKey(srcProp, src)) {
        return;
    }
    // isn't needed to proxy reactive value, it's already reactive
    if (srcProp && hasValue(src?.[srcProp]) && isObservable(src?.[srcProp])) {
        return recoverReactive(src?.[srcProp]);
    }
    // legally use in LUR.E/GLit properties
    if (srcProp && typeof src?.getProperty == "function" && isObservable(src?.getProperty?.(srcProp))) {
        return src?.getProperty?.(srcProp);
    }
    // is regular object, isn't can be reactive (or reactive one-directional, not duplex), just return the value directly
    //if (srcProp && !isObservable(src)) { return src?.[srcProp]; } // commented line means enabled one directional reactivity
    //if (isReactive(src)) { src = recoverReactive(src); }; // recover no necessary, subscribe already checks if reactive
    // truly reflective for object property key/index
    const r = observe({
        [$value]: (src[srcProp] ??= initial ?? src[srcProp]),
        [$behavior]: behavior,
        [Symbol?.toStringTag]() { return String(src?.[srcProp] ?? this[$value] ?? "") || ""; },
        [Symbol?.toPrimitive](hint) { return tryParseByHint(src?.[srcProp], hint); },
        set value(v) { r[$triggerLock] = true; src[srcProp] = (this[$value] = v ?? defaultByType(src[srcProp])); r[$triggerLock] = false; },
        get value() { return (this[$value] = src?.[srcProp] ?? this[$value]); }
    });
    // a reason, why regular objects isn't reactive directly, and may be single directional
    // from 09.02.2026, do more aggresively reactive the source object
    const usb = affected(src, (v) => { r?.[$trigger]?.(); /*r.value = src?.[srcProp] ?? r?.[$value];*/ });
    addToCallChain(r, Symbol.dispose, usb);
    return r;
};
//
export const $ref = (typed, behavior) => {
    switch (typeof typed) {
        case "boolean": return booleanRef(typed, behavior);
        case "number": return numberRef(typed, behavior);
        case "string": return stringRef(typed, behavior);
        case "object": if (typed != null) {
            return wrapRef(observe(typed), behavior);
        }
        default: return wrapRef(typed, behavior);
    }
};
//
export const ref = (typed, prop = "value", behavior) => {
    // 1. Ensure we have an observable or ref for the input
    const $r = isObservable(typed)
        ? typed
        : $ref(typed, behavior);
    // 2. If a prop is given, get a ref to that prop, otherwise use the value as is
    if (prop != null) {
        // propRef always returns a refType<X> or observeValid<X>
        // We cannot guarantee T extends prop type. So just return as best match
        return propRef($r, prop, behavior);
    }
    else {
        return $r;
    }
};
//
export const promised = (promise, behavior) => {
    return ref(promise, behavior);
};
//
export const triggerWithDelay = (ref, cb, delay = 100) => { if (ref?.value ?? ref) {
    return setTimeout(() => { if (ref.value)
        cb?.(); }, delay);
} };
//
export const delayedBehavior = (delay = 100) => {
    return (cb, [val], [sig]) => { let tm = triggerWithDelay(val, cb, delay); sig?.addEventListener?.("abort", () => { if (tm)
        clearTimeout(tm); }, { once: true }); };
};
//
export const delayedOrInstantBehavior = (delay = 100) => {
    return (cb, [val], [sig]) => { let tm = triggerWithDelay(val, cb, delay); sig?.addEventListener?.("abort", () => { if (tm)
        clearTimeout(tm); }, { once: true }); if (!tm) {
        cb?.();
    } ; };
};
//
export const observe = (target, stateName) => {
    if (target == null || typeof target == "symbol" || !(typeof target == "object" || typeof target == "function") || $isObservable(target)) {
        return target;
    }
    //
    if ((target = deref?.(target)) == null || target instanceof Promise || target instanceof WeakRef || $isObservable(target)) {
        return target; // promise forbidden
    }
    //
    const unwrap = target;
    if (unwrap == null ||
        typeof unwrap == "symbol" || !(typeof unwrap == "object" || typeof unwrap == "function") ||
        unwrap instanceof Promise || unwrap instanceof WeakRef) {
        return unwrap;
    }
    ;
    //
    let reactive = unwrap;
    if (Array.isArray(unwrap)) {
        reactive = observeArray(unwrap);
        return reactive;
    }
    else if (unwrap instanceof Map) {
        reactive = observeMap(unwrap);
        return reactive;
    }
    else if (unwrap instanceof Set) {
        reactive = observeSet(unwrap);
        return reactive;
    }
    else if (typeof unwrap == "function" || typeof unwrap == "object") {
        reactive = observeObject(unwrap);
        return reactive;
    }
    return reactive;
};
//
export const isObservable = (target) => {
    if (typeof HTMLInputElement != "undefined" && target instanceof HTMLInputElement) {
        return true;
    }
    return !!((typeof target == "object" || typeof target == "function") && target != null && (target?.[$extractKey$] || target?.[$affected] || subscriptRegistry?.has?.(target)));
};
//
export const recoverReactive = (target) => {
    return isObservable(target) ? observe(target) : null;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHJpbWl0aXZlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlByaW1pdGl2ZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGFBQWEsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxpQkFBaUIsRUFBZ0IsTUFBTSxXQUFXLENBQUM7QUFDdEgsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDaEcsT0FBTyxFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQW1DLE1BQU0sZUFBZSxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQUUsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ2hHLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUVoRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFnQnJDLEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxTQUFTLEdBQUcsQ0FBQyxPQUErQyxFQUFFLFFBQWMsRUFBbUIsRUFBRTtJQUMxRyxNQUFNLFNBQVMsR0FBRyxPQUFPLFlBQVksT0FBTyxJQUFJLE9BQVEsT0FBc0MsRUFBRSxJQUFJLElBQUksVUFBVSxDQUFDO0lBQ25ILE1BQU0sR0FBRyxHQUFvQjtRQUN6QixDQUFDLFFBQVEsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUUsT0FBc0MsQ0FBQyxDQUFDLENBQUMsSUFBa0M7UUFDcEcsQ0FBQyxNQUFNLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1RCxDQUFDLFNBQVMsQ0FBQyxFQUFFLFFBQVE7UUFDckIsQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLEtBQUssT0FBTyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN0RSxDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQyxJQUFTLElBQUksT0FBTyxjQUFjLENBQUMsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzSixJQUFJLEtBQUssQ0FBQyxDQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkcsSUFBSSxLQUFLLEtBQUssT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDekQsQ0FBQztJQUNGLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQWtDLENBQUM7SUFBRSxPQUFzQyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQSxFQUFFLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQUMsT0FB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Q3BCLENBQUMsQ0FBQTtBQUVELEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsQ0FBQyxNQUFXLEVBQUUsRUFBRTtJQUN4QyxJQUFJLE9BQU8sZ0JBQWdCLElBQUksV0FBVyxJQUFJLE1BQU0sWUFBWSxnQkFBZ0IsRUFBRSxDQUFDO1FBQUMsT0FBTyxJQUFJLENBQUM7SUFBQyxDQUFDO0lBQ2xHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLE1BQU0sSUFBSSxRQUFRLElBQUksT0FBTyxNQUFNLElBQUksVUFBVSxDQUFDLElBQUksTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFlBQVksQ0FBQyxJQUFJLE1BQU0sRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLGlCQUFpQixFQUFFLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuTCxDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sZUFBZSxHQUFHLENBQUMsTUFBVyxFQUFPLEVBQUU7SUFDaEQsT0FBTyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ3pELENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGRlZmF1bHRCeVR5cGUsIGlzUHJpbWl0aXZlLCAkdHJpZ2dlckxvY2ssIHRyeVBhcnNlQnlIaW50LCBpc0FycmF5SW52YWxpZEtleSwgdHlwZSBrZXlUeXBlIH0gZnJvbSBcImZlc3QvY29yZVwiO1xuaW1wb3J0IHsgJHZhbHVlLCAkYmVoYXZpb3IsICRwcm9taXNlLCAkZXh0cmFjdEtleSQsICRhZmZlY3RlZCwgJHRyaWdnZXIgfSBmcm9tIFwiLi4vd3JhcC9TeW1ib2xcIjtcbmltcG9ydCB7IGFkZFRvQ2FsbENoYWluLCBkZXJlZiwgdHlwZSBvYnNlcnZlVmFsaWQsIHR5cGUgV2Vha0tleSB9IGZyb20gXCIuLi93cmFwL1V0aWxzXCI7XG5pbXBvcnQgeyAkaXNPYnNlcnZhYmxlLCBvYnNlcnZlQXJyYXksIG9ic2VydmVNYXAsIG9ic2VydmVPYmplY3QsIG9ic2VydmVTZXQgfSBmcm9tIFwiLi9TcGVjaWZpY1wiO1xuaW1wb3J0IHsgc3Vic2NyaXB0UmVnaXN0cnkgfSBmcm9tIFwiLi9TdWJzY3JpcHRcIjtcbmltcG9ydCB7IE1ldGhvZHNPZiB9IGZyb20gXCIuLi93cmFwL1V0aWxzXCI7XG5pbXBvcnQgeyBhZmZlY3RlZCB9IGZyb20gXCIuL01haW5saW5lXCI7XG5pbXBvcnQgeyBoYXNWYWx1ZSB9IGZyb20gXCJmZXN0L2NvcmVcIjtcblxuLy9cbmV4cG9ydCBpbnRlcmZhY2UgcmVmV3JhcDxUID0gYW55PiB7XG4gICAgWyRwcm9taXNlXT86IFByb21pc2U8VD58bnVsbHx1bmRlZmluZWQ7XG4gICAgWyRiZWhhdmlvcl0/OiBhbnk7XG4gICAgW1N5bWJvbC50b1N0cmluZ1RhZ10/KCk6IHN0cmluZztcbiAgICBbU3ltYm9sLnRvUHJpbWl0aXZlXT8oaGludDogYW55KTogYW55O1xuICAgIFskdmFsdWVdPzogVDtcbiAgICBzZXQgdmFsdWUodjogVHxudWxsfHVuZGVmaW5lZCk7XG4gICAgZ2V0IHZhbHVlKCk6IFR8bnVsbHx1bmRlZmluZWQ7XG59XG5cbi8vXG5leHBvcnQgdHlwZSByZWZUeXBlPFQgPSBhbnk+ID0gKHJlZldyYXA8VD4gfCAoVCBleHRlbmRzIG9iamVjdCA/IFQgOiBhbnkpKSAmIE1ldGhvZHNPZjxUPiAmIChUIGV4dGVuZHMgc3ltYm9sIHwgb2JqZWN0IHwgRnVuY3Rpb24gPyBUIDogYW55KTtcblxuLy9cbmV4cG9ydCBjb25zdCBudW1iZXJSZWYgPSAoaW5pdGlhbD86IG51bWJlcnxudWxsfHVuZGVmaW5lZHxQcm9taXNlPG51bWJlcj4sIGJlaGF2aW9yPzogYW55KTogcmVmVHlwZTxudW1iZXI+ID0+IHtcbiAgICBjb25zdCBpc1Byb21pc2UgPSBpbml0aWFsIGluc3RhbmNlb2YgUHJvbWlzZSB8fCB0eXBlb2YgKGluaXRpYWwgYXMgdW5rbm93biBhcyBQcm9taXNlPG51bWJlcj4pPy50aGVuID09IFwiZnVuY3Rpb25cIjtcbiAgICBjb25zdCBvYmo6IHJlZldyYXA8bnVtYmVyPiA9IHtcbiAgICAgICAgWyRwcm9taXNlXTogaXNQcm9taXNlID8gKGluaXRpYWwgYXMgdW5rbm93biBhcyBQcm9taXNlPG51bWJlcj4pIDogbnVsbCBhcyB1bmtub3duIGFzIFByb21pc2U8bnVtYmVyPixcbiAgICAgICAgWyR2YWx1ZV06IGlzUHJvbWlzZSA/IDAgOiAoTnVtYmVyKGRlcmVmKGluaXRpYWwpIHx8IDApIHx8IDApLFxuICAgICAgICBbJGJlaGF2aW9yXTogYmVoYXZpb3IsXG4gICAgICAgIFtTeW1ib2w/LnRvU3RyaW5nVGFnXSgpIHsgcmV0dXJuIFN0cmluZyh0aGlzPy5bJHZhbHVlXSA/PyBcIlwiKSB8fCBcIlwiOyB9LFxuICAgICAgICBbU3ltYm9sPy50b1ByaW1pdGl2ZV0oaGludDogYW55KSB7IHJldHVybiB0cnlQYXJzZUJ5SGludCgodHlwZW9mIHRoaXM/LlskdmFsdWVdICE9IFwib2JqZWN0XCIgPyB0aGlzPy5bJHZhbHVlXSA6ICh0aGlzPy5bJHZhbHVlXT8udmFsdWUgfHwgMCkpID8/IDAsIGhpbnQpOyB9LFxuICAgICAgICBzZXQgdmFsdWUodjogYW55KSB7IHRoaXNbJHZhbHVlXSA9ICgodiAhPSBudWxsICYmICFOdW1iZXIuaXNOYU4odikpID8gTnVtYmVyKHYpIDogdGhpc1skdmFsdWVdKSB8fCAwOyB9LFxuICAgICAgICBnZXQgdmFsdWUoKSB7IHJldHVybiBOdW1iZXIodGhpc1skdmFsdWVdIHx8IDApIHx8IDA7IH1cbiAgICB9O1xuICAgIGNvbnN0ICRyID0gb2JzZXJ2ZShvYmopIGFzIG9ic2VydmVWYWxpZDxyZWZUeXBlPG51bWJlcj4+OyAoaW5pdGlhbCBhcyB1bmtub3duIGFzIFByb21pc2U8bnVtYmVyPik/LnRoZW4/Ligodik9PiRyLnZhbHVlID0gdik7IHJldHVybiAkcjtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBzdHJpbmdSZWYgPSAoaW5pdGlhbD86IHN0cmluZ3xudWxsfHVuZGVmaW5lZHxQcm9taXNlPHN0cmluZz4sIGJlaGF2aW9yPzogYW55KTogcmVmVHlwZTxzdHJpbmc+ID0+IHtcbiAgICBjb25zdCBpc1Byb21pc2UgPSBpbml0aWFsIGluc3RhbmNlb2YgUHJvbWlzZSB8fCB0eXBlb2YgKGluaXRpYWwgYXMgdW5rbm93biBhcyBQcm9taXNlPHN0cmluZz4pPy50aGVuID09IFwiZnVuY3Rpb25cIjtcbiAgICBjb25zdCBvYmo6IHJlZldyYXA8c3RyaW5nPiA9IHtcbiAgICAgICAgWyRwcm9taXNlXTogaXNQcm9taXNlID8gKGluaXRpYWwgYXMgdW5rbm93biBhcyBQcm9taXNlPHN0cmluZz4pIDogbnVsbCBhcyB1bmtub3duIGFzIFByb21pc2U8c3RyaW5nPixcbiAgICAgICAgWyR2YWx1ZV06IChpc1Byb21pc2UgPyBcIlwiIDogU3RyaW5nKGRlcmVmKHR5cGVvZiBpbml0aWFsID09IFwibnVtYmVyXCIgPyBTdHJpbmcoaW5pdGlhbCkgOiAoaW5pdGlhbCB8fCBcIlwiKSkpKSA/PyBcIlwiLFxuICAgICAgICBbJGJlaGF2aW9yXTogYmVoYXZpb3IsXG4gICAgICAgIFtTeW1ib2w/LnRvU3RyaW5nVGFnXSgpIHsgcmV0dXJuIFN0cmluZyh0aGlzPy5bJHZhbHVlXSA/PyBcIlwiKSA/PyBcIlwiOyB9LFxuICAgICAgICBbU3ltYm9sPy50b1ByaW1pdGl2ZV0oaGludDogYW55KSB7IHJldHVybiB0cnlQYXJzZUJ5SGludCh0aGlzPy5bJHZhbHVlXSA/PyBcIlwiLCBoaW50KTsgfSxcbiAgICAgICAgc2V0IHZhbHVlKHY6IGFueSkgeyB0aGlzWyR2YWx1ZV0gPSBTdHJpbmcodHlwZW9mIHYgPT0gXCJudW1iZXJcIiA/IFN0cmluZyh2KSA6ICh2IHx8IFwiXCIpKSA/PyBcIlwiOyB9LFxuICAgICAgICBnZXQgdmFsdWUoKSB7IHJldHVybiBTdHJpbmcodGhpc1skdmFsdWVdID8/IFwiXCIpID8/IFwiXCI7IH0sXG4gICAgfTtcbiAgICBjb25zdCAkciA9IG9ic2VydmUob2JqKSBhcyBvYnNlcnZlVmFsaWQ8cmVmVHlwZTxzdHJpbmc+PjsgKGluaXRpYWwgYXMgdW5rbm93biBhcyBQcm9taXNlPHN0cmluZz4pPy50aGVuPy4oKHYpPT4kci52YWx1ZSA9IHYpOyByZXR1cm4gJHI7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgYm9vbGVhblJlZiA9IChpbml0aWFsPzogYm9vbGVhbnxudWxsfHVuZGVmaW5lZHxQcm9taXNlPGJvb2xlYW4+LCBiZWhhdmlvcj86IGFueSk6IHJlZlR5cGU8Ym9vbGVhbj4gPT4ge1xuICAgIGNvbnN0IGlzUHJvbWlzZSA9IGluaXRpYWwgaW5zdGFuY2VvZiBQcm9taXNlIHx8IHR5cGVvZiAoaW5pdGlhbCBhcyB1bmtub3duIGFzIFByb21pc2U8Ym9vbGVhbj4pPy50aGVuID09IFwiZnVuY3Rpb25cIjtcbiAgICBjb25zdCBvYmo6IHJlZldyYXA8Ym9vbGVhbj4gPSB7XG4gICAgICAgIFskcHJvbWlzZV06IGlzUHJvbWlzZSA/IChpbml0aWFsIGFzIHVua25vd24gYXMgUHJvbWlzZTxib29sZWFuPikgOiBudWxsIGFzIHVua25vd24gYXMgUHJvbWlzZTxib29sZWFuPixcbiAgICAgICAgWyR2YWx1ZV06IChpc1Byb21pc2UgPyBmYWxzZSA6ICgoZGVyZWYoaW5pdGlhbCkgIT0gbnVsbCA/ICh0eXBlb2YgZGVyZWYoaW5pdGlhbCkgPT0gXCJzdHJpbmdcIiA/IHRydWUgOiAhIWRlcmVmKGluaXRpYWwpKSA6IGZhbHNlKSB8fCBmYWxzZSkpIHx8IGZhbHNlLFxuICAgICAgICBbJGJlaGF2aW9yXTogYmVoYXZpb3IsXG4gICAgICAgIFtTeW1ib2w/LnRvU3RyaW5nVGFnXSgpIHsgcmV0dXJuIFN0cmluZyh0aGlzPy5bJHZhbHVlXSA/PyBcIlwiKSB8fCBcIlwiOyB9LFxuICAgICAgICBbU3ltYm9sPy50b1ByaW1pdGl2ZV0oaGludDogYW55KSB7IHJldHVybiB0cnlQYXJzZUJ5SGludCghIXRoaXM/LlskdmFsdWVdIHx8IGZhbHNlLCBoaW50KTsgfSxcbiAgICAgICAgc2V0IHZhbHVlKHY6IGFueSkgeyB0aGlzWyR2YWx1ZV0gPSAodiAhPSBudWxsID8gKHR5cGVvZiB2ID09IFwic3RyaW5nXCIgPyB0cnVlIDogISF2KSA6IHRoaXNbJHZhbHVlXSkgfHwgZmFsc2U7IH0sXG4gICAgICAgIGdldCB2YWx1ZSgpIHsgcmV0dXJuIHRoaXNbJHZhbHVlXSB8fCBmYWxzZTsgfVxuICAgIH07XG4gICAgY29uc3QgJHIgPSBvYnNlcnZlKG9iaikgYXMgb2JzZXJ2ZVZhbGlkPHJlZlR5cGU8Ym9vbGVhbj4+OyAoaW5pdGlhbCBhcyB1bmtub3duIGFzIFByb21pc2U8Ym9vbGVhbj4pPy50aGVuPy4oKHYpPT4kci52YWx1ZSA9IHYpOyByZXR1cm4gJHI7XG59XG5cbi8vXG5leHBvcnQgY29uc3Qgd3JhcFJlZiA9IDxUID0gYW55Pihpbml0aWFsPzogVHxudWxsfHVuZGVmaW5lZHxQcm9taXNlPFQ+LCBiZWhhdmlvcj86IGFueSk6IG9ic2VydmVWYWxpZDxyZWZUeXBlPFQ+PiA9PiB7XG4gICAgY29uc3QgaXNQcm9taXNlID0gaW5pdGlhbCBpbnN0YW5jZW9mIFByb21pc2UgfHwgdHlwZW9mIChpbml0aWFsIGFzIHVua25vd24gYXMgUHJvbWlzZTxUPik/LnRoZW4gPT0gXCJmdW5jdGlvblwiO1xuICAgIGNvbnN0IG9iajogcmVmV3JhcDxUPiA9IHtcbiAgICAgICAgWyRwcm9taXNlXTogaXNQcm9taXNlID8gKGluaXRpYWwgYXMgdW5rbm93biBhcyBQcm9taXNlPFQ+KSA6IG51bGwgYXMgdW5rbm93biBhcyBQcm9taXNlPFQ+LFxuICAgICAgICBbJGJlaGF2aW9yXTogYmVoYXZpb3IsXG4gICAgICAgIFtTeW1ib2w/LnRvU3RyaW5nVGFnXSgpIHsgcmV0dXJuIFN0cmluZyh0aGlzLnZhbHVlID8/IFwiXCIpIHx8IFwiXCI7IH0sXG4gICAgICAgIFtTeW1ib2w/LnRvUHJpbWl0aXZlXShoaW50OiBhbnkpIHsgcmV0dXJuIHRyeVBhcnNlQnlIaW50KHRoaXMudmFsdWUsIGhpbnQpOyB9LFxuICAgICAgICB2YWx1ZTogaXNQcm9taXNlID8gbnVsbCA6IGRlcmVmKGluaXRpYWwpXG4gICAgfTtcbiAgICBjb25zdCAkciA9IG9ic2VydmUob2JqKSBhcyBvYnNlcnZlVmFsaWQ8cmVmVHlwZTxUPj47XG4gICAgKGluaXRpYWwgYXMgdW5rbm93biBhcyBQcm9taXNlPFQ+KT8udGhlbj8uKCh2KSA9PiAkci52YWx1ZSA9IHYpO1xuICAgIGFmZmVjdGVkKGluaXRpYWwsICh2KSA9PiB7IC8qd3I/LmRlcmVmPy4oKSovJHI/LlskdHJpZ2dlcl0/LigpOyB9KTtcbiAgICByZXR1cm4gJHI7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgcHJvcFJlZiA9IDxUID0gYW55PihzcmM6IG9ic2VydmVWYWxpZDxUPiwgc3JjUHJvcDoga2V5VHlwZSB8IG51bGwgPSBcInZhbHVlXCIsIGluaXRpYWw/OiBhbnksIGJlaGF2aW9yPzogYW55KTogYW55ID0+IHtcbiAgICBpZiAoaXNQcmltaXRpdmUoc3JjKSB8fCAhc3JjKSByZXR1cm4gc3JjO1xuXG4gICAgLy9cbiAgICBpZiAoQXJyYXkuaXNBcnJheShzcmMpICYmICFpc0FycmF5SW52YWxpZEtleShzcmM/LlsxXSwgc3JjKSAmJiAoQXJyYXkuaXNBcnJheShzcmM/LlswXSkgfHwgdHlwZW9mIHNyYz8uWzBdID09IFwib2JqZWN0XCIgfHwgdHlwZW9mIHNyYz8uWzBdID09IFwiZnVuY3Rpb25cIikpIHsgc3JjID0gc3JjPy5bMF07IH07XG5cbiAgICAvL1xuICAgIGlmICgoc3JjUHJvcCA/Pz0gQXJyYXkuaXNBcnJheShzcmMpID8gbnVsbCA6IFwidmFsdWVcIikgPT0gbnVsbCB8fCBpc0FycmF5SW52YWxpZEtleShzcmNQcm9wLCBzcmMpKSB7IHJldHVybjsgfVxuXG4gICAgLy8gaXNuJ3QgbmVlZGVkIHRvIHByb3h5IHJlYWN0aXZlIHZhbHVlLCBpdCdzIGFscmVhZHkgcmVhY3RpdmVcbiAgICBpZiAoc3JjUHJvcCAmJiBoYXNWYWx1ZShzcmM/LltzcmNQcm9wXSkgJiYgaXNPYnNlcnZhYmxlKHNyYz8uW3NyY1Byb3BdKSkge1xuICAgICAgICByZXR1cm4gcmVjb3ZlclJlYWN0aXZlKHNyYz8uW3NyY1Byb3BdKTtcbiAgICB9XG5cbiAgICAvLyBsZWdhbGx5IHVzZSBpbiBMVVIuRS9HTGl0IHByb3BlcnRpZXNcbiAgICBpZiAoc3JjUHJvcCAmJiB0eXBlb2Ygc3JjPy5nZXRQcm9wZXJ0eSA9PSBcImZ1bmN0aW9uXCIgJiYgaXNPYnNlcnZhYmxlKHNyYz8uZ2V0UHJvcGVydHk/LihzcmNQcm9wKSkpIHtcbiAgICAgICAgcmV0dXJuIHNyYz8uZ2V0UHJvcGVydHk/LihzcmNQcm9wKTtcbiAgICB9XG5cbiAgICAvLyBpcyByZWd1bGFyIG9iamVjdCwgaXNuJ3QgY2FuIGJlIHJlYWN0aXZlIChvciByZWFjdGl2ZSBvbmUtZGlyZWN0aW9uYWwsIG5vdCBkdXBsZXgpLCBqdXN0IHJldHVybiB0aGUgdmFsdWUgZGlyZWN0bHlcbiAgICAvL2lmIChzcmNQcm9wICYmICFpc09ic2VydmFibGUoc3JjKSkgeyByZXR1cm4gc3JjPy5bc3JjUHJvcF07IH0gLy8gY29tbWVudGVkIGxpbmUgbWVhbnMgZW5hYmxlZCBvbmUgZGlyZWN0aW9uYWwgcmVhY3Rpdml0eVxuICAgIC8vaWYgKGlzUmVhY3RpdmUoc3JjKSkgeyBzcmMgPSByZWNvdmVyUmVhY3RpdmUoc3JjKTsgfTsgLy8gcmVjb3ZlciBubyBuZWNlc3NhcnksIHN1YnNjcmliZSBhbHJlYWR5IGNoZWNrcyBpZiByZWFjdGl2ZVxuXG4gICAgLy8gdHJ1bHkgcmVmbGVjdGl2ZSBmb3Igb2JqZWN0IHByb3BlcnR5IGtleS9pbmRleFxuICAgIGNvbnN0IHI6IGFueSA9IG9ic2VydmUoe1xuICAgICAgICBbJHZhbHVlXTogKChzcmMgYXMgYW55KVtzcmNQcm9wXSA/Pz0gaW5pdGlhbCA/PyAoc3JjIGFzIGFueSlbc3JjUHJvcF0pLFxuICAgICAgICBbJGJlaGF2aW9yXTogYmVoYXZpb3IsXG4gICAgICAgIFtTeW1ib2w/LnRvU3RyaW5nVGFnXSgpIHsgcmV0dXJuIFN0cmluZyhzcmM/LltzcmNQcm9wXSA/PyB0aGlzWyR2YWx1ZV0gPz8gXCJcIikgfHwgXCJcIjsgfSxcbiAgICAgICAgW1N5bWJvbD8udG9QcmltaXRpdmVdKGhpbnQ6IGFueSkgeyByZXR1cm4gdHJ5UGFyc2VCeUhpbnQoc3JjPy5bc3JjUHJvcF0sIGhpbnQpOyB9LFxuICAgICAgICBzZXQgdmFsdWUodikgeyByWyR0cmlnZ2VyTG9ja10gPSB0cnVlOyAoc3JjIGFzIGFueSlbc3JjUHJvcF0gPSAodGhpc1skdmFsdWVdID0gdiA/PyBkZWZhdWx0QnlUeXBlKChzcmMgYXMgYW55KVtzcmNQcm9wXSkpOyByWyR0cmlnZ2VyTG9ja10gPSBmYWxzZTsgfSxcbiAgICAgICAgZ2V0IHZhbHVlKCkgeyByZXR1cm4gKHRoaXNbJHZhbHVlXSA9IHNyYz8uW3NyY1Byb3BdID8/IHRoaXNbJHZhbHVlXSk7IH1cbiAgICB9KTtcblxuICAgIC8vIGEgcmVhc29uLCB3aHkgcmVndWxhciBvYmplY3RzIGlzbid0IHJlYWN0aXZlIGRpcmVjdGx5LCBhbmQgbWF5IGJlIHNpbmdsZSBkaXJlY3Rpb25hbFxuICAgIC8vIGZyb20gMDkuMDIuMjAyNiwgZG8gbW9yZSBhZ2dyZXNpdmVseSByZWFjdGl2ZSB0aGUgc291cmNlIG9iamVjdFxuICAgIGNvbnN0IHVzYiA9IGFmZmVjdGVkKHNyYywgKHYpID0+IHsgcj8uWyR0cmlnZ2VyXT8uKCk7IC8qci52YWx1ZSA9IHNyYz8uW3NyY1Byb3BdID8/IHI/LlskdmFsdWVdOyovIH0pO1xuICAgIGFkZFRvQ2FsbENoYWluKHIsIFN5bWJvbC5kaXNwb3NlLCB1c2IpO1xuICAgIHJldHVybiByO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0ICRyZWYgPSA8VCA9IGFueT4odHlwZWQ6IFR8bnVsbHx1bmRlZmluZWR8UHJvbWlzZTxUPiwgYmVoYXZpb3I/OiBhbnkpOiAoVCBleHRlbmRzIG9iamVjdHxGdW5jdGlvbnxzeW1ib2wgPyBvYnNlcnZlVmFsaWQ8VD58cmVmVHlwZTxUPiA6IHJlZlR5cGU8VD4pID0+IHtcbiAgICBzd2l0Y2ggKHR5cGVvZiB0eXBlZCkge1xuICAgICAgICBjYXNlIFwiYm9vbGVhblwiOiByZXR1cm4gYm9vbGVhblJlZih0eXBlZCwgYmVoYXZpb3IpIGFzIHJlZlR5cGU8Ym9vbGVhbj47XG4gICAgICAgIGNhc2UgXCJudW1iZXJcIiA6IHJldHVybiBudW1iZXJSZWYodHlwZWQsIGJlaGF2aW9yKSBhcyByZWZUeXBlPG51bWJlcj47XG4gICAgICAgIGNhc2UgXCJzdHJpbmdcIiA6IHJldHVybiBzdHJpbmdSZWYodHlwZWQsIGJlaGF2aW9yKSBhcyByZWZUeXBlPHN0cmluZz47XG4gICAgICAgIGNhc2UgXCJvYmplY3RcIiA6IGlmICh0eXBlZCAhPSBudWxsKSB7IHJldHVybiB3cmFwUmVmKG9ic2VydmUodHlwZWQpLCBiZWhhdmlvcikgYXMgYW55OyB9XG4gICAgICAgIGRlZmF1bHQ6IHJldHVybiB3cmFwUmVmKHR5cGVkLCBiZWhhdmlvcikgYXMgYW55O1xuICAgIH1cbn1cblxuLy9cbmV4cG9ydCBjb25zdCByZWYgPSA8VCA9IGFueT4oXG4gICAgdHlwZWQ6IFQgfCBudWxsIHwgdW5kZWZpbmVkIHwgUHJvbWlzZTxUPixcbiAgICBwcm9wOiBrZXlUeXBlIHwgbnVsbCA9IFwidmFsdWVcIixcbiAgICBiZWhhdmlvcj86IGFueVxuKTogKFxuICAgIFQgZXh0ZW5kcyBvYmplY3QgfCBGdW5jdGlvbiB8IHN5bWJvbCA/IG9ic2VydmVWYWxpZDxUPiB8IHJlZlR5cGU8VD4gOiByZWZUeXBlPFQ+XG4pICYgKFxuICAgIFQgZXh0ZW5kcyBzeW1ib2wgfCBvYmplY3QgfCBGdW5jdGlvbiA/IFQgOiBhbnlcbikgPT4ge1xuICAgIC8vIDEuIEVuc3VyZSB3ZSBoYXZlIGFuIG9ic2VydmFibGUgb3IgcmVmIGZvciB0aGUgaW5wdXRcbiAgICBjb25zdCAkciA9IGlzT2JzZXJ2YWJsZSh0eXBlZClcbiAgICAgICAgPyAodHlwZWQgYXMgb2JzZXJ2ZVZhbGlkPFQ+KVxuICAgICAgICA6ICgkcmVmKHR5cGVkLCBiZWhhdmlvcikgYXMgb2JzZXJ2ZVZhbGlkPFQ+KTtcbiAgICBcbiAgICAvLyAyLiBJZiBhIHByb3AgaXMgZ2l2ZW4sIGdldCBhIHJlZiB0byB0aGF0IHByb3AsIG90aGVyd2lzZSB1c2UgdGhlIHZhbHVlIGFzIGlzXG4gICAgaWYgKHByb3AgIT0gbnVsbCkge1xuICAgICAgICAvLyBwcm9wUmVmIGFsd2F5cyByZXR1cm5zIGEgcmVmVHlwZTxYPiBvciBvYnNlcnZlVmFsaWQ8WD5cbiAgICAgICAgLy8gV2UgY2Fubm90IGd1YXJhbnRlZSBUIGV4dGVuZHMgcHJvcCB0eXBlLiBTbyBqdXN0IHJldHVybiBhcyBiZXN0IG1hdGNoXG4gICAgICAgIHJldHVybiBwcm9wUmVmKFxuICAgICAgICAgICAgJHIgYXMgdW5rbm93biBhcyByZWZUeXBlPFQ+LFxuICAgICAgICAgICAgcHJvcCxcbiAgICAgICAgICAgIGJlaGF2aW9yXG4gICAgICAgICkgYXMgYW55O1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAkciBhcyBhbnk7XG4gICAgfVxufTtcblxuLy9cbmV4cG9ydCBjb25zdCBwcm9taXNlZCA9IChwcm9taXNlOiBhbnksIGJlaGF2aW9yPzogYW55KSA9PiB7XG4gICAgcmV0dXJuIHJlZihwcm9taXNlLCBiZWhhdmlvcik7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgdHJpZ2dlcldpdGhEZWxheSA9IChyZWY6IGFueSwgY2I6IEZ1bmN0aW9uLCBkZWxheSA9IDEwMCk6IFJldHVyblR5cGU8dHlwZW9mIHNldFRpbWVvdXQ+IHwgdW5kZWZpbmVkID0+IHsgaWYgKHJlZj8udmFsdWUgPz8gcmVmKSB7IHJldHVybiBzZXRUaW1lb3V0KCgpPT57IGlmIChyZWYudmFsdWUpIGNiPy4oKTsgfSwgZGVsYXkpOyB9IH1cblxuLy9cbmV4cG9ydCBjb25zdCBkZWxheWVkQmVoYXZpb3IgID0gKGRlbGF5ID0gMTAwKSA9PiB7XG4gICAgcmV0dXJuIChjYjogRnVuY3Rpb24sIFt2YWxdLCBbc2lnXSkgPT4geyBsZXQgdG0gPSB0cmlnZ2VyV2l0aERlbGF5KHZhbCwgY2IsIGRlbGF5KTsgc2lnPy5hZGRFdmVudExpc3RlbmVyPy4oXCJhYm9ydFwiLCAoKT0+eyBpZiAodG0pIGNsZWFyVGltZW91dCh0bSk7IH0sIHsgb25jZTogdHJ1ZSB9KTsgfTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBkZWxheWVkT3JJbnN0YW50QmVoYXZpb3IgPSAoZGVsYXkgPSAxMDApID0+IHtcbiAgICByZXR1cm4gKGNiOiBGdW5jdGlvbiwgW3ZhbF0sIFtzaWddKSA9PiB7IGxldCB0bSA9IHRyaWdnZXJXaXRoRGVsYXkodmFsLCBjYiwgZGVsYXkpOyBzaWc/LmFkZEV2ZW50TGlzdGVuZXI/LihcImFib3J0XCIsICgpPT57IGlmICh0bSkgY2xlYXJUaW1lb3V0KHRtKTsgfSwgeyBvbmNlOiB0cnVlIH0pOyBpZiAoIXRtKSB7IGNiPy4oKTsgfTsgfTtcbn1cblxuXG5cbi8vXG5leHBvcnQgY29uc3Qgb2JzZXJ2ZSA9IDxUID0gYW55Pih0YXJnZXQ6IFQsIHN0YXRlTmFtZT86IHN0cmluZyk6IG9ic2VydmVWYWxpZDxUPiA9PiB7XG4gICAgaWYgKHRhcmdldCA9PSBudWxsIHx8IHR5cGVvZiB0YXJnZXQgPT0gXCJzeW1ib2xcIiB8fCAhKHR5cGVvZiB0YXJnZXQgPT0gXCJvYmplY3RcIiB8fCB0eXBlb2YgdGFyZ2V0ID09IFwiZnVuY3Rpb25cIikgfHwgJGlzT2JzZXJ2YWJsZSh0YXJnZXQpKSB7XG4gICAgICAgIHJldHVybiB0YXJnZXQgYXMgb2JzZXJ2ZVZhbGlkPFQ+O1xuICAgIH1cblxuICAgIC8vXG4gICAgaWYgKCh0YXJnZXQgPSBkZXJlZj8uKHRhcmdldCkpID09IG51bGwgfHwgdGFyZ2V0IGluc3RhbmNlb2YgUHJvbWlzZSB8fCB0YXJnZXQgaW5zdGFuY2VvZiBXZWFrUmVmIHx8ICRpc09ic2VydmFibGUodGFyZ2V0KSkge1xuICAgICAgICByZXR1cm4gdGFyZ2V0IGFzIG9ic2VydmVWYWxpZDxUPjsgLy8gcHJvbWlzZSBmb3JiaWRkZW5cbiAgICB9XG5cbiAgICAvL1xuICAgIGNvbnN0IHVud3JhcDogYW55ID0gdGFyZ2V0O1xuICAgIGlmICh1bndyYXAgPT0gbnVsbCB8fFxuICAgICAgICB0eXBlb2YgdW53cmFwID09IFwic3ltYm9sXCIgfHwgISh0eXBlb2YgdW53cmFwID09IFwib2JqZWN0XCIgfHwgdHlwZW9mIHVud3JhcCA9PSBcImZ1bmN0aW9uXCIpIHx8XG4gICAgICAgIHVud3JhcCBpbnN0YW5jZW9mIFByb21pc2UgfHwgdW53cmFwIGluc3RhbmNlb2YgV2Vha1JlZlxuICAgICkgeyByZXR1cm4gdW53cmFwIGFzIG9ic2VydmVWYWxpZDxUPjsgfTtcblxuICAgIC8vXG4gICAgbGV0IHJlYWN0aXZlID0gdW53cmFwO1xuICAgIGlmIChBcnJheS5pc0FycmF5KHVud3JhcCkpIHsgcmVhY3RpdmUgPSBvYnNlcnZlQXJyYXkodW53cmFwKTsgcmV0dXJuIHJlYWN0aXZlOyB9IGVsc2VcbiAgICBpZiAodW53cmFwIGluc3RhbmNlb2YgTWFwKSB7IHJlYWN0aXZlID0gb2JzZXJ2ZU1hcCh1bndyYXApOyByZXR1cm4gcmVhY3RpdmU7IH0gZWxzZVxuICAgIGlmICh1bndyYXAgaW5zdGFuY2VvZiBTZXQpIHsgcmVhY3RpdmUgPSBvYnNlcnZlU2V0KHVud3JhcCk7IHJldHVybiByZWFjdGl2ZTsgfSBlbHNlXG4gICAgaWYgKHR5cGVvZiB1bndyYXAgPT0gXCJmdW5jdGlvblwiIHx8IHR5cGVvZiB1bndyYXAgPT0gXCJvYmplY3RcIikgeyByZWFjdGl2ZSA9IG9ic2VydmVPYmplY3QodW53cmFwKTsgcmV0dXJuIHJlYWN0aXZlOyB9XG4gICAgcmV0dXJuIHJlYWN0aXZlO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGlzT2JzZXJ2YWJsZSA9ICh0YXJnZXQ6IGFueSkgPT4ge1xuICAgIGlmICh0eXBlb2YgSFRNTElucHV0RWxlbWVudCAhPSBcInVuZGVmaW5lZFwiICYmIHRhcmdldCBpbnN0YW5jZW9mIEhUTUxJbnB1dEVsZW1lbnQpIHsgcmV0dXJuIHRydWU7IH1cbiAgICByZXR1cm4gISEoKHR5cGVvZiB0YXJnZXQgPT0gXCJvYmplY3RcIiB8fCB0eXBlb2YgdGFyZ2V0ID09IFwiZnVuY3Rpb25cIikgJiYgdGFyZ2V0ICE9IG51bGwgJiYgKHRhcmdldD8uWyRleHRyYWN0S2V5JF0gfHwgdGFyZ2V0Py5bJGFmZmVjdGVkXSB8fCBzdWJzY3JpcHRSZWdpc3RyeT8uaGFzPy4odGFyZ2V0KSkpO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IHJlY292ZXJSZWFjdGl2ZSA9ICh0YXJnZXQ6IGFueSk6IGFueSA9PiB7XG4gICAgcmV0dXJuIGlzT2JzZXJ2YWJsZSh0YXJnZXQpID8gb2JzZXJ2ZSh0YXJnZXQpIDogbnVsbDtcbn1cbiJdfQ==
import { affected } from "./Mainline";
import { addToCallChain } from "../wrap/Utils";
import { observe, triggerWithDelay } from "./Primitives";
import { $promise, $value, $behavior, $trigger } from "../wrap/Symbol";
import { $avoidTrigger, $getValue, hasValue, isArrayInvalidKey, isKeyType, isNotEqual, isPrimitive, objectAssignNotEqual, tryParseByHint } from "fest/core";
//
export const conditionalIndex = (condList = []) => { return computed(condList, () => condList.findIndex(cb => cb?.()), "value"); }; // TODO: check
//
/*
export const conditionalRef = <Under = any>(cond: any, ifTrue: any, ifFalse: any, behavior?: any): refValid<Under> => {
    const cur = autoRef((cond?.value ?? cond) ? ifTrue : ifFalse, behavior);
    const usb = affected([cond, "value"], (val) => { if (cur != null && (typeof cur == "object" || typeof cur == "function")) cur.value = val ? ifTrue : ifFalse; });
    addToCallChain(cur, Symbol.dispose, usb); return cur;
}*/
//
export const conditionalRef = (cond, ifTrue, ifFalse, behavior) => {
    if (isPrimitive(cond))
        return cond ? ifTrue : ifFalse;
    //
    const getTrue = () => { return ifTrue; };
    const getFalse = () => { return ifFalse; };
    //
    const valueOf = (n) => {
        if (n != null) {
            cond.value = hasValue(n) ? n?.value : n;
        }
        ;
        const cnd = hasValue(cond) ? cond?.value : cond;
        return cnd ? getTrue() : getFalse();
    };
    // truly reflective
    const r = observe({
        [$value]: valueOf(),
        [$behavior]: behavior,
        [Symbol?.toStringTag]() { return String(valueOf() ?? this[$value] ?? "") || ""; },
        [Symbol?.toPrimitive](hint) { return tryParseByHint(valueOf() ?? this[$value], hint); },
        set value(v) { this[$value] = valueOf(v); },
        get value() { return (this[$value] = valueOf() ?? this[$value]); }
    });
    //
    const usb = affected([cond, "value"], (val) => { r?.[$trigger]?.(); });
    addToCallChain(r, Symbol.dispose, usb);
    return r;
};
// alias
export const conditional = conditionalRef;
//
// used for redirection properties
// !one-directional
export const remap = (sub, cb, dest) => {
    if (!dest)
        dest = observe({});
    const usb = affected(sub, (value, prop, old) => {
        const got = cb?.(value, prop, old);
        if (typeof got == "object") {
            objectAssignNotEqual(dest, got);
        }
        else if (isNotEqual(dest[prop], got))
            dest[prop] = got;
    });
    if (dest) {
        addToCallChain(dest, Symbol.dispose, usb);
    }
    ;
    return dest; // return reactive value
};
//
// !one-directional
export const unified = (...subs) => {
    const dest = observe({});
    subs?.forEach?.((sub) => affected(sub, (value, prop, _) => {
        if (isNotEqual(dest[prop], value)) {
            dest[prop] = value;
        }
        ;
    }));
    return dest;
};
//
export const observableBySet = (set) => {
    const obs = observe([]); // @ts-ignore
    // Initialize with existing set entries
    obs.push(...Array.from(set?.values?.() || [])); // @ts-ignore
    addToCallChain(obs, Symbol.dispose, affected(set, (value, _, old) => {
        if (isNotEqual(value, old)) {
            if (old == null && value != null) {
                obs.push(value);
            }
            else if (old != null && value == null) {
                const idx = obs.indexOf(old);
                if (idx >= 0)
                    obs.splice(idx, 1);
            }
            else {
                const idx = obs.indexOf(old);
                if (idx >= 0 && isNotEqual(obs[idx], value))
                    obs[idx] = value;
            }
        }
    }));
    return obs;
};
//
export const observableByMap = (map) => {
    const obs = observe([]); // @ts-ignore
    // Initialize with existing map entries
    const initialEntries = Array.from(map.entries());
    obs.push(...initialEntries);
    //
    addToCallChain(obs, Symbol.dispose, affected(map, (value, prop, old) => {
        if (isNotEqual(value, old) || (old == null && value != null) || (old != null && value == null)) {
            if (old != null && value == null) {
                // Map entry deleted (by name)
                let idx = obs.findIndex(([name, _]) => (name == prop));
                // alternative index search
                if (idx < 0)
                    idx = obs.findLastIndex(([_, val]) => (old === val));
                // remove entry
                if (idx >= 0)
                    obs.splice(idx, 1);
            }
            else {
                // Map entry added or updated (by name)
                let idx = obs.findIndex(([name, _]) => (name == prop));
                // alternative index search
                //if (idx < 0) idx = obs.findLastIndex(([_, val]) => (old === val));
                //
                if (idx >= 0 && idx < obs.length) {
                    // Entry exists - update if value changed
                    if (isNotEqual(obs[idx]?.[1], value)) {
                        //obs[idx][1] = value;
                        obs[idx] = [prop, value];
                    }
                }
                else {
                    // New entry - add to array
                    obs.push([prop, value]);
                }
            }
        }
    }));
    //
    return obs;
};
//
export const assignMap = new WeakMap();
export const assign = (a, b, prop = "value") => {
    const isACompute = typeof a?.[1] == "function" && a?.length == 2, isBCompute = typeof b?.[1] == "function" && b?.length == 2, cmpBFnc = isBCompute ? b?.[1] : null;
    const isAProp = (isKeyType(a?.[1]) || a?.[1] == Symbol.iterator) && a?.length == 2;
    let a_prop = (isAProp && !isACompute) ? a?.[1] : (Array.isArray(a) ? null : prop);
    if (!isAProp && !isACompute) {
        a = [a, a_prop];
    }
    ;
    if (isACompute) {
        a[1] = a_prop;
    }
    ;
    const isBProp = (isKeyType(b?.[1]) || b?.[1] == Symbol.iterator) && b?.length == 2;
    let b_prop = (isBProp && !isBCompute) ? b?.[1] : (Array.isArray(b) ? null : prop);
    if (!isBProp && !isBCompute) {
        b = [b, b_prop];
    }
    ;
    if (isBCompute) {
        b[1] = b_prop;
    }
    ;
    //
    if (a_prop == null || b_prop == null || isArrayInvalidKey(a_prop, a?.[0]) || isArrayInvalidKey(b_prop, b?.[0])) {
        return;
    }
    ;
    if (!((typeof b?.[0] == "object" || typeof b?.[0] == "function") && b?.[0] != null) && !Array.isArray(a[0])) {
        $avoidTrigger(b, () => { a[0][a_prop] = b?.[0]; });
        return () => { };
    }
    ;
    //
    const compute = (v, p) => {
        const a_tmp = aRef?.deref?.();
        const b_tmp = bRef?.deref?.();
        if (assignMap?.get?.(a_tmp)?.get?.(a_prop)?.bound == b_tmp) {
            let val = null;
            const cmpfx = assignMap?.get?.(a_tmp)?.get?.(a_prop)?.cmpfx;
            $avoidTrigger(b_tmp, () => {
                if (typeof cmpfx == "function") {
                    val = cmpfx?.($getValue(b_tmp) ?? v, p, null);
                }
                else {
                    val = b_tmp?.[p] ?? v;
                }
                ;
            });
            //
            const nv = $getValue(val);
            if (isNotEqual(a_tmp[a_prop], nv)) {
                $avoidTrigger(b_tmp, () => { a_tmp[a_prop] = nv; });
            }
            ;
        }
        else {
            const map = assignMap?.get?.(a_tmp);
            const store = map?.get?.(a_prop);
            store?.dispose?.();
        }
    };
    //
    const dispose = () => {
        const a_tmp = aRef?.deref?.();
        const map = assignMap?.get?.(a_tmp);
        const store = map?.get?.(a_prop);
        map?.delete?.(a_prop);
        store?.unsub?.();
    };
    //
    const bRef = b?.[0] != null && (typeof b?.[0] == "object" || typeof b?.[0] == "function") && !(b?.[0] instanceof WeakRef || typeof b?.[0]?.deref == "function") ? new WeakRef(b?.[0]) : b?.[0], aRef = a?.[0] != null && (typeof a?.[0] == "object" || typeof a?.[0] == "function") && !(a?.[0] instanceof WeakRef || typeof a?.[0]?.deref == "function") ? new WeakRef(a?.[0]) : a?.[0];
    //
    let store = { compute, dispose, cmpfx: cmpBFnc };
    //
    const a_tmp = aRef?.deref?.(), b_tmp = bRef?.deref?.();
    if (aRef instanceof WeakRef) {
        if (assignMap?.get?.(a_tmp)?.get?.(a_prop)?.bound != b_tmp) {
            assignMap?.get?.(a_tmp)?.delete?.(a_prop);
        }
        ;
        // @ts-ignore
        const map = assignMap?.getOrInsert?.(a_tmp, new Map());
        store = map?.getOrInsertComputed?.(a_prop, () => ({
            bound: b_tmp,
            cmpfx: cmpBFnc,
            unsub: null,
            compute,
            dispose,
        }));
        //
        store.unsub = affected(b, compute);
        store.cmpfx = cmpBFnc;
        addToCallChain(a_tmp, Symbol.dispose, store?.dispose);
        addToCallChain(b_tmp, Symbol.dispose, store?.dispose);
    }
    // normalization isn't allowed for arrays
    if (b_tmp && !Array.isArray(b_tmp)) {
        $avoidTrigger(a_tmp, () => {
            b_tmp[b_prop] ??= a_tmp?.[a_prop] ?? b_tmp[b_prop];
        });
    }
    //
    return store?.dispose;
};
//
export const link = (a, b, prop = "value") => {
    /*const isACompute = typeof a?.[1] == "function", isBCompute = typeof b?.[1] == "function";
    const isAProp = (isKeyType(a?.[1]) || a?.[1] == Symbol.iterator) && (a as [any, keyType])?.length == 2; let a_prop = (isAProp && !isACompute) ? a?.[1] : prop; if (!isAProp && !isACompute) { a = [a, a_prop]; }; if (isACompute) { a[1] = a_prop; };
    const isBProp = (isKeyType(b?.[1]) || b?.[1] == Symbol.iterator) && (b as [any, keyType])?.length == 2; let b_prop = (isBProp && !isBCompute) ? b?.[1] : prop; if (!isBProp && !isBCompute) { b = [b, b_prop]; }; if (isBCompute) { b[1] = b_prop; };
    const usub = [ assign(a, b, b_prop), assign(b, a, a_prop) ];*/
    const usub = [assign(a, b, prop), assign(b, a, prop)];
    return () => usub?.map?.((c) => c?.());
};
//
export const computed = (src, cb, behavior, prop = "value") => {
    const isACompute = typeof src?.[1] == "function" && src?.length == 2;
    const isAProp = (isKeyType(src?.[1]) || src?.[1] == Symbol.iterator) && src?.length == 2;
    let a_prop = (isAProp && !isACompute) ? src?.[1] : (Array.isArray(src) ? null : prop);
    if (!isAProp && !isACompute) {
        src = [(isAProp ? src?.[0] : src), a_prop];
    }
    ;
    if (isACompute) {
        src[1] = a_prop;
    }
    ;
    if (a_prop == null || isArrayInvalidKey(a_prop, src?.[0])) {
        return undefined;
    }
    //
    const cmp = (v) => {
        let oldValue = undefined;
        if (v != undefined) {
            oldValue = src[0][a_prop];
            src[0][a_prop] = v;
        }
        return cb?.(src?.[0]?.[a_prop], a_prop, oldValue);
    };
    //
    const isPromise = false;
    const initial = cmp();
    const rf = observe({
        [$promise]: isPromise ? initial : undefined,
        [$value]: initial,
        [$behavior]: behavior,
        [Symbol?.toStringTag]() { return String(cmp() ?? this[$value] ?? "") || ""; },
        [Symbol?.toPrimitive](hint) { return tryParseByHint(cmp() ?? this[$value], hint); },
        set value(v) { this[$value] = cmp(v); },
        get value() { return (this[$value] = cmp() ?? this[$value]); }
    });
    //
    const usb = affected([src?.[0] ?? src, a_prop ?? "value"], () => /*wr?.deref?.()*/ rf?.[$trigger]?.());
    //const usb = assign([rf, "value"], src, a_prop)
    addToCallChain(rf, Symbol.dispose, usb);
    return rf;
};
//
export const delayedSubscribe = (ref, cb, delay = 100) => {
    let tm; //= triggerWithDelay(ref, cb, delay);
    return affected([ref, "value"], (v) => {
        if (!v && tm) {
            clearTimeout(tm);
            tm = null;
        }
        else if (v && !tm) {
            tm = triggerWithDelay(ref, cb, delay) ?? tm;
        }
        ;
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXNzaWduZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJBc3NpZ25lZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxjQUFjLEVBQXdDLE1BQU0sZUFBZSxDQUFDO0FBQ3JGLE9BQU8sRUFBRSxPQUFPLEVBQWdCLGdCQUFnQixFQUFtQixNQUFNLGNBQWMsQ0FBQztBQUN4RixPQUFPLEVBQUUsUUFBUSxFQUFnQixNQUFNLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JGLE9BQU8sRUFBRSxhQUFhLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxvQkFBb0IsRUFBRSxjQUFjLEVBQXdCLE1BQU0sV0FBVyxDQUFDO0FBRWxMLEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxnQkFBZ0IsR0FBRyxDQUFjLFdBQWtCLEVBQUUsRUFBdUIsRUFBRSxHQUFHLE9BQU8sUUFBUSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBLENBQUMsY0FBYztBQUUxTCxFQUFFO0FBQ0Y7Ozs7O0dBS0c7QUFFSCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLENBQVUsSUFBUyxFQUFFLE1BQVcsRUFBRSxPQUFZLEVBQUUsUUFBYyxFQUFtQixFQUFFO0lBQzdHLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQztRQUFFLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUV0RCxFQUFFO0lBQ0YsTUFBTSxPQUFPLEdBQUcsR0FBRSxF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QUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUMzTSxNQUFNLE9BQU8sR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSyxDQUFvQixFQUFFLE1BQU0sSUFBSSxDQUFDLENBQUM7SUFBQyxJQUFJLE1BQU0sR0FBRyxDQUFDLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBZ0IsQ0FBQztJQUFDLENBQUM7SUFBQSxDQUFDO0lBQUMsSUFBSSxVQUFVLEVBQUUsQ0FBQztRQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUM7SUFBQyxDQUFDO0lBQUEsQ0FBQztJQUNoUyxNQUFNLE9BQU8sR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSyxDQUFvQixFQUFFLE1BQU0sSUFBSSxDQUFDLENBQUM7SUFBQyxJQUFJLE1BQU0sR0FBRyxDQUFDLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBZ0IsQ0FBQztJQUFDLENBQUM7SUFBQSxDQUFDO0lBQUMsSUFBSSxVQUFVLEVBQUUsQ0FBQztRQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUM7SUFBQyxDQUFDO0lBQUEsQ0FBQztJQUVoUyxFQUFFO0lBQ0YsSUFBSSxNQUFNLElBQUksSUFBSSxJQUFJLE1BQU0sSUFBSSxJQUFJLElBQUksaUJBQWlCLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksaUJBQWlCLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUFDLE9BQU87SUFBQyxDQUFDO0lBQUEsQ0FBQztJQUM1SCxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksUUFBUSxJQUFJLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUN2RyxDQUFDO1FBQUMsYUFBYSxDQUFDLENBQUMsRUFBRSxHQUFFLEVBQUUsR0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUFDLE9BQU8sR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQUMsQ0FBQztJQUFBLENBQUM7SUFFNUUsRUFBRTtJQUNGLE1B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QUFDLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFBQyxDQUFDO2FBQzFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7WUFBQyxFQUFFLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7UUFBQyxDQUFDO1FBQUEsQ0FBQztJQUN2RSxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFmZmVjdGVkIH0gZnJvbSBcIi4vTWFpbmxpbmVcIjtcbmltcG9ydCB7IGFkZFRvQ2FsbENoYWluLCBvYnNlcnZlVmFsaWQsIHN1YlZhbGlkLCB0eXBlIGtleVR5cGUgfSBmcm9tIFwiLi4vd3JhcC9VdGlsc1wiO1xuaW1wb3J0IHsgb2JzZXJ2ZSwgaXNPYnNlcnZhYmxlLCB0cmlnZ2VyV2l0aERlbGF5LCByZWNvdmVyUmVhY3RpdmUgfSBmcm9tIFwiLi9QcmltaXRpdmVzXCI7XG5pbXBvcnQgeyAkcHJvbWlzZSwgJHRyaWdnZXJMb2NrLCAkdmFsdWUsICRiZWhhdmlvciwgJHRyaWdnZXIgfSBmcm9tIFwiLi4vd3JhcC9TeW1ib2xcIjtcbmltcG9ydCB7ICRhdm9pZFRyaWdnZXIsICRnZXRWYWx1ZSwgaGFzVmFsdWUsIGlzQXJyYXlJbnZhbGlkS2V5LCBpc0tleVR5cGUsIGlzTm90RXF1YWwsIGlzUHJpbWl0aXZlLCBvYmplY3RBc3NpZ25Ob3RFcXVhbCwgdHJ5UGFyc2VCeUhpbnQsIGRlZmF1bHRCeVR5cGUsIGRlcmVmIH0gZnJvbSBcImZlc3QvY29yZVwiO1xuXG4vL1xuZXhwb3J0IGNvbnN0IGNvbmRpdGlvbmFsSW5kZXggPSA8VW5kZXIgPSBhbnk+KGNvbmRMaXN0OiBhbnlbXSA9IFtdKTogb2JzZXJ2ZVZhbGlkPFVuZGVyPiA9PiB7IHJldHVybiBjb21wdXRlZChjb25kTGlzdCwgKCkgPT4gY29uZExpc3QuZmluZEluZGV4KGNiID0+IGNiPy4oKSksIFwidmFsdWVcIik7IH0gLy8gVE9ETzogY2hlY2tcblxuLy9cbi8qXG5leHBvcnQgY29uc3QgY29uZGl0aW9uYWxSZWYgPSA8VW5kZXIgPSBhbnk+KGNvbmQ6IGFueSwgaWZUcnVlOiBhbnksIGlmRmFsc2U6IGFueSwgYmVoYXZpb3I/OiBhbnkpOiByZWZWYWxpZDxVbmRlcj4gPT4ge1xuICAgIGNvbnN0IGN1ciA9IGF1dG9SZWYoKGNvbmQ/LnZhbHVlID8/IGNvbmQpID8gaWZUcnVlIDogaWZGYWxzZSwgYmVoYXZpb3IpO1xuICAgIGNvbnN0IHVzYiA9IGFmZmVjdGVkKFtjb25kLCBcInZhbHVlXCJdLCAodmFsKSA9PiB7IGlmIChjdXIgIT0gbnVsbCAmJiAodHlwZW9mIGN1ciA9PSBcIm9iamVjdFwiIHx8IHR5cGVvZiBjdXIgPT0gXCJmdW5jdGlvblwiKSkgY3VyLnZhbHVlID0gdmFsID8gaWZUcnVlIDogaWZGYWxzZTsgfSk7XG4gICAgYWRkVG9DYWxsQ2hhaW4oY3VyLCBTeW1ib2wuZGlzcG9zZSwgdXNiKTsgcmV0dXJuIGN1cjtcbn0qL1xuXG4vL1xuZXhwb3J0IGNvbnN0IGNvbmRpdGlvbmFsUmVmID0gPFQgPSBhbnk+KGNvbmQ6IGFueSwgaWZUcnVlOiBhbnksIGlmRmFsc2U6IGFueSwgYmVoYXZpb3I/OiBhbnkpOiBvYnNlcnZlVmFsaWQ8VD4gPT4ge1xuICAgIGlmIChpc1ByaW1pdGl2ZShjb25kKSkgcmV0dXJuIGNvbmQgPyBpZlRydWUgOiBpZkZhbHNlO1xuXG4gICAgLy9cbiAgICBjb25zdCBnZXRUcnVlID0gKCk9PnsgcmV0dXJuIGlmVHJ1ZTsgfTtcbiAgICBjb25zdCBnZXRGYWxzZSA9ICgpPT57IHJldHVybiBpZkZhbHNlOyB9O1xuXG4gICAgLy9cbiAgICBjb25zdCB2YWx1ZU9mID0gKG4/OiBhbnkpPT57XG4gICAgICAgIGlmIChuICE9IG51bGwpIHsgY29uZC52YWx1ZSA9IGhhc1ZhbHVlKG4pID8gbj8udmFsdWUgOiBuOyB9O1xuICAgICAgICBjb25zdCBjbmQgPSBoYXNWYWx1ZShjb25kKSA/IGNvbmQ/LnZhbHVlIDogY29uZDtcbiAgICAgICAgcmV0dXJuIGNuZCA/IGdldFRydWUoKSA6IGdldEZhbHNlKCk7XG4gICAgfVxuXG4gICAgLy8gdHJ1bHkgcmVmbGVjdGl2ZVxuICAgIGNvbnN0IHIgPSBvYnNlcnZlKHtcbiAgICAgICAgWyR2YWx1ZV06IHZhbHVlT2YoKSxcbiAgICAgICAgWyRiZWhhdmlvcl06IGJlaGF2aW9yLFxuICAgICAgICBbU3ltYm9sPy50b1N0cmluZ1RhZ10oKSB7IHJldHVybiBTdHJpbmcodmFsdWVPZigpID8/IHRoaXNbJHZhbHVlXSA/PyBcIlwiKSB8fCBcIlwiOyB9LFxuICAgICAgICBbU3ltYm9sPy50b1ByaW1pdGl2ZV0oaGludDogYW55KSB7IHJldHVybiB0cnlQYXJzZUJ5SGludCh2YWx1ZU9mKCkgPz8gdGhpc1skdmFsdWVdLCBoaW50KTsgfSxcbiAgICAgICAgc2V0IHZhbHVlKHYpIHsgdGhpc1skdmFsdWVdID0gdmFsdWVPZih2KTsgfSxcbiAgICAgICAgZ2V0IHZhbHVlKCkgeyByZXR1cm4gKHRoaXNbJHZhbHVlXSA9IHZhbHVlT2YoKSA/PyB0aGlzWyR2YWx1ZV0pOyB9XG4gICAgfSk7XG5cbiAgICAvL1xuICAgIGNvbnN0IHVzYiA9IGFmZmVjdGVkKFtjb25kLCBcInZhbHVlXCJdLCAodmFsKT0+eyByPy5bJHRyaWdnZXJdPy4oKTsgfSk7XG4gICAgYWRkVG9DYWxsQ2hhaW4ociwgU3ltYm9sLmRpc3Bvc2UsIHVzYik7IHJldHVybiByIGFzIHVua25vd24gYXMgb2JzZXJ2ZVZhbGlkPFQ+O1xufVxuXG4vLyBhbGlhc1xuZXhwb3J0IGNvbnN0IGNvbmRpdGlvbmFsID0gY29uZGl0aW9uYWxSZWY7XG5cbi8vXG4vLyB1c2VkIGZvciByZWRpcmVjdGlvbiBwcm9wZXJ0aWVzXG4vLyAhb25lLWRpcmVjdGlvbmFsXG5leHBvcnQgY29uc3QgcmVtYXAgPSA8VCA9IGFueT4oc3ViOiBzdWJWYWxpZDxUPiwgY2I/OiBGdW5jdGlvbiB8IG51bGwsIGRlc3Q/OiBhbnkgfCBudWxsKSA9PiB7XG4gICAgaWYgKCFkZXN0KSBkZXN0ID0gb2JzZXJ2ZSh7fSkgYXMgYW55O1xuICAgIGNvbnN0IHVzYiA9IGFmZmVjdGVkKHN1YiwgKHZhbHVlLCBwcm9wLCBvbGQpID0+IHtcbiAgICAgICAgY29uc3QgZ290ID0gY2I/Lih2YWx1ZSwgcHJvcCwgb2xkKTtcbiAgICAgICAgaWYgKHR5cGVvZiBnb3QgPT0gXCJvYmplY3RcIikgeyBvYmplY3RBc3NpZ25Ob3RFcXVhbChkZXN0LCBnb3QpOyB9IGVsc2VcbiAgICAgICAgICAgIGlmIChpc05vdEVxdWFsKGRlc3RbcHJvcF0sIGdvdCkpIGRlc3RbcHJvcF0gPSBnb3Q7XG4gICAgfSk7XG4gICAgaWYgKGRlc3QpIHsgYWRkVG9DYWxsQ2hhaW4oZGVzdCwgU3ltYm9sLmRpc3Bvc2UsIHVzYik7IH07IHJldHVybiBkZXN0OyAvLyByZXR1cm4gcmVhY3RpdmUgdmFsdWVcbn1cblxuLy9cbi8vICFvbmUtZGlyZWN0aW9uYWxcbmV4cG9ydCBjb25zdCB1bmlmaWVkID0gPFVuZGVyID0gYW55PiguLi5zdWJzOiBzdWJWYWxpZDxVbmRlcj5bXSkgPT4ge1xuICAgIGNvbnN0IGRlc3QgPSBvYnNlcnZlKHt9KTtcbiAgICBzdWJzPy5mb3JFYWNoPy4oKHN1YikgPT4gYWZmZWN0ZWQoc3ViLCAodmFsdWUsIHByb3AsIF8pID0+IHtcbiAgICAgICAgaWYgKGlzTm90RXF1YWwoZGVzdFtwcm9wXSwgdmFsdWUpKSB7IGRlc3RbcHJvcF0gPSB2YWx1ZTsgfTtcbiAgICB9KSk7IHJldHVybiBkZXN0O1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IG9ic2VydmFibGVCeVNldCA9IDxUID0gYW55PihzZXQ6IFNldDxUPik6IG9ic2VydmVWYWxpZDxUW10+ID0+IHsgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IG9iczogVFtdID0gb2JzZXJ2ZTxUW10+KFtdKSBhcyBvYnNlcnZlVmFsaWQ8VFtdPjsgLy8gQHRzLWlnbm9yZVxuICAgIC8vIEluaXRpYWxpemUgd2l0aCBleGlzdGluZyBzZXQgZW50cmllc1xuICAgIG9icy5wdXNoKC4uLkFycmF5LmZyb20oc2V0Py52YWx1ZXM/LigpIHx8IFtdKSk7IC8vIEB0cy1pZ25vcmVcbiAgICBhZGRUb0NhbGxDaGFpbihvYnMsIFN5bWJvbC5kaXNwb3NlLCBhZmZlY3RlZChzZXQsICh2YWx1ZSwgXywgb2xkKSA9PiB7IC8vIEB0cy1pZ25vcmVcbiAgICAgICAgaWYgKGlzTm90RXF1YWwodmFsdWUsIG9sZCkpIHtcbiAgICAgICAgICAgIGlmIChvbGQgPT0gbnVsbCAmJiB2YWx1ZSAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgb2JzLnB1c2godmFsdWUpO1xuICAgICAgICAgICAgfSBlbHNlXG4gICAgICAgICAgICAgICAgaWYgKG9sZCAhPSBudWxsICYmIHZhbHVlID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaWR4ID0gb2JzLmluZGV4T2Yob2xkKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCA+PSAwKSBvYnMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaWR4ID0gb2JzLmluZGV4T2Yob2xkKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCA+PSAwICYmIGlzTm90RXF1YWwob2JzW2lkeF0sIHZhbHVlKSkgb2JzW2lkeF0gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KSk7XG4gICAgcmV0dXJuIG9icztcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBvYnNlcnZhYmxlQnlNYXAgPSA8VCA9IGFueT4obWFwOiBNYXA8YW55LCBUPik6IG9ic2VydmVWYWxpZDxbYW55LCBUXVtdPiA9PiB7IC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCBvYnM6IFthbnksIFRdW10gPSBvYnNlcnZlPFthbnksIFRdW10+KFtdKSBhcyBvYnNlcnZlVmFsaWQ8W2FueSwgVF1bXT47IC8vIEB0cy1pZ25vcmVcblxuICAgIC8vIEluaXRpYWxpemUgd2l0aCBleGlzdGluZyBtYXAgZW50cmllc1xuICAgIGNvbnN0IGluaXRpYWxFbnRyaWVzOiBbYW55LCBUXVtdID0gQXJyYXkuZnJvbShtYXAuZW50cmllcygpKTtcbiAgICBvYnMucHVzaCguLi5pbml0aWFsRW50cmllcyk7XG5cbiAgICAvL1xuICAgIGFkZFRvQ2FsbENoYWluKG9icywgU3ltYm9sLmRpc3Bvc2UsIGFmZmVjdGVkKG1hcCwgKHZhbHVlLCBwcm9wLCBvbGQpID0+IHtcbiAgICAgICAgaWYgKGlzTm90RXF1YWwodmFsdWUsIG9sZCkgfHwgKG9sZCA9PSBudWxsICYmIHZhbHVlICE9IG51bGwpIHx8IChvbGQgIT0gbnVsbCAmJiB2YWx1ZSA9PSBudWxsKSkge1xuICAgICAgICAgICAgaWYgKG9sZCAhPSBudWxsICYmIHZhbHVlID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAvLyBNYXAgZW50cnkgZGVsZXRlZCAoYnkgbmFtZSlcbiAgICAgICAgICAgICAgICBsZXQgaWR4ID0gb2JzLmZpbmRJbmRleCgoW25hbWUsIF9dKSA9PiAobmFtZSA9PSBwcm9wKSk7XG5cbiAgICAgICAgICAgICAgICAvLyBhbHRlcm5hdGl2ZSBpbmRleCBzZWFyY2hcbiAgICAgICAgICAgICAgICBpZiAoaWR4IDwgMCkgaWR4ID0gb2JzLmZpbmRMYXN0SW5kZXgoKFtfLCB2YWxdKSA9PiAob2xkID09PSB2YWwpKTtcblxuICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBlbnRyeVxuICAgICAgICAgICAgICAgIGlmIChpZHggPj0gMCkgb2JzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBNYXAgZW50cnkgYWRkZWQgb3IgdXBkYXRlZCAoYnkgbmFtZSlcbiAgICAgICAgICAgICAgICBsZXQgaWR4ID0gb2JzLmZpbmRJbmRleCgoW25hbWUsIF9dKSA9PiAobmFtZSA9PSBwcm9wKSk7XG5cbiAgICAgICAgICAgICAgICAvLyBhbHRlcm5hdGl2ZSBpbmRleCBzZWFyY2hcbiAgICAgICAgICAgICAgICAvL2lmIChpZHggPCAwKSBpZHggPSBvYnMuZmluZExhc3RJbmRleCgoW18sIHZhbF0pID0+IChvbGQgPT09IHZhbCkpO1xuXG4gICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICBpZiAoaWR4ID49IDAgJiYgaWR4IDwgb2JzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBFbnRyeSBleGlzdHMgLSB1cGRhdGUgaWYgdmFsdWUgY2hhbmdlZFxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNOb3RFcXVhbChvYnNbaWR4XT8uWzFdLCB2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vb2JzW2lkeF1bMV0gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic1tpZHhdID0gW3Byb3AsIHZhbHVlXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIE5ldyBlbnRyeSAtIGFkZCB0byBhcnJheVxuICAgICAgICAgICAgICAgICAgICBvYnMucHVzaChbcHJvcCwgdmFsdWVdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KSk7XG5cbiAgICAvL1xuICAgIHJldHVybiBvYnM7XG59XG5cbi8vXG5leHBvcnQgaW50ZXJmYWNlIFByb3BTdG9yZSB7XG4gICAgdW5zdWI/OiBhbnk7XG4gICAgYm91bmQ/OiBhbnk7XG4gICAgY21wZng/OiBhbnk7XG4gICAgY29tcHV0ZT86IGFueTtcbiAgICBkaXNwb3NlPzogYW55O1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGFzc2lnbk1hcCA9IG5ldyBXZWFrTWFwPGFueSwgTWFwPGFueSwgUHJvcFN0b3JlPj4oKTtcbmV4cG9ydCBjb25zdCBhc3NpZ24gPSA8VCA9IGFueT4oYTogc3ViVmFsaWQ8VD4sIGI6IHN1YlZhbGlkPFQ+LCBwcm9wOiBrZXlUeXBlIHwgbnVsbCA9IFwidmFsdWVcIikgPT4ge1xuICAgIGNvbnN0IGlzQUNvbXB1dGUgPSB0eXBlb2YgYT8uWzFdID09IFwiZnVuY3Rpb25cIiAmJiAoYSBhcyBbYW55LCBrZXlUeXBlXSk/Lmxlbmd0aCA9PSAyLCBpc0JDb21wdXRlID0gdHlwZW9mIGI/LlsxXSA9PSBcImZ1bmN0aW9uXCIgJiYgKGIgYXMgW2FueSwga2V5VHlwZV0pPy5sZW5ndGggPT0gMiwgY21wQkZuYyA9IGlzQkNvbXB1dGUgPyBiPy5bMV0gOiBudWxsO1xuICAgIGNvbnN0IGlzQVByb3AgPSAoaXNLZXlUeXBlKGE/LlsxXSkgfHwgYT8uWzFdID09IFN5bWJvbC5pdGVyYXRvcikgJiYgKGEgYXMgW2FueSwga2V5VHlwZV0pPy5sZW5ndGggPT0gMjsgbGV0IGFfcHJvcCA9IChpc0FQcm9wICYmICFpc0FDb21wdXRlKSA/IGE/LlsxXSA6IChBcnJheS5pc0FycmF5KGEpID8gbnVsbCA6IHByb3ApOyBpZiAoIWlzQVByb3AgJiYgIWlzQUNvbXB1dGUpIHsgYSA9IFthLCBhX3Byb3BdIGFzIHN1YlZhbGlkPFQ+OyB9OyBpZiAoaXNBQ29tcHV0ZSkgeyBhWzFdID0gYV9wcm9wOyB9O1xuICAgIGNvbnN0IGlzQlByb3AgPSAoaXNLZXlUeXBlKGI/LlsxXSkgfHwgYj8uWzFdID09IFN5bWJvbC5pdGVyYXRvcikgJiYgKGIgYXMgW2FueSwga2V5VHlwZV0pPy5sZW5ndGggPT0gMjsgbGV0IGJfcHJvcCA9IChpc0JQcm9wICYmICFpc0JDb21wdXRlKSA/IGI/LlsxXSA6IChBcnJheS5pc0FycmF5KGIpID8gbnVsbCA6IHByb3ApOyBpZiAoIWlzQlByb3AgJiYgIWlzQkNvbXB1dGUpIHsgYiA9IFtiLCBiX3Byb3BdIGFzIHN1YlZhbGlkPFQ+OyB9OyBpZiAoaXNCQ29tcHV0ZSkgeyBiWzFdID0gYl9wcm9wOyB9O1xuXG4gICAgLy9cbiAgICBpZiAoYV9wcm9wID09IG51bGwgfHwgYl9wcm9wID09IG51bGwgfHwgaXNBcnJheUludmFsaWRLZXkoYV9wcm9wLCBhPy5bMF0pIHx8IGlzQXJyYXlJbnZhbGlkS2V5KGJfcHJvcCwgYj8uWzBdKSkgeyByZXR1cm47IH07XG4gICAgaWYgKCEoKHR5cGVvZiBiPy5bMF0gPT0gXCJvYmplY3RcIiB8fCB0eXBlb2YgYj8uWzBdID09IFwiZnVuY3Rpb25cIikgJiYgYj8uWzBdICE9IG51bGwpICYmICFBcnJheS5pc0FycmF5KGFbMF0pKVxuICAgICAgICB7ICRhdm9pZFRyaWdnZXIoYiwgKCk9PnsgYVswXVthX3Byb3BdID0gYj8uWzBdOyB9KTsgcmV0dXJuICgpID0+IHsgfTsgfTtcblxuICAgIC8vXG4gICAgY29uc3QgY29tcHV0ZSA9ICh2LCBwKSA9PiB7XG4gICAgICAgIGNvbnN0IGFfdG1wID0gYVJlZj8uZGVyZWY/LigpO1xuICAgICAgICBjb25zdCBiX3RtcCA9IGJSZWY/LmRlcmVmPy4oKTtcbiAgICAgICAgaWYgKGFzc2lnbk1hcD8uZ2V0Py4oYV90bXApPy5nZXQ/LihhX3Byb3ApPy5ib3VuZCA9PSBiX3RtcCkge1xuICAgICAgICAgICAgbGV0IHZhbDogYW55ID0gbnVsbDtcbiAgICAgICAgICAgIGNvbnN0IGNtcGZ4ID0gYXNzaWduTWFwPy5nZXQ/LihhX3RtcCk/LmdldD8uKGFfcHJvcCk/LmNtcGZ4O1xuICAgICAgICAgICAgJGF2b2lkVHJpZ2dlcihiX3RtcCwgKCk9PntcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNtcGZ4ID09IFwiZnVuY3Rpb25cIikgeyB2YWwgPSBjbXBmeD8uKCRnZXRWYWx1ZShiX3RtcCkgPz8gdiwgcCwgbnVsbCk7IH0gZWxzZSB7IHZhbCA9IGJfdG1wPy5bcF0gPz8gdjsgfTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgY29uc3QgbnYgPSAkZ2V0VmFsdWUodmFsKTtcbiAgICAgICAgICAgIGlmIChpc05vdEVxdWFsKGFfdG1wW2FfcHJvcF0sIG52KSkge1xuICAgICAgICAgICAgICAgICRhdm9pZFRyaWdnZXIoYl90bXAsICgpPT57IGFfdG1wW2FfcHJvcF0gPSBudjsgfSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgbWFwID0gYXNzaWduTWFwPy5nZXQ/LihhX3RtcCk7XG4gICAgICAgICAgICBjb25zdCBzdG9yZSA9IG1hcD8uZ2V0Py4oYV9wcm9wKTtcbiAgICAgICAgICAgIHN0b3JlPy5kaXNwb3NlPy4oKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICAvL1xuICAgIGNvbnN0IGRpc3Bvc2UgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGFfdG1wID0gYVJlZj8uZGVyZWY/LigpO1xuICAgICAgICBjb25zdCBtYXAgPSBhc3NpZ25NYXA/LmdldD8uKGFfdG1wKTtcbiAgICAgICAgY29uc3Qgc3RvcmUgPSBtYXA/LmdldD8uKGFfcHJvcCk7XG4gICAgICAgIG1hcD8uZGVsZXRlPy4oYV9wcm9wKTtcbiAgICAgICAgc3RvcmU/LnVuc3ViPy4oKTtcbiAgICB9O1xuXG4gICAgLy9cbiAgICBjb25zdFxuICAgICAgICBiUmVmID0gYj8uWzBdICE9IG51bGwgJiYgKHR5cGVvZiBiPy5bMF0gPT0gXCJvYmplY3RcIiB8fCB0eXBlb2YgYj8uWzBdID09IFwiZnVuY3Rpb25cIikgJiYgIShiPy5bMF0gaW5zdGFuY2VvZiBXZWFrUmVmIHx8IHR5cGVvZiBiPy5bMF0/LmRlcmVmID09IFwiZnVuY3Rpb25cIikgPyBuZXcgV2Vha1JlZihiPy5bMF0pIDogYj8uWzBdLFxuICAgICAgICBhUmVmID0gYT8uWzBdICE9IG51bGwgJiYgKHR5cGVvZiBhPy5bMF0gPT0gXCJvYmplY3RcIiB8fCB0eXBlb2YgYT8uWzBdID09IFwiZnVuY3Rpb25cIikgJiYgIShhPy5bMF0gaW5zdGFuY2VvZiBXZWFrUmVmIHx8IHR5cGVvZiBhPy5bMF0/LmRlcmVmID09IFwiZnVuY3Rpb25cIikgPyBuZXcgV2Vha1JlZihhPy5bMF0pIDogYT8uWzBdO1xuXG4gICAgLy9cbiAgICBsZXQgc3RvcmU6IFByb3BTdG9yZSA9IHsgY29tcHV0ZSwgZGlzcG9zZSwgY21wZng6IGNtcEJGbmMgfTtcblxuICAgIC8vXG4gICAgY29uc3QgYV90bXAgPSBhUmVmPy5kZXJlZj8uKCksIGJfdG1wID0gYlJlZj8uZGVyZWY/LigpO1xuICAgIGlmIChhUmVmIGluc3RhbmNlb2YgV2Vha1JlZikge1xuICAgICAgICBpZiAoYXNzaWduTWFwPy5nZXQ/LihhX3RtcCk/LmdldD8uKGFfcHJvcCk/LmJvdW5kICE9IGJfdG1wKSB7XG4gICAgICAgICAgICBhc3NpZ25NYXA/LmdldD8uKGFfdG1wKT8uZGVsZXRlPy4oYV9wcm9wKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0IG1hcCA9IGFzc2lnbk1hcD8uZ2V0T3JJbnNlcnQ/LihhX3RtcCwgbmV3IE1hcCgpKTtcbiAgICAgICAgc3RvcmUgPSBtYXA/LmdldE9ySW5zZXJ0Q29tcHV0ZWQ/LihhX3Byb3AsICgpID0+ICh7XG4gICAgICAgICAgICBib3VuZDogYl90bXAsXG4gICAgICAgICAgICBjbXBmeDogY21wQkZuYyxcbiAgICAgICAgICAgIHVuc3ViOiBudWxsLFxuICAgICAgICAgICAgY29tcHV0ZSxcbiAgICAgICAgICAgIGRpc3Bvc2UsXG4gICAgICAgIH0pKTtcblxuICAgICAgICAvL1xuICAgICAgICBzdG9yZS51bnN1YiA9IGFmZmVjdGVkKGIsIGNvbXB1dGUpO1xuICAgICAgICBzdG9yZS5jbXBmeCA9IGNtcEJGbmM7XG4gICAgICAgIGFkZFRvQ2FsbENoYWluKGFfdG1wLCBTeW1ib2wuZGlzcG9zZSwgc3RvcmU/LmRpc3Bvc2UpO1xuICAgICAgICBhZGRUb0NhbGxDaGFpbihiX3RtcCwgU3ltYm9sLmRpc3Bvc2UsIHN0b3JlPy5kaXNwb3NlKTtcbiAgICB9XG5cbiAgICAvLyBub3JtYWxpemF0aW9uIGlzbid0IGFsbG93ZWQgZm9yIGFycmF5c1xuICAgIGlmIChiX3RtcCAmJiAhQXJyYXkuaXNBcnJheShiX3RtcCkpIHtcbiAgICAgICAgJGF2b2lkVHJpZ2dlcihhX3RtcCwgKCk9PntcbiAgICAgICAgICAgIGJfdG1wW2JfcHJvcF0gPz89IGFfdG1wPy5bYV9wcm9wXSA/PyBiX3RtcFtiX3Byb3BdO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvL1xuICAgIHJldHVybiBzdG9yZT8uZGlzcG9zZTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBsaW5rID0gPFQgPSBhbnk+KGE6IHN1YlZhbGlkPFQ+LCBiOiBzdWJWYWxpZDxUPiwgcHJvcDoga2V5VHlwZSB8IG51bGwgPSBcInZhbHVlXCIpID0+IHtcbiAgICAvKmNvbnN0IGlzQUNvbXB1dGUgPSB0eXBlb2YgYT8uWzFdID09IFwiZnVuY3Rpb25cIiwgaXNCQ29tcHV0ZSA9IHR5cGVvZiBiPy5bMV0gPT0gXCJmdW5jdGlvblwiO1xuICAgIGNvbnN0IGlzQVByb3AgPSAoaXNLZXlUeXBlKGE/LlsxXSkgfHwgYT8uWzFdID09IFN5bWJvbC5pdGVyYXRvcikgJiYgKGEgYXMgW2FueSwga2V5VHlwZV0pPy5sZW5ndGggPT0gMjsgbGV0IGFfcHJvcCA9IChpc0FQcm9wICYmICFpc0FDb21wdXRlKSA/IGE/LlsxXSA6IHByb3A7IGlmICghaXNBUHJvcCAmJiAhaXNBQ29tcHV0ZSkgeyBhID0gW2EsIGFfcHJvcF07IH07IGlmIChpc0FDb21wdXRlKSB7IGFbMV0gPSBhX3Byb3A7IH07XG4gICAgY29uc3QgaXNCUHJvcCA9IChpc0tleVR5cGUoYj8uWzFdKSB8fCBiPy5bMV0gPT0gU3ltYm9sLml0ZXJhdG9yKSAmJiAoYiBhcyBbYW55LCBrZXlUeXBlXSk/Lmxlbmd0aCA9PSAyOyBsZXQgYl9wcm9wID0gKGlzQlByb3AgJiYgIWlzQkNvbXB1dGUpID8gYj8uWzFdIDogcHJvcDsgaWYgKCFpc0JQcm9wICYmICFpc0JDb21wdXRlKSB7IGIgPSBbYiwgYl9wcm9wXTsgfTsgaWYgKGlzQkNvbXB1dGUpIHsgYlsxXSA9IGJfcHJvcDsgfTtcbiAgICBjb25zdCB1c3ViID0gWyBhc3NpZ24oYSwgYiwgYl9wcm9wKSwgYXNzaWduKGIsIGEsIGFfcHJvcCkgXTsqL1xuICAgIGNvbnN0IHVzdWIgPSBbYXNzaWduKGEsIGIsIHByb3ApLCBhc3NpZ24oYiwgYSwgcHJvcCldO1xuICAgIHJldHVybiAoKSA9PiB1c3ViPy5tYXA/LigoYykgPT4gYz8uKCkpO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGNvbXB1dGVkID0gPFQgPSBhbnksIE9UID0gVD4oc3JjOiBzdWJWYWxpZDxUPiwgY2I/OiBGdW5jdGlvbiB8IG51bGwsIGJlaGF2aW9yPzogYW55LCBwcm9wOiBrZXlUeXBlIHwgbnVsbCA9IFwidmFsdWVcIik6IG9ic2VydmVWYWxpZDxPVD4gPT4ge1xuICAgIGNvbnN0IGlzQUNvbXB1dGUgPSB0eXBlb2Ygc3JjPy5bMV0gPT0gXCJmdW5jdGlvblwiICYmIChzcmMgYXMgW2FueSwga2V5VHlwZV0pPy5sZW5ndGggPT0gMjtcbiAgICBjb25zdCBpc0FQcm9wID0gKGlzS2V5VHlwZShzcmM/LlsxXSkgfHwgc3JjPy5bMV0gPT0gU3ltYm9sLml0ZXJhdG9yKSAmJiAoc3JjIGFzIFthbnksIGtleVR5cGVdKT8ubGVuZ3RoID09IDI7XG4gICAgbGV0IGFfcHJvcCA9IChpc0FQcm9wICYmICFpc0FDb21wdXRlKSA/IHNyYz8uWzFdIDogKEFycmF5LmlzQXJyYXkoc3JjKSA/IG51bGwgOiBwcm9wKTtcbiAgICBpZiAoIWlzQVByb3AgJiYgIWlzQUNvbXB1dGUpIHsgc3JjID0gWyhpc0FQcm9wID8gc3JjPy5bMF0gOiBzcmMpLCBhX3Byb3BdIGFzIHN1YlZhbGlkPFQ+OyB9OyBpZiAoaXNBQ29tcHV0ZSkgeyBzcmNbMV0gPSBhX3Byb3A7IH07XG4gICAgaWYgKGFfcHJvcCA9PSBudWxsIHx8IGlzQXJyYXlJbnZhbGlkS2V5KGFfcHJvcCwgc3JjPy5bMF0pKSB7IHJldHVybiB1bmRlZmluZWQgYXMgYW55OyB9XG5cbiAgICAvL1xuICAgIGNvbnN0IGNtcCA9ICh2PzogYW55KT0+e1xuICAgICAgICBsZXQgb2xkVmFsdWU6IGFueSA9IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKHYgIT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBvbGRWYWx1ZSA9IHNyY1swXVthX3Byb3BdO1xuICAgICAgICAgICAgc3JjWzBdW2FfcHJvcF0gPSB2O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjYj8uKHNyYz8uWzBdPy5bYV9wcm9wXSwgYV9wcm9wLCBvbGRWYWx1ZSk7XG4gICAgfTtcblxuICAgIC8vXG4gICAgY29uc3QgaXNQcm9taXNlID0gZmFsc2U7IGNvbnN0IGluaXRpYWwgPSBjbXAoKTtcbiAgICBjb25zdCByZjogYW55ID0gb2JzZXJ2ZSh7XG4gICAgICAgIFskcHJvbWlzZV06IGlzUHJvbWlzZSA/IGluaXRpYWwgOiB1bmRlZmluZWQsXG4gICAgICAgIFskdmFsdWVdOiBpbml0aWFsLFxuICAgICAgICBbJGJlaGF2aW9yXTogYmVoYXZpb3IsXG4gICAgICAgIFtTeW1ib2w/LnRvU3RyaW5nVGFnXSgpIHsgcmV0dXJuIFN0cmluZyhjbXAoKSA/PyB0aGlzWyR2YWx1ZV0gPz8gXCJcIikgfHwgXCJcIjsgfSxcbiAgICAgICAgW1N5bWJvbD8udG9QcmltaXRpdmVdKGhpbnQ6IGFueSkgeyByZXR1cm4gdHJ5UGFyc2VCeUhpbnQoY21wKCkgPz8gdGhpc1skdmFsdWVdLCBoaW50KTsgfSxcbiAgICAgICAgc2V0IHZhbHVlKHYpIHsgdGhpc1skdmFsdWVdID0gY21wKHYpOyB9LFxuICAgICAgICBnZXQgdmFsdWUoKSB7IHJldHVybiAodGhpc1skdmFsdWVdID0gY21wKCkgPz8gdGhpc1skdmFsdWVdKTsgfVxuICAgIH0pO1xuXG4gICAgLy9cbiAgICBjb25zdCB1c2IgPSBhZmZlY3RlZChbc3JjPy5bMF0gPz8gc3JjLCBhX3Byb3AgPz8gXCJ2YWx1ZVwiXSwgKCk9Pi8qd3I/LmRlcmVmPy4oKSovcmY/LlskdHJpZ2dlcl0/LigpKVxuICAgIC8vY29uc3QgdXNiID0gYXNzaWduKFtyZiwgXCJ2YWx1ZVwiXSwgc3JjLCBhX3Byb3ApXG4gICAgYWRkVG9DYWxsQ2hhaW4ocmYsIFN5bWJvbC5kaXNwb3NlLCB1c2IpOyByZXR1cm4gcmY7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgZGVsYXllZFN1YnNjcmliZSA9IDxVbmRlciA9IGFueT4ocmVmOiBhbnksIGNiOiBGdW5jdGlvbiwgZGVsYXkgPSAxMDApOiBvYnNlcnZlVmFsaWQ8VW5kZXI+ID0+IHtcbiAgICBsZXQgdG06IGFueTsgLy89IHRyaWdnZXJXaXRoRGVsYXkocmVmLCBjYiwgZGVsYXkpO1xuICAgIHJldHVybiBhZmZlY3RlZChbcmVmLCBcInZhbHVlXCJdLCAodikgPT4ge1xuICAgICAgICBpZiAoIXYgJiYgdG0pIHsgY2xlYXJUaW1lb3V0KHRtKTsgdG0gPSBudWxsOyB9IGVsc2VcbiAgICAgICAgICAgIGlmICh2ICYmICF0bSkgeyB0bSA9IHRyaWdnZXJXaXRoRGVsYXkocmVmLCBjYiwgZGVsYXkpID8/IHRtOyB9O1xuICAgIH0pO1xufVxuIl19